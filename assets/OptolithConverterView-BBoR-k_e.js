import{d as bt,u as wt,r as k,c as x,o as ft,a as G,w as mt,b,e,t as n,f as i,n as R,g as D,h as O,i as gt,v as yt,F as X,j as Q,k as w}from"./index-D3-s_uyw.js";const $=1,M=10,Ct="optolith-converter",kt=1,g="recent-conversions",A="optolith-converter:recent";function xt(){return{status:"uninitialized",backend:"none"}}function V(s){return new Promise((t,a)=>{s.onsuccess=()=>t(s.result),s.onerror=()=>a(s.error??new Error("IndexedDB request failed"))})}async function St(){if(!("indexedDB"in window))throw new Error("IndexedDB is not available");return new Promise((s,t)=>{const a=indexedDB.open(Ct,kt);a.onupgradeneeded=()=>{const c=a.result;c.objectStoreNames.contains(g)||c.createObjectStore(g,{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})},a.onsuccess=()=>s(a.result),a.onerror=()=>t(a.error??new Error("Failed to open IndexedDB"))})}async function U(s){const c=s.transaction(g,"readonly").objectStore(g).index("createdAt"),h=[];return await new Promise((p,u)=>{const d=c.openCursor(null,"prev");d.onsuccess=()=>{const _=d.result;if(!_){p();return}const f=_.value;f.version===$&&h.push(f),_.continue()},d.onerror=()=>u(d.error??new Error("Failed to iterate IndexedDB cursor"))}),h}function j(s){return new Promise((t,a)=>{s.oncomplete=()=>t(),s.onerror=()=>a(s.error??new Error("IndexedDB transaction failed")),s.onabort=()=>a(s.error??new Error("IndexedDB transaction aborted"))})}async function Et(s,t){const a=s.transaction(g,"readwrite"),c=a.objectStore(g);await V(c.put(t)),await Dt(s,a),await j(a)}async function Dt(s,t){const a=t??s.transaction(g,"readwrite"),h=a.objectStore(g).index("createdAt");let p=0;await new Promise((u,d)=>{const _=h.openCursor(null,"prev");_.onsuccess=()=>{const f=_.result;if(!f){u();return}p+=1,p>M&&f.delete(),f.continue()},_.onerror=()=>d(_.error??new Error("Failed to trim IndexedDB cache entries"))}),t||await j(a)}async function It(s,t){const a=s.transaction(g,"readwrite"),c=a.objectStore(g);await V(c.delete(t)),await j(a)}async function $t(s){const t=s.transaction(g,"readwrite"),a=t.objectStore(g);await V(a.clear()),await j(t)}function Bt(s){const t=new Set,a=new Set,c=new Set,h=new Set,p=new Set,u=d=>{p.add(d)};return(s.exportedWarnings??[]).forEach(d=>{c.add(d),u(d)}),(s.parserWarnings??[]).forEach(d=>{const _=`[Parser] ${d.section??"general"}: ${d.message}`;t.add(_),u(_)}),(s.resolverWarnings??[]).forEach(d=>{const _=`[Resolver] ${d.section}: ${d.message}`;a.add(_),u(_)}),Object.entries(s.unresolved??{}).forEach(([d,_])=>{_.forEach(f=>{const m=`[Resolver] ${d}: ${f}`;h.add(m),u(m)})}),{total:p.size,parser:t.size,resolver:a.size,exporter:c.size,unresolved:h.size}}function At(s,t){const a=new Date().toISOString(),c=typeof crypto?.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,h=t.exported?.name?.trim()??"Unnamed conversion";return{id:c,createdAt:a,name:h,statBlock:s,payload:t,warningSummary:Bt(t),version:$}}function I(s){return s.filter(t=>t.version===$).map(t=>({id:t.id,createdAt:t.createdAt,name:t.name,statBlock:t.statBlock,payload:t.payload,warningSummary:t.warningSummary}))}function T(){try{const s=localStorage.getItem(A);if(!s)return[];const t=JSON.parse(s);return t.version!==$||!Array.isArray(t.entries)?(localStorage.removeItem(A),[]):t.entries}catch{return localStorage.removeItem(A),[]}}function F(s){const t={version:$,entries:s.slice(0,M)};localStorage.setItem(A,JSON.stringify(t))}class Lt extends EventTarget{state=xt();entries=[];backend="none";db=null;initializationPromise=null;async init(){if(this.state.status==="available"||this.initializationPromise)return this.initializationPromise??Promise.resolve();this.initializationPromise=this.performInitialization(),await this.initializationPromise}async performInitialization(){try{const t=await St();this.db=t,this.backend="indexedDB",this.entries=I(await U(t)),this.setState("available")}catch{try{const t=T();F(t),this.entries=I(t),this.backend="localStorage",this.setState("available")}catch{this.backend="none",this.entries=[],this.setState("disabled")}}finally{this.initializationPromise=null,this.emitChange()}}getState(){return{...this.state}}getEntries(){return this.entries.slice()}async save(t,a){if(this.state.status==="uninitialized"&&await this.init(),this.state.status!=="available")return;const c=At(t,a);if(this.backend==="indexedDB"&&this.db)await Et(this.db,{...c,version:$}),this.entries=I(await U(this.db));else if(this.backend==="localStorage"){const h=T(),p=[c,...h].slice(0,M);F(p),this.entries=I(p)}this.emitChange()}async remove(t){if(this.state.status==="available"){if(this.backend==="indexedDB"&&this.db)await It(this.db,t),this.entries=I(await U(this.db));else if(this.backend==="localStorage"){const a=T().filter(c=>c.id!==t);F(a),this.entries=I(a)}this.emitChange()}}async clear(){this.state.status==="available"&&(this.backend==="indexedDB"&&this.db?await $t(this.db):this.backend==="localStorage"&&localStorage.removeItem(A),this.entries=[],this.emitChange())}setState(t){this.state={status:t,backend:this.backend}}emitChange(){const t={entries:this.entries,state:this.state},a=new CustomEvent("change",{detail:t});this.dispatchEvent(a)}}const y=new Lt,Nt={class:"aventuria-section optolith-view"},Rt={class:"aventuria-section-header"},Ot={class:"aventuria-section-title"},jt={class:"aventuria-section-intro optolith-intro"},zt={class:"optolith-tabs",role:"tablist"},Wt=["aria-selected"],Pt=["aria-selected"],Ut={key:0,class:"optolith-panel"},Tt={class:"aventuria-card aventuria-card--table optolith-card"},Ft={class:"optolith-callout optolith-callout--accent",role:"note"},Mt={class:"optolith-roll20__link",href:"https://roll20.net",target:"_blank",rel:"noopener noreferrer"},Vt={class:"optolith-github__link",href:"https://github.com/thomaslazar/aventuria-impromptu/issues",target:"_blank",rel:"noopener noreferrer"},Jt={class:"optolith-usage"},Ht={class:"aventuria-card-title optolith-usage__title"},Kt={class:"optolith-usage__list"},qt={class:"optolith-field-group"},Gt={for:"stat-block-input",class:"optolith-label"},Xt=["placeholder"],Qt={class:"optolith-helper"},Yt={key:0,class:"optolith-inline-error"},Zt={class:"optolith-actions"},te=["disabled"],ee=["disabled"],oe=["disabled"],ne={key:0,class:"optolith-callout optolith-callout--info",role:"status"},se={key:1,class:"optolith-callout optolith-callout--danger",role:"alert"},ae={key:0,class:"aventuria-card aventuria-card--table optolith-result"},ie={class:"optolith-result__header"},re={class:"aventuria-card-title optolith-result__title"},le={class:"optolith-result__meta"},ce={class:"optolith-result__actions"},ue={key:0,class:"optolith-callout optolith-callout--warning",role:"alert"},de={class:"optolith-callout__title"},ve={class:"optolith-callout__list"},he={class:"optolith-details"},pe={class:"optolith-details",open:""},_e={key:1,class:"optolith-panel"},be={class:"aventuria-card aventuria-card--table optolith-history"},we={class:"optolith-history__header"},fe={class:"aventuria-card-title"},me=["disabled"],ge={key:0,class:"optolith-callout optolith-callout--warning",role:"alert"},ye={key:1,class:"optolith-history__empty"},Ce={key:2,class:"optolith-history__list"},ke=["aria-expanded","onClick"],xe={class:"optolith-history__toggle-name"},Se={class:"optolith-history__timestamp"},Ee=["title"],De={key:0,class:"optolith-history__panel"},Ie={class:"optolith-history__panel-actions"},$e=["disabled","onClick"],Be=["onClick"],Ae=["disabled","onClick"],Le={class:"optolith-history__panel-content"},Ne={class:"optolith-history__section"},Re={class:"optolith-history__section-title"},Oe={class:"optolith-history__pre"},je={class:"optolith-history__section"},ze={class:"optolith-history__section-title"},We={class:"optolith-history__pre"},Y=6e3,Pe=bt({__name:"OptolithConverterView",setup(s){const{t,locale:a}=wt(),c=k(""),h=k("idle"),p=k(null),u=k(null),d=k(null),_=`${window.location.origin}/aventuria-impromptu/`,f=k(y.getState()),m=k([]),B=k(!1),S=k("convert"),C=k(null),z=x(()=>c.value.length>Y),J=x(()=>h.value==="loading"||c.value.trim().length===0||z.value),Z=x(()=>f.value.status==="available"&&m.value.length>0),tt=x(()=>u.value?JSON.stringify(u.value.exported,null,2):""),et=x(()=>new Intl.DateTimeFormat(a.value,{dateStyle:"medium",timeStyle:"short"})),H=x(()=>m.value.map(o=>({id:o.id,name:o.name,createdAt:o.createdAt,formattedDate:et.value.format(new Date(o.createdAt)),statBlock:o.statBlock,json:JSON.stringify(o.payload.exported,null,2),warningSummary:o.warningSummary}))),L=x(()=>f.value.status==="available"&&!B.value),K=x(()=>L.value&&m.value.length>0),N=x(()=>{if(!u.value)return[];const o=new Set,r=v=>v.startsWith("[Parser] ")?`${t("views.optolithConverter.warnings.prefixes.parser")} ${v.slice(9)}`:v.startsWith("[Resolver] ")?`${t("views.optolithConverter.warnings.prefixes.resolver")} ${v.slice(10)}`:v.startsWith("[Exporter] ")?`${t("views.optolithConverter.warnings.prefixes.exporter")} ${v.slice(10)}`:v;return(u.value.exportedWarnings??[]).forEach(v=>o.add(r(v))),(u.value.parserWarnings??[]).forEach(v=>o.add(r(`[Parser] ${v.section??"general"}: ${v.message}`))),(u.value.resolverWarnings??[]).forEach(v=>o.add(r(`[Resolver] ${v.section}: ${v.message}`))),Object.entries(u.value.unresolved??{}).forEach(([v,E])=>{E.forEach(P=>o.add(r(`[Resolver] ${v}: ${P}`)))}),Array.from(o)});function ot(){if(d.value)return d.value;const o=new Worker(new URL("/aventuria-impromptu/assets/optolithConverter.worker-DkDQZop-.js",import.meta.url),{type:"module"});return o.addEventListener("message",nt),d.value=o,o}function nt(o){const r=o.data;if(r){if(r.type==="error"){h.value="error",p.value=r.error;return}h.value="success",p.value=null,u.value=r.payload,y.save(c.value,r.payload).catch(l=>console.error("Failed to persist cached conversion",l))}}function st(){if(J.value)return;h.value="loading",p.value=null,u.value=null,ot().postMessage({type:"convert",payload:{source:c.value,baseUrl:_}})}function W(o){o&&(c.value=o.statBlock,u.value={...o.payload,exportedWarnings:o.payload.exportedWarnings??[]},h.value="success",p.value=null)}function at(){W(m.value[0])}function q(o){return m.value.find(r=>r.id===o)}function it(o){C.value=C.value===o?null:o}function rt(o){const r=q(o);r&&(W(r),S.value="convert",C.value=null)}function lt(o){const r=q(o);if(!r)return;const l=new Blob([JSON.stringify(r.payload.exported,null,2)],{type:"application/json"}),v=URL.createObjectURL(l),E=document.createElement("a"),P=r.name.toLowerCase().replace(/[^a-z0-9-]+/g,"-");E.href=v,E.download=`${P||"npc"}-optolith.json`,document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(v)}async function ct(o){if(L.value){B.value=!0;try{await y.remove(o),C.value=null}catch(r){console.error("Failed to remove cached conversion",r)}finally{B.value=!1}}}async function ut(){if(K.value){B.value=!0;try{await y.clear(),C.value=null}catch(o){console.error("Failed to clear cached conversions",o)}finally{B.value=!1}}}function dt(o){return o.total===0?t("views.optolithConverter.recent.warnings.none"):o.total===1?t("views.optolithConverter.recent.warnings.single"):t("views.optolithConverter.recent.warnings.multiple",{count:o.total})}function vt(o){return t("views.optolithConverter.recent.warnings.breakdown",{parser:o.parser,resolver:o.resolver,exporter:o.exporter,unresolved:o.unresolved})}function ht(){if(!u.value)return;const o=new Blob([JSON.stringify(u.value.exported,null,2)],{type:"application/json"}),r=URL.createObjectURL(o),l=document.createElement("a"),v=u.value.exported.name.toLowerCase().replace(/[^a-z0-9-]+/g,"-");l.href=r,l.download=`${v||"npc"}-optolith.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(r)}async function pt(){if(N.value.length!==0)try{if(!navigator?.clipboard?.writeText)throw new Error("Clipboard API not available");await navigator.clipboard.writeText(N.value.join(`
`))}catch(o){console.error("Failed to copy warnings",o)}}function _t(){c.value="",h.value="idle",p.value=null,u.value=null}return ft(()=>{const o=r=>{const l=r.detail;f.value=l.state,m.value=l.entries};y.addEventListener("change",o),y.init().then(()=>{f.value=y.getState(),m.value=y.getEntries(),m.value.length>0&&W(m.value[0])}).catch(()=>{f.value=y.getState(),m.value=y.getEntries()}),G(()=>{y.removeEventListener("change",o)})}),mt(m,o=>{C.value&&!o.some(r=>r.id===C.value)&&(C.value=null)}),G(()=>{d.value&&(d.value.terminate(),d.value=null)}),(o,r)=>(w(),b("section",Nt,[e("header",Rt,[e("h1",Ot,n(i(t)("views.optolithConverter.title")),1),e("p",jt,n(i(t)("views.optolithConverter.intro")),1)]),e("nav",zt,[e("button",{type:"button",role:"tab",class:R(["optolith-tabs__button",{"optolith-tabs__button--active":S.value==="convert"}]),"aria-selected":S.value==="convert",onClick:r[0]||(r[0]=l=>S.value="convert")},n(i(t)("views.optolithConverter.tabs.convert")),11,Wt),e("button",{type:"button",role:"tab",class:R(["optolith-tabs__button",{"optolith-tabs__button--active":S.value==="recent"}]),"aria-selected":S.value==="recent",onClick:r[1]||(r[1]=l=>S.value="recent")},n(i(t)("views.optolithConverter.tabs.recent")),11,Pt)]),S.value==="convert"?(w(),b("div",Ut,[e("article",Tt,[e("div",Ft,[e("span",null,[O(n(i(t)("views.optolithConverter.roll20Note.prefix"))+" ",1),e("a",Mt,n(i(t)("views.optolithConverter.roll20Note.linkText")),1),O(" "+n(i(t)("views.optolithConverter.roll20Note.suffix")),1)]),e("span",null,n(i(t)("views.optolithConverter.languageNote")),1),e("span",null,[O(n(i(t)("views.optolithConverter.bugReportNote.prefix"))+" ",1),e("a",Vt,n(i(t)("views.optolithConverter.bugReportNote.linkText")),1),O(" "+n(i(t)("views.optolithConverter.bugReportNote.suffix")),1)])]),e("section",Jt,[e("h2",Ht,n(i(t)("views.optolithConverter.usage.title")),1),e("ol",Kt,[e("li",null,n(i(t)("views.optolithConverter.usage.steps.paste")),1),e("li",null,n(i(t)("views.optolithConverter.usage.steps.convert")),1),e("li",null,n(i(t)("views.optolithConverter.usage.steps.review")),1),e("li",null,n(i(t)("views.optolithConverter.usage.steps.download")),1)])]),e("div",qt,[e("label",Gt,n(i(t)("views.optolithConverter.input.label")),1),gt(e("textarea",{id:"stat-block-input","onUpdate:modelValue":r[2]||(r[2]=l=>c.value=l),class:R(["optolith-textarea",{"is-invalid":z.value}]),rows:"14",placeholder:i(t)("views.optolithConverter.input.placeholder")},null,10,Xt),[[yt,c.value]]),e("div",Qt,n(i(t)("views.optolithConverter.input.help",{max:Y,current:c.value.length})),1),z.value?(w(),b("p",Yt,n(i(t)("views.optolithConverter.input.tooLong")),1)):D("",!0)]),e("div",Zt,[e("button",{type:"button",class:"aventuria-button",disabled:J.value,onClick:st},n(i(t)("views.optolithConverter.buttons.convert")),9,te),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:_t,disabled:h.value==="loading"},n(i(t)("views.optolithConverter.buttons.reset")),9,ee),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:at,disabled:!Z.value||h.value==="loading"},n(i(t)("views.optolithConverter.buttons.loadLast")),9,oe)]),h.value==="loading"?(w(),b("div",ne,n(i(t)("views.optolithConverter.loading")),1)):D("",!0),p.value?(w(),b("div",se,n(p.value),1)):D("",!0)]),u.value?(w(),b("article",ae,[e("header",ie,[e("div",null,[e("h2",re,n(u.value.exported.name),1),e("p",le,n(i(t)("views.optolithConverter.datasetInfo",{schema:u.value.manifest.schemaVersion,checksum:u.value.manifest.sourceChecksum.slice(0,12)})),1)]),e("div",ce,[e("button",{type:"button",class:"aventuria-button",onClick:ht},n(i(t)("views.optolithConverter.buttons.download")),1),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:pt},n(i(t)("views.optolithConverter.buttons.copyWarnings")),1)])]),N.value.length>0?(w(),b("div",ue,[e("h3",de,n(i(t)("views.optolithConverter.warnings.title")),1),e("ul",ve,[(w(!0),b(X,null,Q(N.value,l=>(w(),b("li",{key:l},n(l),1))),128))])])):D("",!0),e("details",he,[e("summary",null,n(i(t)("views.optolithConverter.normalizedHeading")),1),e("pre",null,n(u.value.normalizedSource),1)]),e("details",pe,[e("summary",null,n(i(t)("views.optolithConverter.jsonHeading")),1),e("pre",null,n(tt.value),1)])])):D("",!0)])):(w(),b("div",_e,[e("article",be,[e("header",we,[e("h2",fe,n(i(t)("views.optolithConverter.recent.title")),1),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!K.value,onClick:ut},n(i(t)("views.optolithConverter.recent.actions.clear")),9,me)]),f.value.status==="disabled"?(w(),b("div",ge,n(i(t)("views.optolithConverter.recent.disabled")),1)):H.value.length===0?(w(),b("div",ye,n(i(t)("views.optolithConverter.recent.empty")),1)):(w(),b("ul",Ce,[(w(!0),b(X,null,Q(H.value,l=>(w(),b("li",{key:l.id,class:"optolith-history__item"},[e("button",{type:"button",class:"optolith-history__toggle","aria-expanded":C.value===l.id,onClick:v=>it(l.id)},[e("span",xe,n(l.name),1),e("span",Se,n(i(t)("views.optolithConverter.recent.storedAt",{date:l.formattedDate})),1),e("span",{class:R(["optolith-history__warnings",{"optolith-history__warnings--has":l.warningSummary.total>0}]),title:vt(l.warningSummary)},n(dt(l.warningSummary)),11,Ee),r[3]||(r[3]=e("span",{class:"optolith-history__chevron","aria-hidden":"true"},null,-1))],8,ke),C.value===l.id?(w(),b("div",De,[e("div",Ie,[e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!L.value,onClick:v=>rt(l.id)},n(i(t)("views.optolithConverter.recent.actions.load")),9,$e),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:v=>lt(l.id)},n(i(t)("views.optolithConverter.recent.actions.download")),9,Be),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!L.value,onClick:v=>ct(l.id)},n(i(t)("views.optolithConverter.recent.actions.remove")),9,Ae)]),e("div",Le,[e("section",Ne,[e("h3",Re,n(i(t)("views.optolithConverter.recent.labels.statBlock")),1),e("pre",Oe,n(l.statBlock),1)]),e("section",je,[e("h3",ze,n(i(t)("views.optolithConverter.recent.labels.json")),1),e("pre",We,n(l.json),1)])])])):D("",!0)]))),128))]))])]))]))}}),Ue=(s,t)=>{const a=s.__vccOpts||s;for(const[c,h]of t)a[c]=h;return a},Fe=Ue(Pe,[["__scopeId","data-v-f2a63bd0"]]);export{Fe as default};
