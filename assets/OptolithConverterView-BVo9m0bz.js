import{d as gt,u as yt,r as k,c as x,o as Ct,a as Y,w as kt,b as f,e,t as n,f as a,n as N,g as D,h as B,i as xt,v as St,F as Q,j as Z,k as Et,l as m}from"./index-DNjokkgm.js";const $=2,M=10,Dt="optolith-converter",It=1,g="recent-conversions",z="optolith-converter:recent";function $t(){return{status:"uninitialized",backend:"none"}}function F(r){return new Promise((t,s)=>{r.onsuccess=()=>t(r.result),r.onerror=()=>s(r.error??new Error("IndexedDB request failed"))})}async function jt(){if(!("indexedDB"in window))throw new Error("IndexedDB is not available");return new Promise((r,t)=>{const s=indexedDB.open(Dt,It);s.onupgradeneeded=()=>{const c=s.result;c.objectStoreNames.contains(g)||c.createObjectStore(g,{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})},s.onsuccess=()=>r(s.result),s.onerror=()=>t(s.error??new Error("Failed to open IndexedDB"))})}async function J(r){const c=r.transaction(g,"readonly").objectStore(g).index("createdAt"),h=[];let p=!1;return await new Promise((u,v)=>{const _=c.openCursor(null,"prev");_.onsuccess=()=>{const w=_.result;if(!w){u();return}const b=w.value;b.version===$?h.push(b):p=!0,w.continue()},_.onerror=()=>v(_.error??new Error("Failed to iterate IndexedDB cursor"))}),{entries:h,hasLegacy:p}}function O(r){return new Promise((t,s)=>{r.oncomplete=()=>t(),r.onerror=()=>s(r.error??new Error("IndexedDB transaction failed")),r.onabort=()=>s(r.error??new Error("IndexedDB transaction aborted"))})}async function Bt(r,t){const s=r.transaction(g,"readwrite"),c=s.objectStore(g);await F(c.put(t)),await zt(r,s),await O(s)}async function zt(r,t){const s=t??r.transaction(g,"readwrite"),h=s.objectStore(g).index("createdAt");let p=0;await new Promise((u,v)=>{const _=h.openCursor(null,"prev");_.onsuccess=()=>{const w=_.result;if(!w){u();return}p+=1,p>M&&w.delete(),w.continue()},_.onerror=()=>v(_.error??new Error("Failed to trim IndexedDB cache entries"))}),t||await O(s)}async function Lt(r,t){const s=r.transaction(g,"readwrite"),c=s.objectStore(g);await F(c.delete(t)),await O(s)}async function tt(r){const t=r.transaction(g,"readwrite"),s=t.objectStore(g);await F(s.clear()),await O(t)}function Nt(r){const t=new Set,s=new Set,c=new Set,h=new Set,p=new Set,u=v=>{p.add(v)};return(r.exportedWarnings??[]).forEach(v=>{c.add(v),u(v)}),(r.parserWarnings??[]).forEach(v=>{const _=`[Parser] ${v.section??"general"}: ${v.message}`;t.add(_),u(_)}),(r.resolverWarnings??[]).forEach(v=>{const _=`[Resolver] ${v.section}: ${v.message}`;s.add(_),u(_)}),Object.entries(r.unresolved??{}).forEach(([v,_])=>{_.forEach(w=>{const b=`[Resolver] ${v}: ${w}`;h.add(b),u(b)})}),{total:p.size,parser:t.size,resolver:s.size,exporter:c.size,unresolved:h.size}}function Ot(r,t){const s=new Date().toISOString(),c=typeof crypto?.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,h=t.exported?.name?.trim()??"Unnamed conversion";return{id:c,createdAt:s,name:h,statBlock:r,payload:t,warningSummary:Nt(t),version:$}}function I(r){return r.filter(t=>t.version===$).map(t=>({id:t.id,createdAt:t.createdAt,name:t.name,statBlock:t.statBlock,payload:t.payload,warningSummary:t.warningSummary}))}function T(){try{const r=localStorage.getItem(z);if(!r)return[];const t=JSON.parse(r);return t.version!==$||!Array.isArray(t.entries)?(localStorage.removeItem(z),[]):t.entries}catch{return localStorage.removeItem(z),[]}}function V(r){const t={version:$,entries:r.slice(0,M)};localStorage.setItem(z,JSON.stringify(t))}class Rt extends EventTarget{state=$t();entries=[];backend="none";db=null;initializationPromise=null;async init(){if(this.state.status==="available"||this.initializationPromise)return this.initializationPromise??Promise.resolve();this.initializationPromise=this.performInitialization(),await this.initializationPromise}async performInitialization(){try{const t=await jt();this.db=t,this.backend="indexedDB";const{entries:s,hasLegacy:c}=await J(t);c?(await tt(t),this.entries=[]):this.entries=I(s),this.setState("available")}catch{try{const t=T();V(t),this.entries=I(t),this.backend="localStorage",this.setState("available")}catch{this.backend="none",this.entries=[],this.setState("disabled")}}finally{this.initializationPromise=null,this.emitChange()}}getState(){return{...this.state}}getEntries(){return this.entries.slice()}async save(t,s){if(this.state.status==="uninitialized"&&await this.init(),this.state.status!=="available")return;const c=Ot(t,s);if(this.backend==="indexedDB"&&this.db){await Bt(this.db,{...c,version:$});const{entries:h}=await J(this.db);this.entries=I(h)}else if(this.backend==="localStorage"){const h=T(),p=[c,...h].slice(0,M);V(p),this.entries=I(p)}this.emitChange()}async remove(t){if(this.state.status==="available"){if(this.backend==="indexedDB"&&this.db){await Lt(this.db,t);const{entries:s}=await J(this.db);this.entries=I(s)}else if(this.backend==="localStorage"){const s=T().filter(c=>c.id!==t);V(s),this.entries=I(s)}this.emitChange()}}async clear(){this.state.status==="available"&&(this.backend==="indexedDB"&&this.db?await tt(this.db):this.backend==="localStorage"&&localStorage.removeItem(z),this.entries=[],this.emitChange())}setState(t){this.state={status:t,backend:this.backend}}emitChange(){const t={entries:this.entries,state:this.state},s=new CustomEvent("change",{detail:t});this.dispatchEvent(s)}}const y=new Rt,At={class:"aventuria-section optolith-view"},Wt={class:"aventuria-section-header"},Pt={class:"aventuria-section-title"},Ut={class:"aventuria-section-intro optolith-intro"},Jt={class:"optolith-tabs",role:"tablist"},Tt=["aria-selected"],Vt=["aria-selected"],Mt={key:0,class:"optolith-panel"},Ft={class:"aventuria-card aventuria-card--table optolith-card"},Ht={class:"optolith-callout optolith-callout--accent",role:"note"},Kt={class:"optolith-roll20__link",href:"https://roll20.net",target:"_blank",rel:"noopener noreferrer"},Xt={class:"optolith-github__link",href:"https://github.com/thomaslazar/aventuria-impromptu/issues",target:"_blank",rel:"noopener noreferrer"},qt={class:"optolith-usage"},Gt={class:"aventuria-card-title optolith-usage__title"},Yt={class:"optolith-usage__list"},Qt={class:"optolith-field-group"},Zt={for:"stat-block-input",class:"optolith-label"},te=["placeholder"],ee={class:"optolith-helper"},oe={key:0,class:"optolith-inline-error"},ne={class:"optolith-actions"},se=["disabled"],ae=["disabled"],ie=["disabled"],re={key:0,class:"optolith-callout optolith-callout--info",role:"status"},le={key:1,class:"optolith-callout optolith-callout--danger",role:"alert"},ce={key:0,class:"aventuria-card aventuria-card--table optolith-result"},ue={class:"optolith-result__header"},de={class:"aventuria-card-title optolith-result__title"},he={class:"optolith-result__meta"},ve={class:"optolith-result__actions"},pe={key:0,class:"optolith-callout optolith-callout--warning",role:"alert"},_e={class:"optolith-callout__title"},be={class:"optolith-callout__list"},we={class:"optolith-details"},fe={class:"optolith-details",open:""},me={class:"optolith-details__summary"},ge=["title"],ye={class:"visually-hidden"},Ce={key:1,class:"optolith-panel"},ke={class:"aventuria-card aventuria-card--table optolith-history"},xe={class:"optolith-history__header"},Se={class:"aventuria-card-title"},Ee=["disabled"],De={key:0,class:"optolith-callout optolith-callout--warning",role:"alert"},Ie={key:1,class:"optolith-history__empty"},$e={key:2,class:"optolith-history__list"},je=["aria-expanded","onClick"],Be={class:"optolith-history__toggle-name"},ze={class:"optolith-history__timestamp"},Le=["title"],Ne={key:0,class:"optolith-history__panel"},Oe={class:"optolith-history__panel-actions"},Re=["disabled","onClick"],Ae=["onClick"],We=["disabled","onClick"],Pe={class:"optolith-history__panel-content"},Ue={class:"optolith-history__section"},Je={class:"optolith-history__section-title"},Te={class:"optolith-history__pre"},Ve={class:"optolith-history__section"},Me={class:"optolith-history__section-title"},Fe={class:"optolith-json-actions optolith-json-actions--history"},He=["title","onClick"],Ke={class:"visually-hidden"},Xe={class:"optolith-history__pre"},et=6e3,qe=gt({__name:"OptolithConverterView",setup(r){const{t,locale:s}=yt(),c=k(""),h=k("idle"),p=k(null),u=k(null),v=k(null),_=`${window.location.origin}/aventuria-impromptu/`,w=k(y.getState()),b=k([]),j=k(!1),S=k("convert"),C=k(null),R=x(()=>c.value.length>et),H=x(()=>h.value==="loading"||c.value.trim().length===0||R.value),ot=x(()=>w.value.status==="available"&&b.value.length>0),K=x(()=>u.value?JSON.stringify(u.value.exported,null,2):""),nt=x(()=>new Intl.DateTimeFormat(s.value,{dateStyle:"medium",timeStyle:"short"})),X=x(()=>b.value.map(o=>({id:o.id,name:o.name,createdAt:o.createdAt,formattedDate:nt.value.format(new Date(o.createdAt)),statBlock:o.statBlock,json:JSON.stringify(o.payload.exported,null,2),warningSummary:o.warningSummary}))),L=x(()=>w.value.status==="available"&&!j.value),q=x(()=>L.value&&b.value.length>0),A=x(()=>{if(!u.value)return[];const o=new Set,i=d=>d.startsWith("[Parser] ")?`${t("views.optolithConverter.warnings.prefixes.parser")} ${d.slice(9)}`:d.startsWith("[Resolver] ")?`${t("views.optolithConverter.warnings.prefixes.resolver")} ${d.slice(10)}`:d.startsWith("[Exporter] ")?`${t("views.optolithConverter.warnings.prefixes.exporter")} ${d.slice(10)}`:d;return(u.value.exportedWarnings??[]).forEach(d=>o.add(i(d))),(u.value.parserWarnings??[]).forEach(d=>o.add(i(`[Parser] ${d.section??"general"}: ${d.message}`))),(u.value.resolverWarnings??[]).forEach(d=>o.add(i(`[Resolver] ${d.section}: ${d.message}`))),Object.entries(u.value.unresolved??{}).forEach(([d,E])=>{E.forEach(U=>o.add(i(`[Resolver] ${d}: ${U}`)))}),Array.from(o)});function st(){if(v.value)return v.value;const o=new Worker(new URL("/aventuria-impromptu/assets/optolithConverter.worker-D5VhtXot.js",import.meta.url),{type:"module"});return o.addEventListener("message",at),v.value=o,o}function at(o){const i=o.data;if(i){if(i.type==="error"){h.value="error",p.value=i.error;return}h.value="success",p.value=null,u.value=i.payload,y.save(c.value,i.payload).catch(l=>console.error("Failed to persist cached conversion",l))}}function it(){if(H.value)return;h.value="loading",p.value=null,u.value=null,st().postMessage({type:"convert",payload:{source:c.value,baseUrl:_}})}function W(o){o&&(c.value=o.statBlock,u.value={...o.payload,exportedWarnings:o.payload.exportedWarnings??[]},h.value="success",p.value=null)}function rt(){W(b.value[0])}function G(o){return b.value.find(i=>i.id===o)}function lt(o){C.value=C.value===o?null:o}function ct(o){const i=G(o);i&&(W(i),S.value="convert",C.value=null)}function ut(o){const i=G(o);if(!i)return;const l=new Blob([JSON.stringify(i.payload.exported,null,2)],{type:"application/json"}),d=URL.createObjectURL(l),E=document.createElement("a"),U=i.name.toLowerCase().replace(/[^a-z0-9-]+/g,"-");E.href=d,E.download=`${U||"npc"}-optolith.json`,document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(d)}async function dt(o){if(L.value){j.value=!0;try{await y.remove(o),C.value=null}catch(i){console.error("Failed to remove cached conversion",i)}finally{j.value=!1}}}async function ht(){if(q.value){j.value=!0;try{await y.clear(),C.value=null}catch(o){console.error("Failed to clear cached conversions",o)}finally{j.value=!1}}}function vt(o){return o.total===0?t("views.optolithConverter.recent.warnings.none"):o.total===1?t("views.optolithConverter.recent.warnings.single"):t("views.optolithConverter.recent.warnings.multiple",{count:o.total})}function pt(o){return t("views.optolithConverter.recent.warnings.breakdown",{parser:o.parser,resolver:o.resolver,exporter:o.exporter,unresolved:o.unresolved})}function _t(){if(!u.value)return;const o=new Blob([JSON.stringify(u.value.exported,null,2)],{type:"application/json"}),i=URL.createObjectURL(o),l=document.createElement("a"),d=u.value.exported.name.toLowerCase().replace(/[^a-z0-9-]+/g,"-");l.href=i,l.download=`${d||"npc"}-optolith.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(i)}async function P(o,i){if(o)try{if(!navigator?.clipboard?.writeText)throw new Error("Clipboard API not available");await navigator.clipboard.writeText(o)}catch(l){console.error(`Failed to copy ${i}`,l)}}async function bt(){await P(A.value.join(`
`),"warnings")}async function wt(){await P(K.value,"JSON")}async function ft(o){await P(o,"cached JSON")}function mt(){c.value="",h.value="idle",p.value=null,u.value=null}return Ct(()=>{const o=i=>{const l=i.detail;w.value=l.state,b.value=l.entries};y.addEventListener("change",o),y.init().then(()=>{w.value=y.getState(),b.value=y.getEntries(),b.value.length>0&&W(b.value[0])}).catch(()=>{w.value=y.getState(),b.value=y.getEntries()}),Y(()=>{y.removeEventListener("change",o)})}),kt(b,o=>{C.value&&!o.some(i=>i.id===C.value)&&(C.value=null)}),Y(()=>{v.value&&(v.value.terminate(),v.value=null)}),(o,i)=>(m(),f("section",At,[e("header",Wt,[e("h1",Pt,n(a(t)("views.optolithConverter.title")),1),e("p",Ut,n(a(t)("views.optolithConverter.intro")),1)]),e("nav",Jt,[e("button",{type:"button",role:"tab",class:N(["optolith-tabs__button",{"optolith-tabs__button--active":S.value==="convert"}]),"aria-selected":S.value==="convert",onClick:i[0]||(i[0]=l=>S.value="convert")},n(a(t)("views.optolithConverter.tabs.convert")),11,Tt),e("button",{type:"button",role:"tab",class:N(["optolith-tabs__button",{"optolith-tabs__button--active":S.value==="recent"}]),"aria-selected":S.value==="recent",onClick:i[1]||(i[1]=l=>S.value="recent")},n(a(t)("views.optolithConverter.tabs.recent")),11,Vt)]),S.value==="convert"?(m(),f("div",Mt,[e("article",Ft,[e("div",Ht,[e("span",null,[B(n(a(t)("views.optolithConverter.roll20Note.prefix"))+" ",1),e("a",Kt,n(a(t)("views.optolithConverter.roll20Note.linkText")),1),B(" "+n(a(t)("views.optolithConverter.roll20Note.suffix")),1)]),e("span",null,n(a(t)("views.optolithConverter.languageNote")),1),e("span",null,[B(n(a(t)("views.optolithConverter.bugReportNote.prefix"))+" ",1),e("a",Xt,n(a(t)("views.optolithConverter.bugReportNote.linkText")),1),B(" "+n(a(t)("views.optolithConverter.bugReportNote.suffix")),1)])]),e("section",qt,[e("h2",Gt,n(a(t)("views.optolithConverter.usage.title")),1),e("ol",Yt,[e("li",null,n(a(t)("views.optolithConverter.usage.steps.paste")),1),e("li",null,n(a(t)("views.optolithConverter.usage.steps.convert")),1),e("li",null,n(a(t)("views.optolithConverter.usage.steps.review")),1),e("li",null,n(a(t)("views.optolithConverter.usage.steps.download")),1)])]),e("div",Qt,[e("label",Zt,n(a(t)("views.optolithConverter.input.label")),1),xt(e("textarea",{id:"stat-block-input","onUpdate:modelValue":i[2]||(i[2]=l=>c.value=l),class:N(["optolith-textarea",{"is-invalid":R.value}]),rows:"14",placeholder:a(t)("views.optolithConverter.input.placeholder")},null,10,te),[[St,c.value]]),e("div",ee,n(a(t)("views.optolithConverter.input.help",{max:et,current:c.value.length})),1),R.value?(m(),f("p",oe,n(a(t)("views.optolithConverter.input.tooLong")),1)):D("",!0)]),e("div",ne,[e("button",{type:"button",class:"aventuria-button",disabled:H.value,onClick:it},n(a(t)("views.optolithConverter.buttons.convert")),9,se),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:mt,disabled:h.value==="loading"},n(a(t)("views.optolithConverter.buttons.reset")),9,ae),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:rt,disabled:!ot.value||h.value==="loading"},n(a(t)("views.optolithConverter.buttons.loadLast")),9,ie)]),h.value==="loading"?(m(),f("div",re,n(a(t)("views.optolithConverter.loading")),1)):D("",!0),p.value?(m(),f("div",le,n(p.value),1)):D("",!0)]),u.value?(m(),f("article",ce,[e("header",ue,[e("div",null,[e("h2",de,n(u.value.exported.name),1),e("p",he,n(a(t)("views.optolithConverter.datasetInfo",{schema:u.value.manifest.schemaVersion,checksum:u.value.manifest.sourceChecksum.slice(0,12)})),1)]),e("div",ve,[e("button",{type:"button",class:"aventuria-button",onClick:_t},n(a(t)("views.optolithConverter.buttons.download")),1),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:bt},n(a(t)("views.optolithConverter.buttons.copyWarnings")),1)])]),A.value.length>0?(m(),f("div",pe,[e("h3",_e,n(a(t)("views.optolithConverter.warnings.title")),1),e("ul",be,[(m(!0),f(Q,null,Z(A.value,l=>(m(),f("li",{key:l},n(l),1))),128))])])):D("",!0),e("details",we,[e("summary",null,n(a(t)("views.optolithConverter.normalizedHeading")),1),e("pre",null,n(u.value.normalizedSource),1)]),e("details",fe,[e("summary",me,[B(n(a(t)("views.optolithConverter.jsonHeading"))+" ",1),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost optolith-json-actions__button optolith-json-actions__button--inline",title:a(t)("views.optolithConverter.buttons.copyJson"),onClick:Et(wt,["stop","prevent"])},[i[3]||(i[3]=e("svg",{class:"optolith-json-actions__icon",viewBox:"0 0 24 24",role:"img","aria-hidden":"true",focusable:"false"},[e("path",{fill:"currentColor",d:"M8 3h9a2 2 0 0 1 2 2v13h-2V5H8zm-3 4h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2m0 2v10h9V9z"})],-1)),e("span",ye,n(a(t)("views.optolithConverter.buttons.copyJson")),1)],8,ge)]),e("pre",null,n(K.value),1)])])):D("",!0)])):(m(),f("div",Ce,[e("article",ke,[e("header",xe,[e("h2",Se,n(a(t)("views.optolithConverter.recent.title")),1),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!q.value,onClick:ht},n(a(t)("views.optolithConverter.recent.actions.clear")),9,Ee)]),w.value.status==="disabled"?(m(),f("div",De,n(a(t)("views.optolithConverter.recent.disabled")),1)):X.value.length===0?(m(),f("div",Ie,n(a(t)("views.optolithConverter.recent.empty")),1)):(m(),f("ul",$e,[(m(!0),f(Q,null,Z(X.value,l=>(m(),f("li",{key:l.id,class:"optolith-history__item"},[e("button",{type:"button",class:"optolith-history__toggle","aria-expanded":C.value===l.id,onClick:d=>lt(l.id)},[e("span",Be,n(l.name),1),e("span",ze,n(a(t)("views.optolithConverter.recent.storedAt",{date:l.formattedDate})),1),e("span",{class:N(["optolith-history__warnings",{"optolith-history__warnings--has":l.warningSummary.total>0}]),title:pt(l.warningSummary)},n(vt(l.warningSummary)),11,Le),i[4]||(i[4]=e("span",{class:"optolith-history__chevron","aria-hidden":"true"},null,-1))],8,je),C.value===l.id?(m(),f("div",Ne,[e("div",Oe,[e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!L.value,onClick:d=>ct(l.id)},n(a(t)("views.optolithConverter.recent.actions.load")),9,Re),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:d=>ut(l.id)},n(a(t)("views.optolithConverter.recent.actions.download")),9,Ae),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!L.value,onClick:d=>dt(l.id)},n(a(t)("views.optolithConverter.recent.actions.remove")),9,We)]),e("div",Pe,[e("section",Ue,[e("h3",Je,n(a(t)("views.optolithConverter.recent.labels.statBlock")),1),e("pre",Te,n(l.statBlock),1)]),e("section",Ve,[e("h3",Me,n(a(t)("views.optolithConverter.recent.labels.json")),1),e("div",Fe,[e("button",{type:"button",class:"aventuria-button aventuria-button--ghost optolith-json-actions__button",title:a(t)("views.optolithConverter.buttons.copyJson"),onClick:d=>ft(l.json)},[i[5]||(i[5]=e("svg",{class:"optolith-json-actions__icon",viewBox:"0 0 24 24",role:"img","aria-hidden":"true",focusable:"false"},[e("path",{fill:"currentColor",d:"M8 3h9a2 2 0 0 1 2 2v13h-2V5H8zm-3 4h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2m0 2v10h9V9z"})],-1)),e("span",Ke,n(a(t)("views.optolithConverter.buttons.copyJson")),1)],8,He)]),e("pre",Xe,n(l.json),1)])])])):D("",!0)]))),128))]))])]))]))}}),Ge=(r,t)=>{const s=r.__vccOpts||r;for(const[c,h]of t)s[c]=h;return s},Qe=Ge(qe,[["__scopeId","data-v-94e91174"]]);export{Qe as default};
