import{d as bt,u as wt,r as k,c as S,o as ft,a as q,w as mt,b,e,t as n,f as r,n as j,g as D,h as G,i as gt,v as yt,F as X,j as Q,k as w}from"./index-BvV3q7n7.js";const $=1,F=10,Ct="optolith-converter",kt=1,g="recent-conversions",A="optolith-converter:recent";function St(){return{status:"uninitialized",backend:"none"}}function M(s){return new Promise((t,a)=>{s.onsuccess=()=>t(s.result),s.onerror=()=>a(s.error??new Error("IndexedDB request failed"))})}async function xt(){if(!("indexedDB"in window))throw new Error("IndexedDB is not available");return new Promise((s,t)=>{const a=indexedDB.open(Ct,kt);a.onupgradeneeded=()=>{const c=a.result;c.objectStoreNames.contains(g)||c.createObjectStore(g,{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})},a.onsuccess=()=>s(a.result),a.onerror=()=>t(a.error??new Error("Failed to open IndexedDB"))})}async function P(s){const c=s.transaction(g,"readonly").objectStore(g).index("createdAt"),h=[];return await new Promise((p,u)=>{const d=c.openCursor(null,"prev");d.onsuccess=()=>{const _=d.result;if(!_){p();return}const f=_.value;f.version===$&&h.push(f),_.continue()},d.onerror=()=>u(d.error??new Error("Failed to iterate IndexedDB cursor"))}),h}function z(s){return new Promise((t,a)=>{s.oncomplete=()=>t(),s.onerror=()=>a(s.error??new Error("IndexedDB transaction failed")),s.onabort=()=>a(s.error??new Error("IndexedDB transaction aborted"))})}async function Et(s,t){const a=s.transaction(g,"readwrite"),c=a.objectStore(g);await M(c.put(t)),await Dt(s,a),await z(a)}async function Dt(s,t){const a=t??s.transaction(g,"readwrite"),h=a.objectStore(g).index("createdAt");let p=0;await new Promise((u,d)=>{const _=h.openCursor(null,"prev");_.onsuccess=()=>{const f=_.result;if(!f){u();return}p+=1,p>F&&f.delete(),f.continue()},_.onerror=()=>d(_.error??new Error("Failed to trim IndexedDB cache entries"))}),t||await z(a)}async function It(s,t){const a=s.transaction(g,"readwrite"),c=a.objectStore(g);await M(c.delete(t)),await z(a)}async function $t(s){const t=s.transaction(g,"readwrite"),a=t.objectStore(g);await M(a.clear()),await z(t)}function Bt(s){const t=new Set,a=new Set,c=new Set,h=new Set,p=new Set,u=d=>{p.add(d)};return(s.exportedWarnings??[]).forEach(d=>{c.add(d),u(d)}),(s.parserWarnings??[]).forEach(d=>{const _=`[Parser] ${d.section??"general"}: ${d.message}`;t.add(_),u(_)}),(s.resolverWarnings??[]).forEach(d=>{const _=`[Resolver] ${d.section}: ${d.message}`;a.add(_),u(_)}),Object.entries(s.unresolved??{}).forEach(([d,_])=>{_.forEach(f=>{const m=`[Resolver] ${d}: ${f}`;h.add(m),u(m)})}),{total:p.size,parser:t.size,resolver:a.size,exporter:c.size,unresolved:h.size}}function At(s,t){const a=new Date().toISOString(),c=typeof crypto?.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,h=t.exported?.name?.trim()??"Unnamed conversion";return{id:c,createdAt:a,name:h,statBlock:s,payload:t,warningSummary:Bt(t),version:$}}function I(s){return s.filter(t=>t.version===$).map(t=>({id:t.id,createdAt:t.createdAt,name:t.name,statBlock:t.statBlock,payload:t.payload,warningSummary:t.warningSummary}))}function U(){try{const s=localStorage.getItem(A);if(!s)return[];const t=JSON.parse(s);return t.version!==$||!Array.isArray(t.entries)?(localStorage.removeItem(A),[]):t.entries}catch{return localStorage.removeItem(A),[]}}function T(s){const t={version:$,entries:s.slice(0,F)};localStorage.setItem(A,JSON.stringify(t))}class Lt extends EventTarget{state=St();entries=[];backend="none";db=null;initializationPromise=null;async init(){if(this.state.status==="available"||this.initializationPromise)return this.initializationPromise??Promise.resolve();this.initializationPromise=this.performInitialization(),await this.initializationPromise}async performInitialization(){try{const t=await xt();this.db=t,this.backend="indexedDB",this.entries=I(await P(t)),this.setState("available")}catch{try{const t=U();T(t),this.entries=I(t),this.backend="localStorage",this.setState("available")}catch{this.backend="none",this.entries=[],this.setState("disabled")}}finally{this.initializationPromise=null,this.emitChange()}}getState(){return{...this.state}}getEntries(){return this.entries.slice()}async save(t,a){if(this.state.status==="uninitialized"&&await this.init(),this.state.status!=="available")return;const c=At(t,a);if(this.backend==="indexedDB"&&this.db)await Et(this.db,{...c,version:$}),this.entries=I(await P(this.db));else if(this.backend==="localStorage"){const h=U(),p=[c,...h].slice(0,F);T(p),this.entries=I(p)}this.emitChange()}async remove(t){if(this.state.status==="available"){if(this.backend==="indexedDB"&&this.db)await It(this.db,t),this.entries=I(await P(this.db));else if(this.backend==="localStorage"){const a=U().filter(c=>c.id!==t);T(a),this.entries=I(a)}this.emitChange()}}async clear(){this.state.status==="available"&&(this.backend==="indexedDB"&&this.db?await $t(this.db):this.backend==="localStorage"&&localStorage.removeItem(A),this.entries=[],this.emitChange())}setState(t){this.state={status:t,backend:this.backend}}emitChange(){const t={entries:this.entries,state:this.state},a=new CustomEvent("change",{detail:t});this.dispatchEvent(a)}}const y=new Lt,Ot={class:"aventuria-section optolith-view"},jt={class:"aventuria-section-header"},zt={class:"aventuria-section-title"},Nt={class:"aventuria-section-intro optolith-intro"},Rt={class:"optolith-tabs",role:"tablist"},Wt=["aria-selected"],Pt=["aria-selected"],Ut={key:0,class:"optolith-panel"},Tt={class:"aventuria-card aventuria-card--table optolith-card"},Ft={class:"optolith-callout optolith-callout--accent",role:"note"},Mt={class:"optolith-roll20__link",href:"https://roll20.net",target:"_blank",rel:"noopener noreferrer"},Vt={class:"optolith-usage"},Jt={class:"aventuria-card-title optolith-usage__title"},Ht={class:"optolith-usage__list"},Kt={class:"optolith-field-group"},qt={for:"stat-block-input",class:"optolith-label"},Gt=["placeholder"],Xt={class:"optolith-helper"},Qt={key:0,class:"optolith-inline-error"},Yt={class:"optolith-actions"},Zt=["disabled"],te=["disabled"],ee=["disabled"],oe={key:0,class:"optolith-callout optolith-callout--info",role:"status"},ne={key:1,class:"optolith-callout optolith-callout--danger",role:"alert"},se={key:0,class:"aventuria-card aventuria-card--table optolith-result"},ae={class:"optolith-result__header"},ie={class:"aventuria-card-title optolith-result__title"},re={class:"optolith-result__meta"},le={class:"optolith-result__actions"},ce={key:0,class:"optolith-callout optolith-callout--warning",role:"alert"},ue={class:"optolith-callout__title"},de={class:"optolith-callout__list"},ve={class:"optolith-details"},he={class:"optolith-details",open:""},pe={key:1,class:"optolith-panel"},_e={class:"aventuria-card aventuria-card--table optolith-history"},be={class:"optolith-history__header"},we={class:"aventuria-card-title"},fe=["disabled"],me={key:0,class:"optolith-callout optolith-callout--warning",role:"alert"},ge={key:1,class:"optolith-history__empty"},ye={key:2,class:"optolith-history__list"},Ce=["aria-expanded","onClick"],ke={class:"optolith-history__toggle-name"},Se={class:"optolith-history__timestamp"},xe=["title"],Ee={key:0,class:"optolith-history__panel"},De={class:"optolith-history__panel-actions"},Ie=["disabled","onClick"],$e=["onClick"],Be=["disabled","onClick"],Ae={class:"optolith-history__panel-content"},Le={class:"optolith-history__section"},Oe={class:"optolith-history__section-title"},je={class:"optolith-history__pre"},ze={class:"optolith-history__section"},Ne={class:"optolith-history__section-title"},Re={class:"optolith-history__pre"},Y=6e3,We=bt({__name:"OptolithConverterView",setup(s){const{t,locale:a}=wt(),c=k(""),h=k("idle"),p=k(null),u=k(null),d=k(null),_=`${window.location.origin}/aventuria-impromptu/`,f=k(y.getState()),m=k([]),B=k(!1),x=k("convert"),C=k(null),N=S(()=>c.value.length>Y),V=S(()=>h.value==="loading"||c.value.trim().length===0||N.value),Z=S(()=>f.value.status==="available"&&m.value.length>0),tt=S(()=>u.value?JSON.stringify(u.value.exported,null,2):""),et=S(()=>new Intl.DateTimeFormat(a.value,{dateStyle:"medium",timeStyle:"short"})),J=S(()=>m.value.map(o=>({id:o.id,name:o.name,createdAt:o.createdAt,formattedDate:et.value.format(new Date(o.createdAt)),statBlock:o.statBlock,json:JSON.stringify(o.payload.exported,null,2),warningSummary:o.warningSummary}))),L=S(()=>f.value.status==="available"&&!B.value),H=S(()=>L.value&&m.value.length>0),O=S(()=>{if(!u.value)return[];const o=new Set,i=v=>v.startsWith("[Parser] ")?`${t("views.optolithConverter.warnings.prefixes.parser")} ${v.slice(9)}`:v.startsWith("[Resolver] ")?`${t("views.optolithConverter.warnings.prefixes.resolver")} ${v.slice(10)}`:v.startsWith("[Exporter] ")?`${t("views.optolithConverter.warnings.prefixes.exporter")} ${v.slice(10)}`:v;return(u.value.exportedWarnings??[]).forEach(v=>o.add(i(v))),(u.value.parserWarnings??[]).forEach(v=>o.add(i(`[Parser] ${v.section??"general"}: ${v.message}`))),(u.value.resolverWarnings??[]).forEach(v=>o.add(i(`[Resolver] ${v.section}: ${v.message}`))),Object.entries(u.value.unresolved??{}).forEach(([v,E])=>{E.forEach(W=>o.add(i(`[Resolver] ${v}: ${W}`)))}),Array.from(o)});function ot(){if(d.value)return d.value;const o=new Worker(new URL("/aventuria-impromptu/assets/optolithConverter.worker-DkDQZop-.js",import.meta.url),{type:"module"});return o.addEventListener("message",nt),d.value=o,o}function nt(o){const i=o.data;if(i){if(i.type==="error"){h.value="error",p.value=i.error;return}h.value="success",p.value=null,u.value=i.payload,y.save(c.value,i.payload).catch(l=>console.error("Failed to persist cached conversion",l))}}function st(){if(V.value)return;h.value="loading",p.value=null,u.value=null,ot().postMessage({type:"convert",payload:{source:c.value,baseUrl:_}})}function R(o){o&&(c.value=o.statBlock,u.value={...o.payload,exportedWarnings:o.payload.exportedWarnings??[]},h.value="success",p.value=null)}function at(){R(m.value[0])}function K(o){return m.value.find(i=>i.id===o)}function it(o){C.value=C.value===o?null:o}function rt(o){const i=K(o);i&&(R(i),x.value="convert",C.value=null)}function lt(o){const i=K(o);if(!i)return;const l=new Blob([JSON.stringify(i.payload.exported,null,2)],{type:"application/json"}),v=URL.createObjectURL(l),E=document.createElement("a"),W=i.name.toLowerCase().replace(/[^a-z0-9-]+/g,"-");E.href=v,E.download=`${W||"npc"}-optolith.json`,document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(v)}async function ct(o){if(L.value){B.value=!0;try{await y.remove(o),C.value=null}catch(i){console.error("Failed to remove cached conversion",i)}finally{B.value=!1}}}async function ut(){if(H.value){B.value=!0;try{await y.clear(),C.value=null}catch(o){console.error("Failed to clear cached conversions",o)}finally{B.value=!1}}}function dt(o){return o.total===0?t("views.optolithConverter.recent.warnings.none"):o.total===1?t("views.optolithConverter.recent.warnings.single"):t("views.optolithConverter.recent.warnings.multiple",{count:o.total})}function vt(o){return t("views.optolithConverter.recent.warnings.breakdown",{parser:o.parser,resolver:o.resolver,exporter:o.exporter,unresolved:o.unresolved})}function ht(){if(!u.value)return;const o=new Blob([JSON.stringify(u.value.exported,null,2)],{type:"application/json"}),i=URL.createObjectURL(o),l=document.createElement("a"),v=u.value.exported.name.toLowerCase().replace(/[^a-z0-9-]+/g,"-");l.href=i,l.download=`${v||"npc"}-optolith.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(i)}async function pt(){if(O.value.length!==0)try{if(!navigator?.clipboard?.writeText)throw new Error("Clipboard API not available");await navigator.clipboard.writeText(O.value.join(`
`))}catch(o){console.error("Failed to copy warnings",o)}}function _t(){c.value="",h.value="idle",p.value=null,u.value=null}return ft(()=>{const o=i=>{const l=i.detail;f.value=l.state,m.value=l.entries};y.addEventListener("change",o),y.init().then(()=>{f.value=y.getState(),m.value=y.getEntries(),m.value.length>0&&R(m.value[0])}).catch(()=>{f.value=y.getState(),m.value=y.getEntries()}),q(()=>{y.removeEventListener("change",o)})}),mt(m,o=>{C.value&&!o.some(i=>i.id===C.value)&&(C.value=null)}),q(()=>{d.value&&(d.value.terminate(),d.value=null)}),(o,i)=>(w(),b("section",Ot,[e("header",jt,[e("h1",zt,n(r(t)("views.optolithConverter.title")),1),e("p",Nt,n(r(t)("views.optolithConverter.intro")),1)]),e("nav",Rt,[e("button",{type:"button",role:"tab",class:j(["optolith-tabs__button",{"optolith-tabs__button--active":x.value==="convert"}]),"aria-selected":x.value==="convert",onClick:i[0]||(i[0]=l=>x.value="convert")},n(r(t)("views.optolithConverter.tabs.convert")),11,Wt),e("button",{type:"button",role:"tab",class:j(["optolith-tabs__button",{"optolith-tabs__button--active":x.value==="recent"}]),"aria-selected":x.value==="recent",onClick:i[1]||(i[1]=l=>x.value="recent")},n(r(t)("views.optolithConverter.tabs.recent")),11,Pt)]),x.value==="convert"?(w(),b("div",Ut,[e("article",Tt,[e("div",Ft,[e("span",null,[G(n(r(t)("views.optolithConverter.roll20Note.prefix"))+" ",1),e("a",Mt,n(r(t)("views.optolithConverter.roll20Note.linkText")),1),G(" "+n(r(t)("views.optolithConverter.roll20Note.suffix")),1)]),e("span",null,n(r(t)("views.optolithConverter.languageNote")),1)]),e("section",Vt,[e("h2",Jt,n(r(t)("views.optolithConverter.usage.title")),1),e("ol",Ht,[e("li",null,n(r(t)("views.optolithConverter.usage.steps.paste")),1),e("li",null,n(r(t)("views.optolithConverter.usage.steps.convert")),1),e("li",null,n(r(t)("views.optolithConverter.usage.steps.review")),1),e("li",null,n(r(t)("views.optolithConverter.usage.steps.download")),1)])]),e("div",Kt,[e("label",qt,n(r(t)("views.optolithConverter.input.label")),1),gt(e("textarea",{id:"stat-block-input","onUpdate:modelValue":i[2]||(i[2]=l=>c.value=l),class:j(["optolith-textarea",{"is-invalid":N.value}]),rows:"14",placeholder:r(t)("views.optolithConverter.input.placeholder")},null,10,Gt),[[yt,c.value]]),e("div",Xt,n(r(t)("views.optolithConverter.input.help",{max:Y,current:c.value.length})),1),N.value?(w(),b("p",Qt,n(r(t)("views.optolithConverter.input.tooLong")),1)):D("",!0)]),e("div",Yt,[e("button",{type:"button",class:"aventuria-button",disabled:V.value,onClick:st},n(r(t)("views.optolithConverter.buttons.convert")),9,Zt),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:_t,disabled:h.value==="loading"},n(r(t)("views.optolithConverter.buttons.reset")),9,te),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:at,disabled:!Z.value||h.value==="loading"},n(r(t)("views.optolithConverter.buttons.loadLast")),9,ee)]),h.value==="loading"?(w(),b("div",oe,n(r(t)("views.optolithConverter.loading")),1)):D("",!0),p.value?(w(),b("div",ne,n(p.value),1)):D("",!0)]),u.value?(w(),b("article",se,[e("header",ae,[e("div",null,[e("h2",ie,n(u.value.exported.name),1),e("p",re,n(r(t)("views.optolithConverter.datasetInfo",{schema:u.value.manifest.schemaVersion,checksum:u.value.manifest.sourceChecksum.slice(0,12)})),1)]),e("div",le,[e("button",{type:"button",class:"aventuria-button",onClick:ht},n(r(t)("views.optolithConverter.buttons.download")),1),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:pt},n(r(t)("views.optolithConverter.buttons.copyWarnings")),1)])]),O.value.length>0?(w(),b("div",ce,[e("h3",ue,n(r(t)("views.optolithConverter.warnings.title")),1),e("ul",de,[(w(!0),b(X,null,Q(O.value,l=>(w(),b("li",{key:l},n(l),1))),128))])])):D("",!0),e("details",ve,[e("summary",null,n(r(t)("views.optolithConverter.normalizedHeading")),1),e("pre",null,n(u.value.normalizedSource),1)]),e("details",he,[e("summary",null,n(r(t)("views.optolithConverter.jsonHeading")),1),e("pre",null,n(tt.value),1)])])):D("",!0)])):(w(),b("div",pe,[e("article",_e,[e("header",be,[e("h2",we,n(r(t)("views.optolithConverter.recent.title")),1),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!H.value,onClick:ut},n(r(t)("views.optolithConverter.recent.actions.clear")),9,fe)]),f.value.status==="disabled"?(w(),b("div",me,n(r(t)("views.optolithConverter.recent.disabled")),1)):J.value.length===0?(w(),b("div",ge,n(r(t)("views.optolithConverter.recent.empty")),1)):(w(),b("ul",ye,[(w(!0),b(X,null,Q(J.value,l=>(w(),b("li",{key:l.id,class:"optolith-history__item"},[e("button",{type:"button",class:"optolith-history__toggle","aria-expanded":C.value===l.id,onClick:v=>it(l.id)},[e("span",ke,n(l.name),1),e("span",Se,n(r(t)("views.optolithConverter.recent.storedAt",{date:l.formattedDate})),1),e("span",{class:j(["optolith-history__warnings",{"optolith-history__warnings--has":l.warningSummary.total>0}]),title:vt(l.warningSummary)},n(dt(l.warningSummary)),11,xe),i[3]||(i[3]=e("span",{class:"optolith-history__chevron","aria-hidden":"true"},null,-1))],8,Ce),C.value===l.id?(w(),b("div",Ee,[e("div",De,[e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!L.value,onClick:v=>rt(l.id)},n(r(t)("views.optolithConverter.recent.actions.load")),9,Ie),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",onClick:v=>lt(l.id)},n(r(t)("views.optolithConverter.recent.actions.download")),9,$e),e("button",{type:"button",class:"aventuria-button aventuria-button--ghost",disabled:!L.value,onClick:v=>ct(l.id)},n(r(t)("views.optolithConverter.recent.actions.remove")),9,Be)]),e("div",Ae,[e("section",Le,[e("h3",Oe,n(r(t)("views.optolithConverter.recent.labels.statBlock")),1),e("pre",je,n(l.statBlock),1)]),e("section",ze,[e("h3",Ne,n(r(t)("views.optolithConverter.recent.labels.json")),1),e("pre",Re,n(l.json),1)])])])):D("",!0)]))),128))]))])]))]))}}),Pe=(s,t)=>{const a=s.__vccOpts||s;for(const[c,h]of t)a[c]=h;return a},Te=Pe(We,[["__scopeId","data-v-81f4371e"]]);export{Te as default};
