(function(){"use strict";function v(n){return n.toLocaleLowerCase("de-DE").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim()}function ve(n){const e=N(n.specialAbilities);return{manifest:n.manifest,advantages:N(n.advantages),disadvantages:N(n.disadvantages),specialAbilities:e,skills:N(n.skills),combatTechniques:N(n.combatTechniques),spells:N(n.spells),cantrips:N(n.cantrips),liturgies:N(n.liturgies),blessings:N(n.blessings),equipment:N(n.equipment),languages:H(n.specialAbilities,"SA_29"),scripts:H(n.specialAbilities,"SA_27")}}function N(n){const e=new Map,t=new Map;for(const i of n){e.set(i.id,i),t.set(i.normalizedName,i);for(const r of i.synonyms??[]){const a=v(r);a&&(t.has(a)||t.set(a,i))}const s=typeof i.locale?.name=="string"?String(i.locale.name):void 0;if(s){const r=v(s);r&&!t.has(r)&&t.set(r,i)}}return{byId:e,byName:t}}function H(n,e){const t=n.find(c=>c.id===e),i=new Map;if(!t)return i;const s=t.locale,r=Array.isArray(s?.selectOptions)?s.selectOptions:[],a=typeof t.base=="object"&&t.base!==null?Number.parseInt(String(t.base.levels??""),10):void 0;for(const c of r){if(!c||typeof c.name!="string"||typeof c.id!="number")continue;const o=v(c.name);i.set(o,{ability:t,optionId:c.id,name:c.name,normalizedName:o,maxLevel:Number.isFinite(a)?a:void 0})}return i}function Y(n){return n===void 0||n<=8?0:Math.floor((n-8)/3)}function Ae(n){if(!n)return{at:0,fk:0};const t=n.base?.special;return{at:typeof t?.at=="number"?t.at:0,fk:typeof t?.fk=="number"?t.fk:0}}function we(n){if(n.combatTechnique?.id)return n.combatTechnique.id;if(n.fallback==="unarmed")return"CT_9"}function Ee(n,e,t){const i=n.model.attributes.MU??0,s=n.model.attributes.FF??0,r=[],a=[],c=new Map,o=(l,m,d,b)=>{const k=Math.max(6,Math.round(d)),h=c.get(l);if(h){if(h.sources.some(g=>g.name===b)||h.sources.push({name:b,value:k}),k>h.value&&(h.value=k),new Set(h.sources.map(g=>g.value)).size>1){const g=h.sources.map(p=>`${p.name} ⇒ ${p.value}`).join(", ");a.push(`[Exporter] combatTechniques: Technik ${m??l} hat widersprüchliche Werte (${g}).`)}}else c.set(l,{value:k,sources:[{name:b,value:k}]})},u=l=>t.combatTechniques.byId.get(l)?.name;for(const l of e.weapons){const m=we(l);if(!m)continue;const d=Ae(l.match),b=u(m);let k,h=0,f=0;const g=l.source.attack??null,p=l.source.rangedAttack??null;if(l.source.attack!==null&&l.source.attack!==void 0?(h=Y(i),f=d.at,k=l.source.attack-h-f):l.source.rangedAttack!==null&&l.source.rangedAttack!==void 0&&(h=Y(s),f=d.fk,k=l.source.rangedAttack-h-f),k===void 0)continue;const E=Math.max(6,Math.round(k));r.push({weaponName:l.source.name,combatTechniqueId:m,combatTechniqueName:b,derivedValue:E,sourceAttack:g,sourceRangedAttack:p,attributeBonus:h,weaponModifier:f,fallback:l.fallback}),o(m,b,k,l.source.name)}for(const l of n.model.combatTechniques??[]){const m=v(l.name);if(!m)continue;const d=t.combatTechniques.byName.get(m);if(!d){a.push(`[Exporter] combatTechniques: Kampftechnik "${l.name}" konnte nicht aufgelöst werden.`);continue}o(d.id,d.name,l.value,l.name)}return{values:Object.fromEntries(Array.from(c.entries()).map(([l,m])=>[l,m.value])),warnings:a,details:r}}const Te="1.5.1",ye=3,$e=1100,Q="1.0.0",Ne="EL_1",Le="R_1",Se="C_1",Ie="P_1",ze="m",Re="Unbekannt",_e="Unbekannt",Me="Unbekannt",Ce="Unbekannt",Oe="Unbekannt",Pe="Unbekannt",De=2,qe="Unbekannt",Ve={MU:"ATTR_1",KL:"ATTR_2",IN:"ATTR_3",CH:"ATTR_4",FF:"ATTR_5",GE:"ATTR_6",KO:"ATTR_7",KK:"ATTR_8"};function Ke({dataset:n,parsed:e,resolved:t}){if(n.manifest.schemaVersion!==Q)throw new Error(`Unsupported dataset schema version: ${n.manifest.schemaVersion}. Expected ${Q}.`);const i=new Date().toISOString(),s=Qe(),r=We(e),a=xe(t),c=Fe(t),o=G(t.spells),u=G(t.liturgies),l=G(t.rituals),m=Ee(e,t,n),d={clientVersion:Te,dateCreated:i,dateModified:i,id:s,phase:ye,locale:n.manifest.locale,name:t.name,ap:{total:$e},el:Ne,r:Le,c:Se,p:Ie,sex:Ue(e),pers:Ze(),attr:r,activatable:a,talents:c,spells:o,liturgies:u,blessings:Ge(t),cantrips:Xe(t),rituals:l,ct:m.values,belongings:He(t),rules:Be(),pets:{}},b=je(e,t,m.warnings);return{hero:d,warnings:b}}function Ue(n){const e=n.model.name.trim().toLowerCase(),t=n.normalizedSource.toLowerCase();return["kriegerin","magierin","priesterin","jägerin","herrin","schamanin","meisterin","händlerin","frau "].some(r=>t.includes(r))?"f":["schamane","priester","magier","herr ","krieger"].some(r=>t.includes(r))?"m":e.endsWith("in")||e.endsWith("a")?"f":ze}function We(n){return{values:Object.entries(Ve).map(([t,i])=>{const s=n.model.attributes[t]??0;return{id:i,value:typeof s=="number"?s:0}}).sort((t,i)=>t.id.localeCompare(i.id)),attributeAdjustmentSelected:"ATTR_4",ae:0,kp:0,lp:0,permanentAE:{lost:0,redeemed:0},permanentKP:{lost:0,redeemed:0},permanentLP:{lost:0}}}function xe(n){const e={},t=(s,r)=>{e[s]||(e[s]=[]),e[s].push(r)},i=s=>{if(!s.match)return;const r={};s.selectOption&&(r.sid=s.selectOption.id),s.rawOption&&s.rawOption.trim()&&(r.options=[{type:"Custom",value:s.rawOption.trim()}]),s.level&&(r.tier=s.level),s.source&&(r.label=s.source),t(s.match.id,r)};return n.advantages.forEach(i),n.disadvantages.forEach(i),n.specialAbilities.forEach(i),n.combatSpecialAbilities.forEach(i),n.languages.forEach(s=>{if(!s.match)return;const r={};s.option&&(r.sid=s.option.optionId),!s.option&&s.rawOption?.trim()&&(r.options=[{type:"Custom",value:s.rawOption.trim()}]),s.level&&(r.tier=s.level),r.label=s.source,t(s.match.id,r)}),n.scripts?.forEach(s=>{if(!s.match)return;const r={};s.option&&(r.sid=s.option.optionId),!s.option&&s.rawOption?.trim()&&(r.options=[{type:"Custom",value:s.rawOption.trim()}]),r.label=s.source,t(s.match.id,r)}),e}function Fe(n){const e={};for(const t of n.talents)t.match&&(e[t.match.id]=t.source.value);return e}function G(n){const e={};for(const t of n)t.match&&(e[t.match.id]=t.value);return e}function Ge(n){const e=new Set;for(const t of n.blessings)t.match&&e.add(t.match.id);return Array.from(e)}function je(n,e,t=[]){const i=[],s=new Set,r=a=>{s.has(a)||(s.add(a),i.push(a))};for(const a of n.warnings)r(`[Parser] ${a.section??"general"}: ${a.message}`);for(const a of e.warnings)r(`[Resolver] ${a.section}: ${a.message}`);for(const[a,c]of Object.entries(e.unresolved))for(const o of c)r(`[Resolver] ${a}: unverarbeitet "${o}"`);if(e.weapons.forEach(a=>{!a.match&&a.fallback!=="unarmed"&&r(`[Exporter] weapons: Waffe "${a.source.name}" konnte nicht exportiert werden (keine Zuordnung).`)}),e.armor&&!e.armor.match&&!e.armor.isNaturalArmor){const a=e.armor.source.description??e.armor.source.notes??e.armor.source.raw;r(`[Exporter] armor: Rüstung "${a}" konnte nicht exportiert werden (keine Zuordnung).`)}return t.forEach(a=>r(a)),i}function Xe(n){return n.cantrips.filter(e=>!!e.match?.id).map(e=>e.match.id)}function Be(){return{higherParadeValues:0,attributeValueLimit:!1,enableAllRuleBooks:!0,enabledRuleBooks:[],enableLanguageSpecializations:!1}}function Ze(n){return{family:Re,placeofbirth:_e,dateofbirth:Me,age:Ce,size:Oe,weight:Pe,socialstatus:De,cultureAreaKnowledge:qe}}function He(n){const e=[],t=s=>{e.push(s)};n.weapons.forEach(s=>{if(!s.match)return;const r=j(s.match,{name:s.source.name});s.combatTechnique?.id&&(r.combatTechnique=s.combatTechnique.id),t(r)}),n.armor?.match&&t(j(n.armor.match,{name:n.armor.source.description??n.armor.source.notes??n.armor.source.raw??n.armor.match.name})),n.equipment.forEach(s=>{if(!s.match)return;const r=s.quantityHint??Ye(s.source),a={name:s.source};typeof r=="number"&&(a.amount=r),t(j(s.match,a))});const i={};return e.forEach((s,r)=>{const a=`ITEM_${r+1}`;i[a]={id:a,...s}}),{items:i,armorZones:{},purse:{d:"0",s:"0",h:"0",k:"0"}}}function Ye(n){const e=n.match(/\((\d+)\s*(?:m|meter|metern|schritte?|schritt)\s*\)$/i);if(e?.[1]){const t=Number.parseInt(e[1],10);return Number.isNaN(t)?void 0:t}}function j(n,e={}){const t=n.base??{},i=t.special??{},s={template:n.id,amount:1,name:n.name,isTemplateLocked:!0,...e};for(const[c,o]of Object.entries(t))c==="special"||c==="id"||o===void 0||(s[c]=o);const r={};for(const[c,o]of Object.entries(i??{}))if(o!=null)switch(c){case"protection":s.pro=o;break;case"encumbrance":s.enc=o;break;case"closeRange":r.close=Number(o);break;case"mediumRange":r.medium=Number(o);break;case"farRange":r.far=Number(o);break;default:s[c]=o;break}const a=[r.close,r.medium,r.far].filter(c=>typeof c=="number"&&Number.isFinite(c));return a.length>0&&(s.range=a),e.name?s.name=e.name:s.name=n.name,e.amount&&(s.amount=e.amount),s}function Qe(){return`H_${Math.floor(1+Math.random()*9e9)}`}const Je={"schlechte eigenschaften":"Schlechte Eigenschaft","schlechte eigenschaft":"Schlechte Eigenschaft",dammerungssicht:"Dunkelsicht",dammersicht:"Dunkelsicht",dunkesicht:"Dunkelsicht",verpflichtung:"Verpflichtungen",personlichkeitsschwache:"Persönlichkeitsschwächen",personlichkeitsschwachen:"Persönlichkeitsschwächen"},et=/AKO(?:[IVXLCDM]+)?\s*\d{1,4}/g,tt=/[,:;]+$/,nt={peitsche:"fuhrmannspeitsche",speer:"speer",schwert:"langschwert",langschild:"gro schild",schild:"holzschild",dolch:"dolch",krummsabel:"sabel",krummsaebel:"sabel",platte:"plattenrustung",dietrichsets:"dietrich",dietrichset:"dietrich",seil:"kletterseil pro schritt"},st={phexkirche:"Moralkodex der Phexkirche",hesindekirche:"Moralkodex der Hesindekirche",perainekirche:"Moralkodex der Perainekirche",boronkirche:"Moralkodex der Boronkirche",praioskirche:"Moralkodex der Praioskirche",rondrakirche:"Moralkodex der Rondrakirche",efferdkirche:"Moralkodex der Efferdkirche",traviakirche:"Moralkodex der Traviakirche",firunkirche:"Moralkodex der Firunkirche",tsakirche:"Moralkodex der Tsakirche",ingerimmkirche:"Moralkodex der Ingerimmkirche",rahjakirche:"Moralkodex der Rahjakirche",aveskirche:"Moralkodex der Aveskirche",ifirnkirche:"Moralkodex der Ifirnkirche",korkirche:"Moralkodex der Korkirche",nanduskirche:"Moralkodex der Nanduskirche",swafnirkirche:"Moralkodex der Swafnirkirche"},it={tempel:"Geweihter gegenüber seinem Tempel",kirche:"Geweihter gegenüber seiner Kirche","geweihter gegenüber seinem tempel":"Geweihter gegenüber seinem Tempel","geweihter gegenüber seiner kirche":"Geweihter gegenüber seiner Kirche","magier gegenüber seinem lehrmeister":"Magier gegenüber seinem Lehrmeister","magier gegenüber seiner akademie":"Magier gegenüber seiner Akademie","magier gegenüber seiner gilde":"Magier gegenüber seiner Gilde"},rt={toten:"Toten und Untoten",tote:"Toten und Untoten","toten und untoten":"Toten und Untoten",untoten:"Toten und Untoten"},at={isdira:"Isdira- und Asdharia-Zeichen",asdharia:"Isdira- und Asdharia-Zeichen","isdira und asdharia zeichen":"Isdira- und Asdharia-Zeichen","isdiraund asdharia zeichen":"Isdira- und Asdharia-Zeichen",rogolan:"Rogolan-Runen"},ot={oloargh:"oloarkh"},ct={"shakara hammer":"kriegshammer","shakara-hammer":"kriegshammer","shakagra hammer":"kriegshammer"},lt=new Set(["specialAbilities","combatSpecialAbilities"]),ut=new Set(["schlechte eigenschaft","schlechte eigenschaften","schlechte angewohnheit","schlechte angewohnheiten"]),mt="belastungsgewohnung",dt=["Arroganz","Eitelkeit","Neid","Streitsucht","Unheimlich","Verwöhnt","Vorurteile","Weltfremd","Anzügliches Verhalten","Eifersucht","Busenkomplexe","Peniskomplexe","Stimmungsschwankungen"],ft=new Set(["ein","eine","einen","einem","einer","eins","zwei","drei","vier","fünf","sechs","sieben","acht","neun","zehn","elf","zwölf"].map(n=>n.toLowerCase())),ht=/^(\d+)\s+(schritte?|schritt|meter|metern|m)\b\s*(.*)$/iu,pt={lebensmittelverarbeitung:"Lebensmittelbearbeitung"};function gt(n,e){const t={lookups:e,warnings:[],unresolved:new Map,warningKeys:new Set},i=Wt(n,e),s=new Set(i.languages),r=new Set,a=ae([...n.specialAbilities,...Ut(n.notes)],s,r,e),c=ae(n.combatSpecialAbilities,s,r,e),o=C(i.advantages,"advantages",t.lookups.advantages,t),u=C(i.disadvantages,"disadvantages",t.lookups.disadvantages,t),l=C(a,"specialAbilities",t.lookups.specialAbilities,t),m=C(c,"combatSpecialAbilities",t.lookups.specialAbilities,t),d=[...n.languages,...s],b=[...n.scripts,...r],k=Et(d,t),h=Tt(b,t),f=bt(n.talents,t),g=X(n.spells,"spells",t.lookups.spells,t),p=C(n.cantrips,"cantrips",t.lookups.cantrips,t),E=X(n.liturgies,"liturgies",t.lookups.liturgies,t),I=X(n.rituals,"rituals",t.lookups.spells,t),V=C(n.blessings,"blessings",t.lookups.blessings,t),A=C(n.equipment,"equipment",t.lookups.equipment,t),y=vt(l),w=At(n.weapons,t),P=wt(n.armor??null,t,y),M={};for(const[z,Yn]of t.unresolved.entries())M[z]=Array.from(Yn.values());const Xn=o.some(z=>z.match?.normalizedName==="zauberer"||z.normalizedSource==="zauberer"),Bn=typeof n.pools.asp=="number"&&n.pools.asp>0,ke=l.some(z=>z.match?.normalizedName?.startsWith("tradition"));(Xn||Bn)&&!ke&&T({type:"unresolved",section:"specialAbilities",value:"Tradition",message:"Statblock weist AsP/Zauberer auf, aber keine Tradition. Bitte Tradition manuell ergänzen."},t);const Zn=typeof n.pools.kap=="number"&&n.pools.kap>0,Hn=o.some(z=>z.match?.normalizedName==="geweihter"||z.normalizedSource==="geweihter");return Zn&&!ke&&!Hn&&T({type:"unresolved",section:"specialAbilities",value:"Tradition",message:"Statblock weist KaP auf, aber keine geweihte Tradition oder Geweihter-Vorteil. Bitte Tradition manuell ergänzen."},t),{name:n.name,advantages:o,disadvantages:u,specialAbilities:l,combatSpecialAbilities:m,languages:k,scripts:h,talents:f,spells:g,cantrips:p,liturgies:E,rituals:I,blessings:V,equipment:A,weapons:w,armor:P,unresolved:M,warnings:t.warnings}}function C(n,e,t,i){const s=[];for(const o of n){const u=_(o);u&&s.push(u)}const r=e==="blessings"?Rt(s,t):s,a=[],c=(o,u)=>{const l=re(o);let m=v(l.baseName),d=t.byName.get(m),b,k,h,f;if(!d&&l.options.length>0)for(const p of l.options){const E=`${l.baseName} (${p})`,I=v(E),V=t.byName.get(I);if(V){d=V,m=I,b=p;break}}if(d&&Pt(d)&&l.options.length>0)for(const p of l.options){const E=Ot(d,p);if(E){k=E,f=E.name;break}h||(h=p)}else l.options.length>0&&(f=b??l.options[0]);if(!f&&l.options.length>0&&(f=b??l.options[0]),!f&&b&&(f=b),d&&d.normalizedName==="begabung"&&l.options.length>0){const p=l.options[0],E=yt(p,i);E?(h=E.name,f=f??E.name):h=p}if(!d&&e==="equipment"){const p=ee(o,"equipment",i,l.options);p&&(d=p)}let g=Nt(l.baseName,l.level,f);if(e==="equipment"&&l.quantityToken&&(g=`${g} ${l.quantityToken}`.trim()),!d&&e==="blessings"&&ne(g)){a.push({source:g,normalizedSource:m,match:void 0,selectOption:k,level:l.level??void 0,rawOption:h});return}if(!d&&u&&lt.has(e)){const p=oe(o);if(p.parts.length>1){p.usedOrConnector&&T({type:"split",section:e,value:o,message:`Eintrag "${o}" enthielt "oder"; alle Varianten wurden übernommen.`},i),p.parts.forEach(E=>c(E,!1));return}}d||R(e,g,i),a.push({source:g,normalizedSource:m,match:d,selectOption:k,level:l.level??void 0,rawOption:h,quantityHint:l.quantity})};return r.forEach(o=>c(o,!0)),a}function X(n,e,t,i){const s=[];for(const r of n){const a=_(r.name);if(!a){R(e,r.name,i);continue}const c=v(a),o=t.byName.get(c);o||R(e,a,i),s.push({source:a,normalizedSource:c,match:o,value:r.value})}return s}function bt(n,e){return n.map(t=>{const{baseName:i}=kt(t.name),s=v(i),r=pt[s],a=r?v(r):s;let c=e.lookups.skills.byName.get(a)??e.lookups.skills.byName.get(s);if(!c){const o=Vt(s,e.lookups.skills.byName,1);o?(c=o.entry,T({type:"fuzzy-match",section:"talents",value:t.name,message:`Talent "${t.name}" wurde als "${c.name}" interpretiert (Schreibweise korrigiert).`},e)):R("talents",t.name,e)}return{source:t,match:c}})}function kt(n){const e=n.trim(),t=e.match(/^(.*?)(?:\s*\(([^)]+)\))$/u);return t&&t[1]?{baseName:t[1].trim(),application:t[2]?.trim()}:{baseName:e}}function vt(n){let e=0;for(const t of n){if(t.match?.normalizedName!==mt)continue;const i=t.level??1;i>e&&(e=i)}return e}function At(n,e){const t=[];for(const i of n){const s=_(i.name),r=v(s.length>0?s:i.name),a=i.category==="unarmed"||r==="waffenlos",c=ct[r]??r;let o=c.length>0?e.lookups.equipment.byName.get(c):void 0,u,l;if(o||(o=ee(i.name,"weapons",e)),!o&&a&&(l="unarmed",u=e.lookups.combatTechniques.byId.get("CT_9"),u||T({type:"unresolved",section:"combatTechniques",value:"CT_9",message:"Kampftechnik Raufen (CT_9) konnte nicht geladen werden."},e)),o){const m=Mt(o);m?(u=e.lookups.combatTechniques.byId.get(m),u||T({type:"unresolved",section:"combatTechniques",value:m,message:`Kampftechnik-ID "${m}" fehlt im Datensatz (für ${i.name}).`},e)):l||T({type:"unresolved",section:"weapons",value:i.name,message:`Waffe "${i.name}" enthält keine Kampftechnik im Datensatz.`},e)}!o&&!l&&R("weapons",i.name,e),t.push({source:i,normalizedSource:r,match:o,combatTechnique:u,fallback:l})}return t}function wt(n,e,t){if(!n)return null;const s=(n.description??"").trim(),r=s.toLowerCase(),a=(n.notes??"").toLowerCase(),c=r.includes("keine")||r.includes("ohne"),o=(n.rs??0)>0||(n.be??0)>0||s.length>0,u=s.length===0||r.includes("natürlicher rüstungsschutz")||a.includes("natürlicher rüstungsschutz"),l=(n.rs??0)===0&&(n.be??0)===0&&/kleidung|gewand|robe|tracht/.test(r);if(!o||(n.rs??0)===0&&(n.be??0)===0&&c||l)return null;let m=s;s&&r.includes("normale kleidung")&&r.includes("oder nackt")&&(m="normale Kleidung");const d=_(m),b=d.length>0?v(d):void 0,k=b?e.lookups.equipment.byName.get(b):void 0;let h,f;if(k){const g=Ct(k);if(h=g?.protection,f=g?.encumbrance,g||T({type:"unresolved",section:"armor",value:k.name,message:`Rüstung "${k.name}" enthält keine RS/BE-Daten im Optolith-Katalog.`},e),typeof n.rs=="number"&&typeof h=="number"&&n.rs!==h&&T({type:"value-mismatch",section:"armor",value:s||k.name,message:`RS (${n.rs}) weicht vom Optolith-Wert (${h}) ab.`},e),typeof n.be=="number"&&typeof f=="number"&&n.be!==f){const p=t*2;t>0&&n.be<f&&f-n.be<=p||T({type:"value-mismatch",section:"armor",value:s||k.name,message:`BE (${n.be}) weicht vom Optolith-Wert (${f}) ab.`},e)}}else{const g=s||`RS ${n.rs??"-"} / BE ${n.be??"-"}`;if(u){const p=s.length>0?s:`RS ${n.rs??"-"} / BE ${n.be??"-"}`,E=s.length>0?s:`RS ${n.rs??"-"} / BE ${n.be??"-"}`;T({type:"fuzzy-match",section:"armor",value:p,message:`Eintrag "${E}" ohne Rüstungsbeschreibung; vermutlich natürlicher Rüstungsschutz.`},e)}else R("armor",g,e)}return{source:n,normalizedSource:b,match:k,datasetProtection:h??null,datasetEncumbrance:f??null,isNaturalArmor:!k&&u}}function Et(n,e){return n.map(t=>_(t)).filter(t=>t.length>0).map(t=>{const i=J(t),s=v(i.baseName),r=ot[s]??s,a=e.lookups.languages.get(r);return a?(i.level&&a.maxLevel&&i.level>a.maxLevel&&T({type:"level-out-of-range",section:"languages",value:t,message:`Sprachstufe ${i.level} überschreitet den erlaubten Bereich (${a.maxLevel}).`},e),{source:t,normalizedSource:s,match:a.ability,option:a,level:i.level??void 0}):(R("languages",t,e),{source:t,normalizedSource:s,rawOption:i.baseName})})}function Tt(n,e){return n.map(t=>_(t)).filter(t=>t.length>0).map(t=>{const i=J(t),s=v(i.baseName),r=at[s],a=e.lookups.scripts.get(s)??(r?e.lookups.scripts.get(v(r)):void 0);return a?{source:t,normalizedSource:s,match:a.ability,option:a,level:i.level??void 0}:(R("scripts",t,e),{source:t,normalizedSource:s,rawOption:i.baseName})})}function J(n){const e=n.trim(),t=e.match(/^(.*?)(?:\s+([IVX\d]+(?:\+[IVX\d]+)*))?$/i);if(!t)return{baseName:e};const i=(t[1]??e).trim(),s=t[2]?.trim();if(!s)return{baseName:i};const r=K(s);return{baseName:i,level:r??void 0}}function yt(n,e){const t=v(n),i=e.lookups.skills.byName.get(t)??e.lookups.spells.byName.get(t)??e.lookups.liturgies.byName.get(t);if(i)return{id:i.id,name:i.name}}function $t(n){const e={I:1,V:5,X:10},t=n.toUpperCase().split("");let i=0,s=0;for(const r of t.reverse()){const a=e[r];if(!a)return null;a<s?i-=a:(i+=a,s=a)}return i}function D(n){const e=[[10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]];let t=n,i="";for(const[s,r]of e)for(;t>=s;)i+=r,t-=s;return i||"I"}function Nt(n,e,t){const i=n.trim(),s=e?`${i} ${D(e)}`.trim():i;return t&&t.trim().length>0?`${s} (${t.trim()})`.trim():s}function K(n){const e=n.split("+").map(i=>i.trim()).filter(i=>i.length>0);if(e.length===0)return;const t=e.map(i=>{const s=Number.parseInt(i,10);return Number.isNaN(s)?$t(i)??void 0:s}).filter(i=>i!==void 0);if(t.length!==0)return Math.max(...t)}function R(n,e,t){t.unresolved.has(n)||t.unresolved.set(n,new Set),t.unresolved.get(n).add(e)}function T(n,e){const t=`${n.type}:${n.section}:${n.value}:${n.message}`;e.warningKeys.has(t)||(e.warningKeys.add(t),e.warnings.push(n))}function ee(n,e,t,i=[]){const s=Lt(n,t.lookups.equipment,i);if(!s)return;const r=zt(e,n,s.match.name,s);return T({type:"fuzzy-match",section:e,value:n,message:r},t),s.match}function Lt(n,e,t){const i=v(n),s=St(n,t);for(const r of s){const a=v(r);if(!a||a===i)continue;const c=e.byName.get(a);if(c)return{match:c,token:r,reason:"token"}}for(const r of s){const a=v(r);if(a){for(const[c,o]of Object.entries(nt))if(a===c||a.includes(c)){const u=e.byName.get(o);if(u)return{match:u,token:r,reason:"keyword",keyword:c}}}}}function St(n,e){const t=new Set,i=r=>{if(!r)return;const a=r.trim();if(a.length===0)return;const c=ie(se(a));te(t,c),c!==a&&te(t,a)};i(n);const s=n.replace(/[()]/g," ");return s.split(/[-–—\/]/).forEach(r=>{i(r),r.split(/[,&]/).forEach(a=>i(a))}),s.split(/[,&]/).forEach(r=>i(r)),s.split(/\s+/).forEach(r=>i(r)),e.forEach(r=>i(r)),Array.from(t.values())}function te(n,e){if(e){n.has(e)||n.add(e);for(const t of It(e))t.length>0&&n.add(t)}}function It(n){const e=new Set,t=n.trim(),i=t.toLowerCase();if(i.length<=2)return[];const s=a=>{a&&a!==t&&e.add(a)},r=(a,c="")=>{i.endsWith(a)&&t.length>a.length+1&&s(t.slice(0,t.length-a.length)+c)};return r("en"),r("en","e"),r("e"),r("er"),r("n"),r("s"),Array.from(e.values())}function zt(n,e,t,i){const s=n==="weapons"?"Waffe":"Ausrüstungseintrag";if(i.reason==="keyword"){const r=i.keyword??i.token;return`${s} "${e}" wurde als "${t}" interpretiert (Schlüsselwort "${r}").`}return`${s} "${e}" wurde als "${t}" interpretiert (Teilbegriff "${i.token}").`}function ne(n){const e=v(n);return e==="die zwolf segnungen"||e==="zwolf segnungen"||e==="12 segnungen"}function Rt(n,e){const t=[],i=e.byId?Array.from(e.byId.values()):[];for(const s of n)ne(s)&&i.length>0?i.forEach(r=>{t.push(_t(r))}):t.push(s);return t}function _t(n){const e=n.locale,t=e&&typeof e.name=="string"?String(e.name):null;return t&&t.length>0?t:n.name&&n.name.length>0?n.name:n.id}function Mt(n){const e=n.base;if(!e||typeof e!="object")return;const t=e.special;if(!t||typeof t!="object")return;const i=t.combatTechnique;return typeof i=="string"?i:void 0}function Ct(n){const e=n.base;if(!e||typeof e!="object")return;const t=e.special;if(!t||typeof t!="object")return;const i=t.protection,s=t.encumbrance;if(!(typeof i!="number"&&typeof s!="number"))return{protection:typeof i=="number"?i:null,encumbrance:typeof s=="number"?s:null}}function Ot(n,e){const t=n.locale,i=Array.isArray(t?.selectOptions)?t.selectOptions:[],s=v(e);for(const r of i){if(typeof r?.name!="string"||typeof r?.id!="number")continue;if(v(r.name)===s)return{id:r.id,name:r.name}}}function Pt(n){const e=n.locale;return Array.isArray(e?.selectOptions)&&e.selectOptions.length>0}function _(n){if(!n)return n;const r=n.replace(et," ").replace(/\(\s*\)/g,"").replace(/\s*\+\s*/g,"+").replace(/\s+/g," ").trim().replace(tt,"").trim();return qt(Dt(r))}function Dt(n){return n.replace(/(Tradition\s*\()([^)]*?)geweih(?:ter|te|ten)(\))/gi,(e,t,i,s)=>{const r=i.trim().replace(/[-\s]+$/g,"");if(!r)return`${t}${i}${s}`;const a=`${r}kirche`;return`${t}${a}${s}`})}function qt(n){const e={analys:"Analys Arkanstruktur",odem:"Odem Arcanum",zauberklinge:"Zauberklinge Geisterspeer"},t=v(n);return e[t]??n}function se(n){const e=n.trim(),t=e.match(ht);if(t&&t[3])return t[3].trim();const i=e.match(/^(\d+)\s+(.*)$/u);if(i&&i[2])return i[2].trim();const s=e.match(/^([A-Za-zÄÖÜäöüß]+)\s+(.*)$/u);if(s&&s[2]){const r=s[1]?.toLowerCase();if(r&&ft.has(r))return s[2].trim()}return e}function ie(n){return n.replace(/\(\s*(?:x\s*)?\d+\s*\)\s*$/iu,"").replace(/\(\s*\d+\s*(?:m|meter|metern|schritte?|schritt)\s*\)\s*$/iu,"").trim()}function re(n){let e=n.trim();const t=e.match(/\((\d+)\s*(m|meter|metern|schritte?|schritt)\s*\)\s*$/iu);let i,s;if(t?.[0]){i=t[0].trim();const u=t[1];if(u){const l=Number.parseInt(u,10);s=Number.isNaN(l)?void 0:l}}e=ie(se(e)),e=e.replace(/([IVX]+)\s*-\s*([IVX]+)/gi,"$1+$2");let r;const a=[],c=()=>{const u=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);u&&(r=u[1]?.trim(),e=e.slice(0,u.index).trim())};for(c();;){const u=e.match(/\(([^)]+)\)\s*$/);if(!u)break;const l=u[1]?.trim();if(l){const m=l.split(/[,;]/).map(d=>d.trim()).filter(d=>d.length>0);if(m.length===0)a.unshift(l);else for(let d=m.length-1;d>=0;d-=1){const b=m[d];b&&a.unshift(b)}}e=e.slice(0,u.index).trim()}r||c();const o=r?K(r):void 0;return{baseName:e,options:a,level:o??void 0,quantity:s,quantityToken:i}}function Vt(n,e,t){let i;for(const[s,r]of e.entries()){if(Math.abs(s.length-n.length)>t)continue;const a=Kt(s,n,t);if(a!==void 0&&(!i||a<i.distance)&&(i={entry:r,normalized:s,distance:a},a===0))return i}return i}function Kt(n,e,t){const i=n.length,s=e.length;if(Math.abs(i-s)>t)return;if(i===0)return s<=t?s:void 0;if(s===0)return i<=t?i:void 0;const r=Array.from({length:s+1},(o,u)=>u),a=new Array(s+1);for(let o=1;o<=i;o+=1){a[0]=o;let u=a[0];const l=n.charAt(o-1);for(let m=1;m<=s;m+=1){const d=l===e.charAt(m-1)?0:1;a[m]=Math.min(r[m]+1,a[m-1]+1,r[m-1]+d),u=Math.min(u,a[m])}if(u>t)return;r.splice(0,r.length,...a)}const c=r[s];return c<=t?c:void 0}function ae(n,e,t,i){const s=[];for(const r of n){const a=_(r);if(/^muttersprache\b/i.test(a)){e.add(ce(a));continue}const c=re(a),o=v(c.baseName);if(i.languages.get(o)){c.level!==void 0?e.add(`${c.baseName} ${D(c.level)}`):e.add(c.baseName);continue}if(i.scripts.get(o)){t.add(c.baseName);continue}s.push(r)}return s}function Ut(n){const e=new Set;for(const t of Object.values(n)){if(!t)continue;const i=t.split(/;+/);for(const s of i){const r=s.trim();if(!r)continue;const a=r.match(/^Paktgeschenke?:\s*(.+)$/i);if(a){const c=a[1]?.trim();c&&e.add(c)}}}return Array.from(e)}function Wt(n,e){const t=new Set,i=new Set,s=new Set,r=(a,c)=>{const o=_(a);if(!o)return;if(/^muttersprache\b/i.test(o)){const l=ce(o);s.add(l);return}const u=xt(o);for(const l of u){const m=Yt(l),d=v(m.baseLabel),b=Jt(m.baseLabel,m.detail);for(const k of b){const h=Qt(m.baseLabel,m.level,k);(()=>{let g=e.advantages.byName.get(d),p=e.disadvantages.byName.get(d);if(!g&&!p&&k){const I=v(`${m.baseLabel} (${k})`);g=e.advantages.byName.get(I),p=e.disadvantages.byName.get(I)}if(g&&!p){t.add(h);return}if(p&&!g){i.add(h);return}if(g&&p){c==="advantage"?t.add(h):i.add(h);return}const E=sn(h);if(E==="advantage"){t.add(h);return}if(E==="disadvantage"){i.add(h);return}c==="advantage"?t.add(h):i.add(h)})()}}};for(const a of n.advantages)r(a,"advantage");for(const a of n.disadvantages)r(a,"disadvantage");return{advantages:Array.from(t),disadvantages:Array.from(i),languages:Array.from(s)}}function xt(n){let e=jt(n);e=e.flatMap(Zt),e=e.flatMap(Ht),e=e.flatMap(i=>oe(i).parts);const t=[];for(const i of e){const s=Gt(i);if(s){t.push(s);continue}t.push(Ft(i))}return Array.from(new Set(t))}function Ft(n){const e=n.match(/^Immunität gegen\s+([^()]+)$/i);if(e&&e[1]){const t=e[1].trim();if(t.length>0)return`Immunität gegen (${t})`}return n}function Gt(n){if(/^persönlichkeitsschwäche\b/i.test(n))return n.replace(/^persönlichkeitsschwäche/i,"Persönlichkeitsschwächen");if(/^persönlichkeitsschwächen\b/i.test(n))return n;const e=n.trim();if(!e)return;const t=e.toLowerCase();for(const i of dt){const s=i.toLowerCase();if(t===s||t.startsWith(`${s} `))return`Persönlichkeitsschwächen (${e})`}}function jt(n){const e=n.trim(),t=e.match(/^Angst vor\b(.*)$/i);if(!t)return[e];const i=t[1]?.trim()??"";if(!i)return["Angst vor"];let s=i;if(s.startsWith("(")&&s.endsWith(")"))s=s.slice(1,-1).trim();else{const a=s.match(/\(([^)]+)\)/);a&&a[1]?s=a[1].trim():s=s.trim()}if(s=s.replace(/^…\s*/u,""),!s)return["Angst vor"];const r=s.split(/[,;/]/).map(a=>a.trim().replace(/^…\s*/u,"").replace(/^\(+/u,"").replace(/\)+$/u,"").trim()).filter(a=>a.length>0);return r.length===0?[`Angst vor (${s})`]:r.map(a=>{const{detail:c,level:o}=Xt(a),u=Bt(c),l=o?` ${o}`:"";return`Angst vor (${u})${l}`.trim()})}function Xt(n){const e=n.match(/\s+([IVX\d]+)$/i);return e?.[1]?{detail:n.slice(0,e.index).trim(),level:e[1].trim()}:{detail:n.trim()}}function Bt(n){const e=n.toLowerCase();return rt[e]??n}function Zt(n){const e=n.match(/^Prinzipientreue(?:\s+([IVX\d]+))?\s*(?:\(([^)]+)\))?/i)??[],[,t,i]=e;if(!i)return[n];const s=i.trim().toLowerCase(),r=st[s];if(!r)return[n];const a=t?` ${t.trim()}`:"";return[`Prinzipientreue (${r})${a}`.trim()]}function Ht(n){const e=n.match(/^Verpflichtungen(?:\s+([IVX\d]+))?\s*(?:\(([^)]+)\))?/i)??[],[,t,i]=e;if(!i)return[n];const s=i.split(/[,;]/).map(a=>a.trim()).filter(a=>a.length>0);if(s.length===0)return[n];const r=t?` ${t.trim()}`:"";return s.map(a=>{const c=a.toLowerCase();return`Verpflichtungen (${it[c]??a})${r}`.trim()})}function oe(n){if(!/\b(?:und|oder|bzw\.)\b/i.test(n)&&!n.includes("/"))return{parts:[n],usedOrConnector:!1};const t=n.replace(/\//g," / ").split(/\s+/),i=new Set(["und","oder","bzw.","bzw","/"]),s=[];let r="",a=0,c=!1;const o=()=>{const u=r.trim();u.length>0&&s.push(u),r=""};for(const u of t){if(!u)continue;const l=u.toLowerCase(),m=(u.match(/\(/g)??[]).length,d=(u.match(/\)/g)??[]).length;a===0&&i.has(l)?((l==="oder"||l==="bzw."||l==="bzw"||l==="/")&&(c=!0),o()):(r.length>0&&(r+=" "),r+=u),a=Math.max(0,a+m-d)}return o(),s.length<=1?{parts:[n],usedOrConnector:!1}:{parts:s,usedOrConnector:c}}function Yt(n){let e=n.trim();e=e.replace(/([IVX]+)\s*-\s*([IVX]+)/gi,"$1+$2");const t=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);let i;t&&(i=t[1],e=e.slice(0,t.index).trim());let s;const r=e.match(/^Angst vor\s+(.+)$/i);if(r){const l=r[1]?.trim();l&&!l.startsWith("(")&&(s=l,e="Angst vor")}const a=e.match(/\s*\(([^)]+)\)\s*$/);if(a&&(s=a[1],e=e.slice(0,a.index).trim()),!i){const l=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);l&&(i=l[1],e=e.slice(0,l.index).trim())}const c=en(e);let o=c;const u=i?K(i):void 0;return u&&(o=`${o} ${D(u)}`.trim()),s&&(o=`${o} (${s})`.trim()),{label:o,baseLabel:c,detail:s,level:u}}function Qt(n,e,t){let i=n;return e&&(i=`${i} ${D(e)}`.trim()),t&&(i=`${i} (${t})`.trim()),i}function Jt(n,e){if(!e)return[void 0];const t=v(n);if(!ut.has(t))return[e];const i=e.split(/[,;/]/).flatMap(s=>s.split(/\b(?:und|oder)\b/i).map(r=>r.trim())).map(s=>s.replace(/^\(+|\)+$/g,"").trim()).filter(s=>s.length>0);return i.length>1?i:[e]}function ce(n){let e=n.replace(/^muttersprache/i,"").trim();if(!e)return"Garethi III";const t=e.match(/([IVX\d]+)$/i);let i;t&&(i=t[1],e=e.slice(0,t.index).trim());const s=K(i??"III")??3;return`${e} ${D(s)}`.trim()}function en(n){const e=v(n);return Je[e]??n}const tn=["beidhändig","dunkelsicht","richtungssinn","entfernungssinn","zauberer","zäher hund","blutrausch","herausragender sinn","giftresistenz"],nn=["schlechte eigenschaft","eingeschränkter sinn","angst vor","blind","kälteempfindlich","zauberanfällig"];function sn(n){const e=v(n);return tn.some(t=>e.includes(t))?"advantage":nn.some(t=>e.includes(t))?"disadvantage":"unknown"}const rn=/^(MU|KL|IN|CH|FF|GE|KO|KK)(\s+\d{1,2})\s+(MU|KL|IN|CH|FF|GE|KO|KK)/,le=/([A-Za-zÄÖÜäöüß/+\-]+)\s+([^\s]+)/g,ue=/^([A-Za-zÄÖÜäöüß0-9\s/+\-&]+):\s*(.*)$/,an=["MU","KL","IN","CH","FF","GE","KO","KK"],on={vorteile:"advantages",nachteile:"disadvantages",sonderfertigkeiten:"specialAbilities",kampfsonderfertigkeiten:"combatSpecialAbilities",kampfsonderfertigkeit:"combatSpecialAbilities",sprachen:"languages",schriften:"scripts",talente:"talents",rsbe:"armor",aktionen:"actions",liturgien:"liturgies",liturgie:"liturgies",zauber:"spells",zaubersprüche:"spells",zaubertricks:"cantrips",rituale:"rituals",rituellezauber:"rituals",ausrüstung:"equipment",gegenstände:"equipment",inventar:"equipment",segnungen:"blessings",kampftechniken:"combatTechniques",kampfverhalten:"notes",kampfverhaltenundflucht:"notes",flucht:"notes",schmerz:"notes","vorteile/nachteile":"advantages-disadvantages",vorteilenachteile:"advantages-disadvantages"},cn={sinesschärfe:"Sinnesschärfe","angriff verbessern":"Attacke verbessern",schnelladen:"Schnellladen",eigne:"Eigene"},ln={MU:"Mut",KL:"Klugheit",IN:"Intuition",CH:"Charisma",FF:"Fingerfertigkeit",GE:"Gewandheit",KO:"Konstitution",KK:"Körperkraft"},un=new Set(["ein","eine","einen","einem","einer","eins","zwei","drei","vier","fünf","sechs","sieben","acht","neun","zehn","elf","zwölf"].map(n=>n.toLowerCase())),B=["körper","körperlich","gesellschaft","natur","wissen","handwerk","sprachen","sprachlich"],mn=new RegExp(`^(?:${B.join("|")})\\s*:\\s*`,"i"),dn=new RegExp(`\\b(${B.join("|")})\\s*:\\s*`,"gi"),fn=/^(\d+)\s+(schritte?|schritt|meter|metern|m)\b\s*(.*)$/iu,hn={dietrichset:"Dietrich",dietrichsets:"Dietrich",dietrich:"Dietrich",seil:"Kletterseil, pro Schritt","leichte shakagra platte":"Leichte Shakagra-Plattenrüstung","shakara-hammer":"Kriegshammer"},pn=/[•●◦‣∙]/g,gn=new Set(["und","oder","bzw","talente","talent","liturgien","rituale","sprach"]);function bn(n){const e=[],t=kn(n),i=t.split(`
`).map(A=>A.trim()).filter(A=>A.length>0);if(i.length===0)return{model:Fn(),warnings:[{type:"parse-error",message:"Eingabetext ist leer."}],normalizedSource:t};const s=[...i],r=s.shift()??"Unbekannt",a=[];for(;s.length>0;){const A=s[0];if(!A||!rn.test(A))break;a.push(s.shift())}const c=vn(a.join(" "),e),o={},u=s[0];u?.startsWith("LeP")?(Z(u,o),s.shift()):e.push({type:"missing-section",section:"resources",message:"LeP/AsP/KaP-Zeile nicht gefunden."});const l=s[0];l?.startsWith("AW")&&(Z(l,o),s.shift()),An(s,o);const m=[];let d=0;for(;d<s.length;){const A=s[d];if(A&&me(A)){const y=[A];for(s.splice(d,1);d<s.length&&wn(s[d]);){const M=s[d];if(!M)break;y.push(M),s.splice(d,1)}const w=y.join(" ").replace(/\s+/g," ").trim(),P=Tn(w,e);P&&m.push(P);continue}d+=1}const b=[...s];for(let A=0;A<b.length;A+=1){const y=b[A];if(y&&/^RS\s*\/\s*BE\b/i.test(y)&&!/^RS\s*\/\s*BE\s*:/i.test(y)){const w=y.replace(/^RS\s*\/\s*BE\s*/i,"").trim();b[A]=`RS/BE: ${w}`}}const{sections:k,extras:h}=$n(b),f={combatTechniques:[],scripts:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],talents:[],spells:[],cantrips:[],liturgies:[],rituals:[],blessings:[],equipment:[]},g=new Set,p={};let E=null,I;for(const A of k){const y=Nn(A.heading),w=q(A.content);if(!y){p[A.heading]=w;continue}switch(g.add(y),y){case"advantages":$(f.advantages,w);break;case"disadvantages":$(f.disadvantages,w);break;case"advantages-disadvantages":g.add("advantages"),g.add("disadvantages"),w.toLowerCase()!=="keine"&&Mn(f,w);break;case"specialAbilities":{const{primary:P,trailing:M}=Un(w,"Talente:");de(f.specialAbilities,P),M&&(g.add("talents"),fe(f.talents,M));break}case"combatSpecialAbilities":de(f.combatSpecialAbilities,w);break;case"scripts":$(f.scripts,w);break;case"combatTechniques":$(f.combatTechniques,w);break;case"languages":$(f.languages,w);break;case"talents":fe(f.talents,w);break;case"spells":$(f.spells,w);break;case"cantrips":$(f.cantrips,w);break;case"liturgies":$(f.liturgies,w);break;case"rituals":$(f.rituals,w);break;case"blessings":$(f.blessings,w);break;case"equipment":$(f.equipment,w);break;case"armor":E=En(w,e);break;case"actions":I=O(w);break;case"notes":default:p[A.heading]=w;break}}f.talents.length>0&&g.add("talents");for(const A of["advantages","disadvantages","specialAbilities","talents"])g.has(A)||e.push({type:"missing-section",section:A,message:`Abschnitt "${A}" nicht gefunden.`});return{model:{name:r,attributes:c,pools:o,armor:E,actions:I??null,weapons:m,combatTechniques:x(f.combatTechniques,"combatTechniques",e),advantages:L(f.advantages),disadvantages:L(f.disadvantages),specialAbilities:L(f.specialAbilities),combatSpecialAbilities:L(f.combatSpecialAbilities),languages:L(f.languages),scripts:L(f.scripts),spells:x(f.spells,"spells",e),cantrips:L(f.cantrips),liturgies:x(f.liturgies,"liturgies",e),rituals:x(f.rituals,"rituals",e),blessings:L(f.blessings),equipment:zn(f.equipment),talents:Wn(f.talents,e),notes:p,extras:h},warnings:e,normalizedSource:t}}function kn(n){let e=n.replace(/\r\n/g,`
`).replace(/\t/g," ");return e=e.replace(/([A-Za-zÄÖÜäöüß])-\s*\n\s*([A-Za-zÄÖÜäöüß])/g,"$1$2"),e=e.replace(/–/g,"-"),e=e.split(`
`).map(t=>t.trimEnd()).join(`
`),e.trim()}function vn(n,e){const t={};if(!n)return e.push({type:"missing-section",section:"attributes",message:"Eigenschaftszeilen nicht gefunden."}),t;const i=/(MU|KL|IN|CH|FF|GE|KO|KK)\s+(\d{1,2})/g;let s;for(;(s=i.exec(n))!==null;){const r=s[1],a=s[2];if(!r||!a)continue;const c=r,o=Number.parseInt(a,10);t[c]=Number.isNaN(o)?void 0:o}for(const r of an)t[r]===void 0&&e.push({type:"parse-error",section:"attributes",message:`Eigenschaft ${r} konnte nicht gelesen werden.`});return t}function Z(n,e){for(const t of n.matchAll(le)){const i=t[1],s=t[2];if(!i||!s)continue;const r=O(s);switch(i){case"LeP":e.lep=r;break;case"AsP":e.asp=r;break;case"KaP":e.kap=r;break;case"INI":e.ini=s;break;case"AW":e.aw=r;break;case"SK":e.sk=r;break;case"ZK":e.zk=r;break;case"GS":e.gs=r;break}}}function An(n,e){for(;n.length>0;){const t=n[0]?.trim()??"";if(!t){n.shift();continue}const i=t.replace(/^[–—-]\s*/,"").trim();if(!/^(LeP|AsP|KaP|INI|AW|SK|ZK|GS)\b/i.test(i))break;n.shift(),Z(i,e)}}function O(n){const e=n.replace(/[^0-9\-]/g,"");if(!e)return null;const t=Number.parseInt(e,10);return Number.isNaN(t)?null:t}function me(n){return/^[^:]+:\s+(AT|FK)\s+/i.test(n)}function wn(n){if(!n)return!1;const e=n.trim();return!(!e||me(e)||ue.test(e)||/^RS\s*\/\s*BE/i.test(e))}function En(n,e){const t=q(n);if(!t)return null;const i=t,s=t.match(/^(\d+)\s*\/\s*(\d+)(.*)$/);if(!s)return e.push({type:"parse-error",section:"armor",message:`Rüstungseintrag "${t}" konnte nicht interpretiert werden.`}),{rs:null,be:null,description:null,notes:t,raw:i};const[,r,a,c=""]=s,o=c??"",u=[...o.matchAll(/\(([^)]+)\)/g)].map(d=>d[1]?.trim()??"");let l=u[0]??null;const m=u.length>1?u.slice(1).filter(Boolean).join("; "):null;if(!l){const d=o.replace(/\([^)]*\)/g," ").replace(/[;,]+/g," ").trim();d&&(l=q(d))}return{rs:O(r??""),be:O(a??""),description:l,notes:m,raw:i}}function Tn(n,e){const[t,i]=n.split(":");if(!i){e.push({type:"parse-error",section:"weapons",message:`Zeile "${n}" enthält keinen Doppelpunkt.`});return}const s=(t??"").trim(),r={};for(const l of i.matchAll(le)){const m=l[1],d=l[2];if(!m||!d)continue;const b=m.toUpperCase();r[b]=d}const a=r.AT?O(r.AT):null,c=r.PA?O(r.PA):null,o=r.FK?O(r.FK):null,u=yn(s,a,o);return{name:s,category:u,attack:a,parry:c,rangedAttack:o,damage:r.TP??null,range:r.RW??null,load:r.LZ??null,reach:r.RE??null,notes:r.BEM??null,raw:r,rawInput:n.trim()}}function yn(n,e,t){return n.toLowerCase().includes("waffenlos")?"unarmed":t!==null?"ranged":e!==null?"melee":"unknown"}function $n(n){const e=[],t=[];let i=null,s=[];const r=()=>{i?e.push({heading:i,content:s.join(" ").trim()}):s.length>0&&t.push(s.join(" ").trim()),i=null,s=[]};for(const a of n){const c=a.trim();if(!c)continue;const o=c.match(ue);if(o){const u=o[1]?.trim();if(i&&i.toLowerCase().startsWith("talente")&&u&&he(u)){s.push(c);continue}r(),i=u&&u.length>0?u:null;const l=o[2]?.trim();s=l?[l]:[];continue}i?s.push(c):t.push(c)}return r(),{sections:e,extras:t}}function Nn(n){const e=n.toLowerCase().replace(/\s+/g,"").replace(/[()\/]/g,"");return e.startsWith("schmerz")||e==="kampfverhaltenflucht"?"notes":on[e]??null}function $(n,e){if(e)for(const t of U(e))n.push(t)}function de(n,e){if(e)for(const t of U(e))_n(t).forEach(s=>{s&&n.push(s)})}function fe(n,e){if(!e||e.toLowerCase()==="keine")return;const t=Ln(e);for(const i of U(t)){const s=Sn(i);s&&n.push(s)}}function Ln(n){return n.replace(dn,(e,t,i)=>he(t)?`${i===0?"":"; "}${t}: `:e)}function Sn(n){return n.replace(mn,"")}function he(n){const e=n.toLowerCase().replace(/\s+/g,"").replace(/-+/g,"");return B.some(t=>e.startsWith(t.replace(/\s+/g,"")))}function U(n){const e=n.replace(pn,";"),t=[];let i="",s=0;for(const a of e){if(a==="("?s+=1:a===")"&&(s=Math.max(s-1,0)),(a===","||a===";")&&s===0){i.trim()&&t.push(i.trim()),i="";continue}i+=a}i.trim()&&t.push(i.trim());const r=t.map(a=>W(a));return In(r)}function In(n){const e=[];for(const t of n){const i=t.trim();e.length>0&&/^(den|die|das|dessen|deren)\b/i.test(i)?e[e.length-1]=`${e[e.length-1]}, ${i}`:e.push(i)}return e}function zn(n){return L(n).map(e=>Rn(e)).filter(e=>e.length>0)}function Rn(n){const e=qn(Dn(n)),t=e.match(/\(\s*[^)]+\)\s*$/u),i=t?t[0]:"",s=i&&e.endsWith(i)?e.slice(0,e.length-i.length).trim():e,r=hn[s.toLowerCase()];return r?i?`${r} ${i}`.trim():r:e}function _n(n){const e=n.split(new RegExp("(?<=\\))\\s+(?=[A-ZÄÖÜ][a-zäöüß])","u")).map(t=>t.trim()).filter(t=>t.length>0);return e.length>0?e:[n]}function Mn(n,e){for(const t of U(e)){const i=Kn(t);for(const s of i){const r=Cn(s);r==="disadvantage"?n.disadvantages.push(s):r==="advantage"?n.advantages.push(s):(n.advantages.push(s),n.disadvantages.push(s))}}}function Cn(n){const e=n.toLowerCase();return["schlechte eigenschaft","verpflicht","feindschaft","hass","arm","krankheit","unfähig","vorurteil","schulden","angst","zauberanfällig"].some(s=>e.includes(s))?"disadvantage":["begabung","adelig","gutaussehend","vorteil","resistenz","richtungssinn","entfernungssinn"].some(s=>e.includes(s))?"advantage":"both"}function L(n){return n.map(e=>q(e)).map(e=>W(e)).map(e=>On(e)).map(e=>Pn(e)).map(e=>pe(e)).map(e=>ge(e)).map(e=>q(e)).map(e=>e.endsWith(".")?e.slice(0,-1):e).filter(e=>e.length>0).filter(e=>{const t=e.toLowerCase();return t!=="keine"&&t!=="keiner"&&t!=="keinen"&&t!=="nein"&&t!=="entfällt"&&t!=="-"&&t!=="—"})}function q(n){return n.replace(/\s+/g," ").trim()}function W(n){return n.replace(/([A-Za-zÄÖÜäöüß]+)-\s+([A-Za-zÄÖÜäöüß]+)\b/g,(e,t,i)=>gn.has(i.toLowerCase())?`${t}- ${i}`:`${t}${i}`)}function On(n){let e=n.replace(/([IVX]+)\s*AKO\d+/gi,"$1").replace(/([IVX]+)AKO\d+/gi,"$1");return e=e.replace(/AKO[IVX\d]+/gi,""),e=e.replace(/\s{2,}/g," "),e.trim()}function pe(n){let e=n;for(const[t,i]of Object.entries(cn)){const s=new RegExp(`\\b${t}\\b`,"gi");e=e.replace(s,i)}return e}function ge(n){return n.replace(/\*+$/g,"").trim()}function Pn(n){return n.replace(/\(([^)]+)\)/g,(e,t)=>`(${t.split(/\s*[;,\/]\s*/).map(s=>{const r=s.trim(),a=r.toUpperCase();return ln[a]??r}).filter(s=>s.length>0).join(", ")})`)}function Dn(n){const e=n.trim(),t=e.match(fn);if(t&&t[3]){const[,r,a,c]=t;if(a&&c){const o=c.trim();if(o){const u=o.toLowerCase()==="seil"?"Kletterseil, pro Schritt":o,m=a.toLowerCase().startsWith("schritt")?"m":a;return`${u} (${r} ${m})`.trim()}}}const i=e.match(/^(\d+)\s+(.*)$/u);if(i&&i[2])return i[2].trim();const s=e.match(/^([A-Za-zÄÖÜäöüß]+)\s+(.*)$/u);if(s&&s[2]){const r=s[1]?.toLowerCase();if(r&&un.has(r))return s[2].trim()}return e}function qn(n){let e=n.trim();return e=e.replace(/\(\s*(?:x\s*)?\d+\s*\)\s*$/iu,"").trim(),e}function Vn(n){return n.replace(/\(\s*[^)]*\)\s*$/u,"").trim()}function Kn(n){const e=[];let t="",i=0;for(const s of n){if(s==="("?i+=1:s===")"&&(i=Math.max(i-1,0)),s==="/"&&i===0){t.trim()&&e.push(t.trim()),t="";continue}t+=s}return t.trim()&&e.push(t.trim()),e}function Un(n,e){const t=n.toLowerCase(),i=e.toLowerCase(),s=t.indexOf(i);if(s===-1)return{primary:n};const r=n.slice(0,s).trim().replace(/[;,]+$/,""),a=n.slice(s+e.length).trim();return{primary:r.length>0?r:"",trailing:a.length>0?a:void 0}}function Wn(n,e){const t=[];for(const i of n){const a=ge(i.trim()).replace(/([^\s\d])(-?\d+)(\s*\([^)]*\))?$/,"$1 $2$3").match(/^(.+?)\s+(-?\d+)(?:\s*\([^)]*\))?$/);if(!a){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${i}"`});continue}const c=W(a[1]??""),o=a[2];if(!c||!o){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${i}"`});continue}const u=pe(c.replace(/\*+$/,"").trim()),l=Number.parseInt(o,10);if(Number.isNaN(l)){e.push({type:"parse-error",section:"talents",message:`Talentwert ist keine Zahl: "${i}"`});continue}t.push({name:u,value:l})}return t}function x(n,e,t){const i=[];for(const s of L(n)){const a=Vn(s).match(/^(.+?)\s+(-?\d+|[IVX]+)$/i);if(!a){i.push({name:s,value:0}),t.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${s}"`});continue}const c=W(a[1]??""),o=a[2];if(!c||!o){t.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${s}"`});continue}const u=c.trim(),l=o.trim();let m=Number.parseInt(l,10);if(Number.isNaN(m)&&(m=xn(l.toUpperCase())),!m||Number.isNaN(m)){t.push({type:"parse-error",section:e,message:`Numerischer Wert für ${e} ist ungültig: "${s}"`});continue}i.push({name:u,value:m})}return i}function xn(n){const e={I:1,V:5,X:10,L:50,C:100},t=n.toUpperCase().split("");let i=0,s=0;for(const r of t.reverse()){const a=e[r];if(!a)return null;a<s?i-=a:(i+=a,s=a)}return i}function Fn(){return{name:"Unbekannt",attributes:{},pools:{},armor:null,actions:null,weapons:[],combatTechniques:[],scripts:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],spells:[],cantrips:[],liturgies:[],rituals:[],blessings:[],equipment:[],talents:[],notes:{},extras:[]}}let F,be;self.addEventListener("message",async n=>{const e=n.data;if(!(!e||e.type!=="convert"))try{const t=await Gn(e.payload.baseUrl),i=bn(e.payload.source),s=gt(i.model,t),{hero:r,warnings:a}=Ke({dataset:t,parsed:i,resolved:s}),c=jn(s),o={type:"result",payload:{exported:r,exportedWarnings:a,manifest:t.manifest,normalizedSource:i.normalizedSource,parserWarnings:i.warnings,resolverWarnings:s.warnings,unresolved:s.unresolved,equipmentSummary:c}};postMessage(o)}catch(t){const i={type:"error",error:t instanceof Error?t.message:String(t)};postMessage(i)}});async function Gn(n){const e=new URL("data/optolith/manifest.json",n).toString();if(F&&be===e)return F;const t=await fetch(e);if(!t.ok)throw new Error(`Manifest konnte nicht geladen werden (${t.status})`);const i=await t.json(),s=async a=>{const c=new URL(`data/optolith/${a}`,n).toString(),o=await fetch(c);if(!o.ok)throw new Error(`Datensatz ${a} konnte nicht geladen werden (${o.status})`);return o.json()},r={manifest:i,advantages:await s(S(i,"advantages")),disadvantages:await s(S(i,"disadvantages")),specialAbilities:await s(S(i,"specialAbilities")),skills:await s(S(i,"skills")),combatTechniques:await s(S(i,"combatTechniques")),spells:await s(S(i,"spells")),cantrips:await s(S(i,"cantrips")),liturgies:await s(S(i,"liturgies")),blessings:await s(S(i,"blessings")),equipment:await s(S(i,"equipment"))};return F=ve(r),be=e,F}function jn(n){const e=n.weapons.map(s=>({name:s.source.name,templateId:s.match?.id,combatTechniqueId:s.combatTechnique?.id,fallback:s.fallback,unresolved:!s.match})),t=n.armor?{name:n.armor.source.description??n.armor.source.notes??n.armor.source.raw??"Unknown armor",templateId:n.armor.match?.id,protection:typeof n.armor.datasetProtection=="number"?n.armor.datasetProtection:null,encumbrance:typeof n.armor.datasetEncumbrance=="number"?n.armor.datasetEncumbrance:null,unresolved:!n.armor.match}:null,i=n.equipment.map(s=>({name:s.source,templateId:s.match?.id,unresolved:!s.match}));return{weapons:e,armor:t,gear:i}}function S(n,e){const t=n.sections.find(i=>i.key===e);if(!t)throw new Error(`Manifestabschnitt fehlt: ${e}`);return t.file}})();
