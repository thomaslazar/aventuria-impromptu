(function(){"use strict";function k(t){return t.toLocaleLowerCase("de-DE").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim()}function _e(t){const e=S(t.specialAbilities),n=Me(t.books);return{manifest:t.manifest,advantages:S(t.advantages),disadvantages:S(t.disadvantages),specialAbilities:e,skills:S(t.skills),combatTechniques:S(t.combatTechniques),spells:S(t.spells),cantrips:S(t.cantrips),liturgies:S(t.liturgies),blessings:S(t.blessings),equipment:S(t.equipment),languages:Y(t.specialAbilities,"SA_29"),scripts:Y(t.specialAbilities,"SA_27"),citationPattern:Ce(n),blessedTraditions:Q(t.blessedTraditions),magicalTraditions:Q(t.magicalTraditions)}}function S(t){const e=new Map,n=new Map;for(const s of t){e.set(s.id,s),n.set(s.normalizedName,s);for(const r of s.synonyms??[]){const a=k(r);a&&(n.has(a)||n.set(a,s))}const i=typeof s.locale?.name=="string"?String(s.locale.name):void 0;if(i){const r=k(i);r&&!n.has(r)&&n.set(r,s)}}return{byId:e,byName:n}}function Y(t,e){const n=t.find(o=>o.id===e),s=new Map;if(!n)return s;const i=n.locale,r=Array.isArray(i?.selectOptions)?i.selectOptions:[],a=typeof n.base=="object"&&n.base!==null?Number.parseInt(String(n.base.levels??""),10):void 0;for(const o of r){if(!o||typeof o.name!="string"||typeof o.id!="number")continue;const c=k(o.name);s.set(c,{ability:n,optionId:o.id,name:o.name,normalizedName:c,maxLevel:Number.isFinite(a)?a:void 0})}return s}function Q(t){const e=new Map;for(const n of t)e.set(n.id,n);return e}function Me(t){const e=new Set;for(const n of t){const s=String(n.locale?.short??"").trim();if(!s)continue;const i=s.replace(/\s+/g,"");if(i){e.add(i);let r=i;for(;r.length>1&&/[IVXLCDM]$/i.test(r.charAt(r.length-1));)r=r.slice(0,-1),e.add(r)}}return[...e].sort((n,s)=>s.length-n.length)}function Ce(t){if(t.length===0)return null;const e=t.map(s=>s.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")).filter(s=>s.length>0);if(e.length===0)return null;const n=`(?:${e.join("|")})\\s*-?\\s*\\d{1,4}`;return new RegExp(n,"giu")}function J(t){return t===void 0||t<=8?0:Math.floor((t-8)/3)}function De(t){if(!t)return{at:0,fk:0};const n=t.base?.special;return{at:typeof n?.at=="number"?n.at:0,fk:typeof n?.fk=="number"?n.fk:0}}function Oe(t){if(t.combatTechnique?.id)return t.combatTechnique.id;if(t.fallback==="unarmed")return"CT_9"}function Pe(t,e,n){const s=t.model.attributes.MU??0,i=t.model.attributes.FF??0,r=[],a=[],o=new Map,c=(l,m,f,b)=>{const A=Math.max(6,Math.round(f)),h=o.get(l);if(h){if(h.sources.some(g=>g.name===b)||h.sources.push({name:b,value:A}),A>h.value&&(h.value=A),new Set(h.sources.map(g=>g.value)).size>1){const g=h.sources.map(p=>`${p.name} ⇒ ${p.value}`).join(", ");a.push(`[Exporter] combatTechniques: Technik ${m??l} hat widersprüchliche Werte (${g}).`)}}else o.set(l,{value:A,sources:[{name:b,value:A}]})},u=l=>n.combatTechniques.byId.get(l)?.name;for(const l of e.weapons){const m=Oe(l);if(!m)continue;const f=De(l.match),b=u(m);let A,h=0,d=0;const g=l.source.attack??null,p=l.source.rangedAttack??null;if(l.source.attack!==null&&l.source.attack!==void 0?(h=J(s),d=f.at,A=l.source.attack-h-d):l.source.rangedAttack!==null&&l.source.rangedAttack!==void 0&&(h=J(i),d=f.fk,A=l.source.rangedAttack-h-d),A===void 0)continue;const T=Math.max(6,Math.round(A));r.push({weaponName:l.source.name,combatTechniqueId:m,combatTechniqueName:b,derivedValue:T,sourceAttack:g,sourceRangedAttack:p,attributeBonus:h,weaponModifier:d,fallback:l.fallback}),c(m,b,A,l.source.name)}for(const l of t.model.combatTechniques??[]){const m=k(l.name);if(!m)continue;const f=n.combatTechniques.byName.get(m);if(!f){a.push(`[Exporter] combatTechniques: Kampftechnik "${l.name}" konnte nicht aufgelöst werden.`);continue}c(f.id,f.name,l.value,l.name)}return{values:Object.fromEntries(Array.from(o.entries()).map(([l,m])=>[l,m.value])),warnings:a,details:r}}const Ve="1.5.1",Ke=3,qe=1100,ee="1.0.0",Ue="EL_1",xe="R_1",Fe="C_1",We="P_1",Ge="m",je="Unbekannt",He="Unbekannt",Be="Unbekannt",Xe="Unbekannt",Ze="Unbekannt",Ye="Unbekannt",Qe=2,Je="Unbekannt",te={MU:"ATTR_1",KL:"ATTR_2",IN:"ATTR_3",CH:"ATTR_4",FF:"ATTR_5",GE:"ATTR_6",KO:"ATTR_7",KK:"ATTR_8"},et=Object.fromEntries(Object.entries(te).map(([t,e])=>[e,t])),tt="ADV_12",nt="ADV_50",it="SA_563",st="SA_772",rt="ADV_24",at="ADV_23",ot="DISADV_27",ct="DISADV_26",ne=6;function lt({dataset:t,parsed:e,resolved:n}){if(t.manifest.schemaVersion!==ee)throw new Error(`Unsupported dataset schema version: ${t.manifest.schemaVersion}. Expected ${ee}.`);const s=new Date().toISOString(),i=wt(),r=mt(e,n,t),a=ht(n),o=pt(n),c=j(n.spells),u=j(n.liturgies),l=j(n.rituals),m=Pe(e,n,t),f={clientVersion:Ve,dateCreated:s,dateModified:s,id:i,phase:Ke,locale:t.manifest.locale,name:n.name,ap:{total:qe},el:Ue,r:xe,c:Fe,p:We,sex:ut(e),pers:vt(),attr:r,activatable:a,talents:o,spells:c,liturgies:u,blessings:gt(n),cantrips:At(n),rituals:l,ct:m.values,belongings:Et(n),rules:kt(),pets:{}},b=bt(e,n,m.warnings);return{hero:f,warnings:b}}function ut(t){const e=t.model.name.trim().toLowerCase(),n=t.normalizedSource.toLowerCase();return["kriegerin","magierin","priesterin","jägerin","herrin","schamanin","meisterin","händlerin","frau "].some(r=>n.includes(r))?"f":["schamane","priester","magier","herr ","krieger"].some(r=>n.includes(r))?"m":e.endsWith("in")||e.endsWith("a")?"f":Ge}function mt(t,e,n){const s=Object.entries(te).map(([a,o])=>{const c=t.model.attributes[a]??0;return{id:o,value:typeof c=="number"?c:0}}).sort((a,o)=>a.id.localeCompare(o.id)),i=dt(t,e,n),r=ft(t,e,n);return{values:s,attributeAdjustmentSelected:"ATTR_4",ae:r,kp:i,lp:0,permanentAE:{lost:0,redeemed:0},permanentKP:{lost:0,redeemed:0},permanentLP:{lost:0}}}function dt(t,e,n){const s=t.model.pools.kap;if(typeof s!="number"||s<=0||!ie(e,tt))return 0;const i=ae(e,n.blessedTraditions);if(!i)return 0;const r=oe(i),a=ce(t,r);if(a===null)return 0;const o=le(e.specialAbilities,it),c=se(e.advantages,rt),u=re(e.disadvantages,ot),l=20+a+o*ne+c-u,m=s-l;return m>0?m:0}function ft(t,e,n){const s=t.model.pools.asp;if(typeof s!="number"||s<=0||!ie(e,nt))return 0;const i=ae(e,n.magicalTraditions);if(!i)return 0;const r=oe(i),a=ce(t,r);if(a===null)return 0;const o=le(e.specialAbilities,st),c=se(e.advantages,at),u=re(e.disadvantages,ct),l=20+a+o*ne+c-u,m=s-l;return m>0?m:0}function ie(t,e){return t.advantages.some(n=>n.match?.id===e)}function se(t,e){return t.find(s=>s.match?.id===e)?.level??0}function re(t,e){return t.find(s=>s.match?.id===e)?.level??0}function ae(t,e){for(const n of t.specialAbilities){const s=n.match;if(s&&e.has(s.id))return e.get(s.id)}}function oe(t){if(!t)return;const e=t.base;return typeof e?.primary=="string"?e.primary:void 0}function ce(t,e){if(!e)return null;const n=et[e];if(!n)return null;const s=t.model.attributes[n];return typeof s=="number"?s:null}function le(t,e){return t.find(s=>s.match?.id===e)?.level??0}function ht(t){const e={},n=(i,r)=>{e[i]||(e[i]=[]),e[i].push(r)},s=i=>{if(!i.match)return;const r={};i.selectOption&&(r.sid=i.selectOption.id),i.rawOption&&i.rawOption.trim()&&(r.options=[{type:"Custom",value:i.rawOption.trim()}]),i.level&&(r.tier=i.level),i.source&&(r.label=i.source),n(i.match.id,r)};return t.advantages.forEach(s),t.disadvantages.forEach(s),t.specialAbilities.forEach(s),t.combatSpecialAbilities.forEach(s),t.languages.forEach(i=>{if(!i.match)return;const r={};i.option&&(r.sid=i.option.optionId),!i.option&&i.rawOption?.trim()&&(r.options=[{type:"Custom",value:i.rawOption.trim()}]),i.level&&(r.tier=i.level),r.label=i.source,n(i.match.id,r)}),t.scripts?.forEach(i=>{if(!i.match)return;const r={};i.option&&(r.sid=i.option.optionId),!i.option&&i.rawOption?.trim()&&(r.options=[{type:"Custom",value:i.rawOption.trim()}]),r.label=i.source,n(i.match.id,r)}),e}function pt(t){const e={};for(const n of t.talents)n.match&&(e[n.match.id]=n.source.value);return e}function j(t){const e={};for(const n of t)n.match&&(e[n.match.id]=n.value);return e}function gt(t){const e=new Set;for(const n of t.blessings)n.match&&e.add(n.match.id);return Array.from(e)}function bt(t,e,n=[]){const s=[],i=new Set,r=a=>{i.has(a)||(i.add(a),s.push(a))};for(const a of t.warnings)r(`[Parser] ${a.section??"general"}: ${a.message}`);for(const a of e.warnings)r(`[Resolver] ${a.section}: ${a.message}`);for(const[a,o]of Object.entries(e.unresolved))for(const c of o)r(`[Resolver] ${a}: unverarbeitet "${c}"`);if(e.weapons.forEach(a=>{!a.match&&a.fallback!=="unarmed"&&r(`[Exporter] weapons: Waffe "${a.source.name}" konnte nicht exportiert werden (keine Zuordnung).`)}),e.armor&&!e.armor.match&&!e.armor.isNaturalArmor){const a=e.armor.source.description??e.armor.source.notes??e.armor.source.raw;r(`[Exporter] armor: Rüstung "${a}" konnte nicht exportiert werden (keine Zuordnung).`)}return n.forEach(a=>r(a)),s}function At(t){return t.cantrips.filter(e=>!!e.match?.id).map(e=>e.match.id)}function kt(){return{higherParadeValues:0,attributeValueLimit:!1,enableAllRuleBooks:!0,enabledRuleBooks:[],enableLanguageSpecializations:!1}}function vt(t){return{family:je,placeofbirth:He,dateofbirth:Be,age:Xe,size:Ze,weight:Ye,socialstatus:Qe,cultureAreaKnowledge:Je}}function Et(t){const e=[],n=i=>{e.push(i)};t.weapons.forEach(i=>{if(!i.match)return;const r=H(i.match,{name:i.source.name});i.combatTechnique?.id&&(r.combatTechnique=i.combatTechnique.id),n(r)}),t.armor?.match&&n(H(t.armor.match,{name:t.armor.source.description??t.armor.source.notes??t.armor.source.raw??t.armor.match.name})),t.equipment.forEach(i=>{if(!i.match)return;const r=i.quantityHint??Tt(i.source),a={name:i.source};typeof r=="number"&&(a.amount=r),n(H(i.match,a))});const s={};return e.forEach((i,r)=>{const a=`ITEM_${r+1}`;s[a]={id:a,...i}}),{items:s,armorZones:{},purse:{d:"0",s:"0",h:"0",k:"0"}}}function Tt(t){const e=t.match(/\((\d+)\s*(?:m|meter|metern|schritte?|schritt)\s*\)$/i);if(e?.[1]){const n=Number.parseInt(e[1],10);return Number.isNaN(n)?void 0:n}}function H(t,e={}){const n=t.base??{},s=n.special??{},i={template:t.id,amount:1,name:t.name,isTemplateLocked:!0,...e};for(const[o,c]of Object.entries(n))o==="special"||o==="id"||c===void 0||(i[o]=c);const r={};for(const[o,c]of Object.entries(s??{}))if(c!=null)switch(o){case"protection":i.pro=c;break;case"encumbrance":i.enc=c;break;case"closeRange":r.close=Number(c);break;case"mediumRange":r.medium=Number(c);break;case"farRange":r.far=Number(c);break;default:i[o]=c;break}const a=[r.close,r.medium,r.far].filter(o=>typeof o=="number"&&Number.isFinite(o));return a.length>0&&(i.range=a),e.name?i.name=e.name:i.name=t.name,e.amount&&(i.amount=e.amount),i}function wt(){return`H_${Math.floor(1+Math.random()*9e9)}`}const yt={"schlechte eigenschaften":"Schlechte Eigenschaft","schlechte eigenschaft":"Schlechte Eigenschaft",dammerungssicht:"Dunkelsicht",dammersicht:"Dunkelsicht",dunkesicht:"Dunkelsicht",verpflichtung:"Verpflichtungen",personlichkeitsschwache:"Persönlichkeitsschwächen",personlichkeitsschwachen:"Persönlichkeitsschwächen"},It=/[,:;]+$/,Lt={peitsche:"fuhrmannspeitsche",speer:"speer",schwert:"langschwert",langschild:"gro schild",schild:"holzschild",dolch:"dolch",krummsabel:"sabel",krummsaebel:"sabel",platte:"plattenrustung",dietrichsets:"dietrich",dietrichset:"dietrich",seil:"kletterseil pro schritt"},St={phexkirche:"Moralkodex der Phexkirche",hesindekirche:"Moralkodex der Hesindekirche",perainekirche:"Moralkodex der Perainekirche",boronkirche:"Moralkodex der Boronkirche",praioskirche:"Moralkodex der Praioskirche",rondrakirche:"Moralkodex der Rondrakirche",efferdkirche:"Moralkodex der Efferdkirche",traviakirche:"Moralkodex der Traviakirche",firunkirche:"Moralkodex der Firunkirche",tsakirche:"Moralkodex der Tsakirche",ingerimmkirche:"Moralkodex der Ingerimmkirche",rahjakirche:"Moralkodex der Rahjakirche",aveskirche:"Moralkodex der Aveskirche",ifirnkirche:"Moralkodex der Ifirnkirche",korkirche:"Moralkodex der Korkirche",nanduskirche:"Moralkodex der Nanduskirche",swafnirkirche:"Moralkodex der Swafnirkirche"},Nt={tempel:"Geweihter gegenüber seinem Tempel",kirche:"Geweihter gegenüber seiner Kirche","geweihter gegenüber seinem tempel":"Geweihter gegenüber seinem Tempel","geweihter gegenüber seiner kirche":"Geweihter gegenüber seiner Kirche","magier gegenüber seinem lehrmeister":"Magier gegenüber seinem Lehrmeister","magier gegenüber seiner akademie":"Magier gegenüber seiner Akademie","magier gegenüber seiner gilde":"Magier gegenüber seiner Gilde"},$t={toten:"Toten und Untoten",tote:"Toten und Untoten","toten und untoten":"Toten und Untoten",untoten:"Toten und Untoten"},zt={isdira:"Isdira- und Asdharia-Zeichen",asdharia:"Isdira- und Asdharia-Zeichen","isdira und asdharia zeichen":"Isdira- und Asdharia-Zeichen","isdiraund asdharia zeichen":"Isdira- und Asdharia-Zeichen",rogolan:"Rogolan-Runen"},Rt={oloargh:"oloarkh"},_t={"shakara hammer":"kriegshammer","shakara-hammer":"kriegshammer","shakagra hammer":"kriegshammer"},Mt=new Set(["specialAbilities","combatSpecialAbilities"]),Ct=new Set(["schlechte eigenschaft","schlechte eigenschaften","schlechte angewohnheit","schlechte angewohnheiten"]),Dt="belastungsgewohnung",Ot=["Arroganz","Eitelkeit","Neid","Streitsucht","Unheimlich","Verwöhnt","Vorurteile","Weltfremd","Anzügliches Verhalten","Eifersucht","Busenkomplexe","Peniskomplexe","Stimmungsschwankungen"],Pt=new Set(["ein","eine","einen","einem","einer","eins","zwei","drei","vier","fünf","sechs","sieben","acht","neun","zehn","elf","zwölf"].map(t=>t.toLowerCase())),Vt=/^(\d+)\s+(schritte?|schritt|meter|metern|m)\b\s*(.*)$/iu,Kt={lebensmittelverarbeitung:"Lebensmittelbearbeitung"};let M=null;function qt(t,e){const n=M;M=zn(e.citationPattern);try{const s={lookups:e,warnings:[],unresolved:new Map,warningKeys:new Set},i=hn(t,e),r=new Set(i.languages),a=new Set,o=be([...t.specialAbilities,...fn(t.notes)],r,a,e),c=be(t.combatSpecialAbilities,r,a,e),u=C(i.advantages,"advantages",s.lookups.advantages,s),l=C(i.disadvantages,"disadvantages",s.lookups.disadvantages,s),m=C(o,"specialAbilities",s.lookups.specialAbilities,s),f=C(c,"combatSpecialAbilities",s.lookups.specialAbilities,s),b=[...t.languages,...r],A=[...t.scripts,...a],h=jt(b,s),d=Ht(A,s),g=Ut(t.talents,s),p=B(t.spells,"spells",s.lookups.spells,s),T=C(t.cantrips,"cantrips",s.lookups.cantrips,s),$=B(t.liturgies,"liturgies",s.lookups.liturgies,s),q=B(t.rituals,"rituals",s.lookups.spells,s),v=C(t.blessings,"blessings",s.lookups.blessings,s),L=C(t.equipment,"equipment",s.lookups.equipment,s),E=Ft(m),P=Wt(t.weapons,s),O=Gt(t.armor??null,s,E),ze={};for(const[z,Li]of s.unresolved.entries())ze[z]=Array.from(Li.values());const Ti=u.some(z=>z.match?.normalizedName==="zauberer"||z.normalizedSource==="zauberer"),wi=typeof t.pools.asp=="number"&&t.pools.asp>0,Re=m.some(z=>z.match?.normalizedName?.startsWith("tradition"));(Ti||wi)&&!Re&&w({type:"unresolved",section:"specialAbilities",value:"Tradition",message:"Statblock weist AsP/Zauberer auf, aber keine Tradition. Bitte Tradition manuell ergänzen."},s);const yi=typeof t.pools.kap=="number"&&t.pools.kap>0,Ii=u.some(z=>z.match?.normalizedName==="geweihter"||z.normalizedSource==="geweihter");return yi&&!Re&&!Ii&&w({type:"unresolved",section:"specialAbilities",value:"Tradition",message:"Statblock weist KaP auf, aber keine geweihte Tradition oder Geweihter-Vorteil. Bitte Tradition manuell ergänzen."},s),{name:t.name,advantages:u,disadvantages:l,specialAbilities:m,combatSpecialAbilities:f,languages:h,scripts:d,talents:g,spells:p,cantrips:T,liturgies:$,rituals:q,blessings:v,equipment:L,weapons:P,armor:O,unresolved:ze,warnings:s.warnings}}finally{M=n}}function C(t,e,n,s){const i=[];for(const c of t){const u=_(c);u&&i.push(u)}const r=e==="blessings"?tn(i,n):i,a=[],o=(c,u)=>{const l=ge(c);let m=k(l.baseName),f=n.byName.get(m),b,A,h,d;if(!f&&l.options.length>0)for(const p of l.options){const T=`${l.baseName} (${p})`,$=k(T),q=n.byName.get($);if(q){f=q,m=$,b=p;break}}if(f&&on(f)&&l.options.length>0)for(const p of l.options){const T=an(f,p);if(T){A=T,d=T.name;break}h||(h=p)}else l.options.length>0&&(d=b??l.options[0]);if(!d&&l.options.length>0&&(d=b??l.options[0]),!d&&b&&(d=b),f&&f.normalizedName==="begabung"&&l.options.length>0){const p=l.options[0],T=Bt(p,s);T?(h=T.name,d=d??T.name):h=p}if(!f&&e==="equipment"){const p=me(c,"equipment",s,l.options);p&&(f=p)}let g=Zt(l.baseName,l.level,d);if(e==="equipment"&&l.quantityToken&&(g=`${g} ${l.quantityToken}`.trim()),!f&&e==="blessings"&&fe(g)){a.push({source:g,normalizedSource:m,match:void 0,selectOption:A,level:l.level??void 0,rawOption:h});return}if(!f&&u&&Mt.has(e)){const p=Ae(c);if(p.parts.length>1){p.usedOrConnector&&w({type:"split",section:e,value:c,message:`Eintrag "${c}" enthielt "oder"; alle Varianten wurden übernommen.`},s),p.parts.forEach(T=>o(T,!1));return}}f||R(e,g,s),a.push({source:g,normalizedSource:m,match:f,selectOption:A,level:l.level??void 0,rawOption:h,quantityHint:l.quantity})};return r.forEach(c=>o(c,!0)),a}function B(t,e,n,s){const i=[];for(const r of t){const a=_(r.name);if(!a){R(e,r.name,s);continue}const o=k(a),c=n.byName.get(o);c||R(e,a,s),i.push({source:a,normalizedSource:o,match:c,value:r.value})}return i}function Ut(t,e){return t.map(n=>{const{baseName:s}=xt(n.name),i=k(s),r=Kt[i],a=r?k(r):i;let o=e.lookups.skills.byName.get(a)??e.lookups.skills.byName.get(i);if(!o){const c=mn(i,e.lookups.skills.byName,1);c?(o=c.entry,w({type:"fuzzy-match",section:"talents",value:n.name,message:`Talent "${n.name}" wurde als "${o.name}" interpretiert (Schreibweise korrigiert).`},e)):R("talents",n.name,e)}return{source:n,match:o}})}function xt(t){const e=t.trim(),n=e.match(/^(.*?)(?:\s*\(([^)]+)\))$/u);return n&&n[1]?{baseName:n[1].trim(),application:n[2]?.trim()}:{baseName:e}}function Ft(t){let e=0;for(const n of t){if(n.match?.normalizedName!==Dt)continue;const s=n.level??1;s>e&&(e=s)}return e}function Wt(t,e){const n=[];for(const s of t){const i=_(s.name),r=k(i.length>0?i:s.name),a=s.category==="unarmed"||r==="waffenlos",o=_t[r]??r;let c=o.length>0?e.lookups.equipment.byName.get(o):void 0,u,l;if(c||(c=me(s.name,"weapons",e)),!c&&a&&(l="unarmed",u=e.lookups.combatTechniques.byId.get("CT_9"),u||w({type:"unresolved",section:"combatTechniques",value:"CT_9",message:"Kampftechnik Raufen (CT_9) konnte nicht geladen werden."},e)),c){const m=sn(c);m?(u=e.lookups.combatTechniques.byId.get(m),u||w({type:"unresolved",section:"combatTechniques",value:m,message:`Kampftechnik-ID "${m}" fehlt im Datensatz (für ${s.name}).`},e)):l||w({type:"unresolved",section:"weapons",value:s.name,message:`Waffe "${s.name}" enthält keine Kampftechnik im Datensatz.`},e)}!c&&!l&&R("weapons",s.name,e),n.push({source:s,normalizedSource:r,match:c,combatTechnique:u,fallback:l})}return n}function Gt(t,e,n){if(!t)return null;const i=(t.description??"").trim(),r=i.toLowerCase(),a=(t.notes??"").toLowerCase(),o=r.includes("keine")||r.includes("ohne"),c=(t.rs??0)>0||(t.be??0)>0||i.length>0,u=i.length===0||r.includes("natürlicher rüstungsschutz")||a.includes("natürlicher rüstungsschutz"),l=(t.rs??0)===0&&(t.be??0)===0&&/kleidung|gewand|robe|tracht/.test(r);if(!c||(t.rs??0)===0&&(t.be??0)===0&&o||l)return null;let m=i;i&&r.includes("normale kleidung")&&r.includes("oder nackt")&&(m="normale Kleidung");const f=_(m),b=f.length>0?k(f):void 0,A=b?e.lookups.equipment.byName.get(b):void 0;let h,d;if(A){const g=rn(A);if(h=g?.protection,d=g?.encumbrance,g||w({type:"unresolved",section:"armor",value:A.name,message:`Rüstung "${A.name}" enthält keine RS/BE-Daten im Optolith-Katalog.`},e),typeof t.rs=="number"&&typeof h=="number"&&t.rs!==h&&w({type:"value-mismatch",section:"armor",value:i||A.name,message:`RS (${t.rs}) weicht vom Optolith-Wert (${h}) ab.`},e),typeof t.be=="number"&&typeof d=="number"&&t.be!==d){const p=n*2;n>0&&t.be<d&&d-t.be<=p||w({type:"value-mismatch",section:"armor",value:i||A.name,message:`BE (${t.be}) weicht vom Optolith-Wert (${d}) ab.`},e)}}else{const g=i||`RS ${t.rs??"-"} / BE ${t.be??"-"}`;if(u){const p=i.length>0?i:`RS ${t.rs??"-"} / BE ${t.be??"-"}`,T=i.length>0?i:`RS ${t.rs??"-"} / BE ${t.be??"-"}`;w({type:"fuzzy-match",section:"armor",value:p,message:`Eintrag "${T}" ohne Rüstungsbeschreibung; vermutlich natürlicher Rüstungsschutz.`},e)}else R("armor",g,e)}return{source:t,normalizedSource:b,match:A,datasetProtection:h??null,datasetEncumbrance:d??null,isNaturalArmor:!A&&u}}function jt(t,e){return t.map(n=>_(n)).filter(n=>n.length>0).map(n=>{const s=ue(n),i=k(s.baseName),r=Rt[i]??i,a=e.lookups.languages.get(r);return a?(s.level&&a.maxLevel&&s.level>a.maxLevel&&w({type:"level-out-of-range",section:"languages",value:n,message:`Sprachstufe ${s.level} überschreitet den erlaubten Bereich (${a.maxLevel}).`},e),{source:n,normalizedSource:i,match:a.ability,option:a,level:s.level??void 0}):(R("languages",n,e),{source:n,normalizedSource:i,rawOption:s.baseName})})}function Ht(t,e){return t.map(n=>_(n)).filter(n=>n.length>0).map(n=>{const s=ue(n),i=k(s.baseName),r=zt[i],a=e.lookups.scripts.get(i)??(r?e.lookups.scripts.get(k(r)):void 0);return a?{source:n,normalizedSource:i,match:a.ability,option:a,level:s.level??void 0}:(R("scripts",n,e),{source:n,normalizedSource:i,rawOption:s.baseName})})}function ue(t){const e=t.trim(),n=e.match(/^(.*?)(?:\s+([IVX\d]+(?:\+[IVX\d]+)*))?$/i);if(!n)return{baseName:e};const s=(n[1]??e).trim(),i=n[2]?.trim();if(!i)return{baseName:s};const r=U(i);return{baseName:s,level:r??void 0}}function Bt(t,e){const n=k(t),s=e.lookups.skills.byName.get(n)??e.lookups.spells.byName.get(n)??e.lookups.liturgies.byName.get(n);if(s)return{id:s.id,name:s.name}}function Xt(t){const e={I:1,V:5,X:10},n=t.toUpperCase().split("");let s=0,i=0;for(const r of n.reverse()){const a=e[r];if(!a)return null;a<i?s-=a:(s+=a,i=a)}return s}function V(t){const e=[[10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]];let n=t,s="";for(const[i,r]of e)for(;n>=i;)s+=r,n-=i;return s||"I"}function Zt(t,e,n){const s=t.trim(),i=e?`${s} ${V(e)}`.trim():s;return n&&n.trim().length>0?`${i} (${n.trim()})`.trim():i}function U(t){const e=t.split("+").map(s=>s.trim()).filter(s=>s.length>0);if(e.length===0)return;const n=e.map(s=>{const i=Number.parseInt(s,10);return Number.isNaN(i)?Xt(s)??void 0:i}).filter(s=>s!==void 0);if(n.length!==0)return Math.max(...n)}function R(t,e,n){n.unresolved.has(t)||n.unresolved.set(t,new Set),n.unresolved.get(t).add(e)}function w(t,e){const n=`${t.type}:${t.section}:${t.value}:${t.message}`;e.warningKeys.has(n)||(e.warningKeys.add(n),e.warnings.push(t))}function me(t,e,n,s=[]){const i=Yt(t,n.lookups.equipment,s);if(!i)return;const r=en(e,t,i.match.name,i);return w({type:"fuzzy-match",section:e,value:t,message:r},n),i.match}function Yt(t,e,n){const s=k(t),i=Qt(t,n);for(const r of i){const a=k(r);if(!a||a===s)continue;const o=e.byName.get(a);if(o)return{match:o,token:r,reason:"token"}}for(const r of i){const a=k(r);if(a){for(const[o,c]of Object.entries(Lt))if(a===o||a.includes(o)){const u=e.byName.get(c);if(u)return{match:u,token:r,reason:"keyword",keyword:o}}}}}function Qt(t,e){const n=new Set,s=r=>{if(!r)return;const a=r.trim();if(a.length===0)return;const o=pe(he(a));de(n,o),o!==a&&de(n,a)};s(t);const i=t.replace(/[()]/g," ");return i.split(/[-–—\/]/).forEach(r=>{s(r),r.split(/[,&]/).forEach(a=>s(a))}),i.split(/[,&]/).forEach(r=>s(r)),i.split(/\s+/).forEach(r=>s(r)),e.forEach(r=>s(r)),Array.from(n.values())}function de(t,e){if(e){t.has(e)||t.add(e);for(const n of Jt(e))n.length>0&&t.add(n)}}function Jt(t){const e=new Set,n=t.trim(),s=n.toLowerCase();if(s.length<=2)return[];const i=a=>{a&&a!==n&&e.add(a)},r=(a,o="")=>{s.endsWith(a)&&n.length>a.length+1&&i(n.slice(0,n.length-a.length)+o)};return r("en"),r("en","e"),r("e"),r("er"),r("n"),r("s"),Array.from(e.values())}function en(t,e,n,s){const i=t==="weapons"?"Waffe":"Ausrüstungseintrag";if(s.reason==="keyword"){const r=s.keyword??s.token;return`${i} "${e}" wurde als "${n}" interpretiert (Schlüsselwort "${r}").`}return`${i} "${e}" wurde als "${n}" interpretiert (Teilbegriff "${s.token}").`}function fe(t){const e=k(t);return e==="die zwolf segnungen"||e==="zwolf segnungen"||e==="12 segnungen"}function tn(t,e){const n=[],s=e.byId?Array.from(e.byId.values()):[];for(const i of t)fe(i)&&s.length>0?s.forEach(r=>{n.push(nn(r))}):n.push(i);return n}function nn(t){const e=t.locale,n=e&&typeof e.name=="string"?String(e.name):null;return n&&n.length>0?n:t.name&&t.name.length>0?t.name:t.id}function sn(t){const e=t.base;if(!e||typeof e!="object")return;const n=e.special;if(!n||typeof n!="object")return;const s=n.combatTechnique;return typeof s=="string"?s:void 0}function rn(t){const e=t.base;if(!e||typeof e!="object")return;const n=e.special;if(!n||typeof n!="object")return;const s=n.protection,i=n.encumbrance;if(!(typeof s!="number"&&typeof i!="number"))return{protection:typeof s=="number"?s:null,encumbrance:typeof i=="number"?i:null}}function an(t,e){const n=t.locale,s=Array.isArray(n?.selectOptions)?n.selectOptions:[],i=k(e);for(const r of s){if(typeof r?.name!="string"||typeof r?.id!="number")continue;if(k(r.name)===i)return{id:r.id,name:r.name}}}function on(t){const e=t.locale;return Array.isArray(e?.selectOptions)&&e.selectOptions.length>0}function _(t){if(!t)return t;const r=cn(t).replace(/\(\s*\)/g,"").replace(/\s*\+\s*/g,"+").replace(/\s+/g," ").trim().replace(It,"").trim();return un(ln(r))}function cn(t){if(!M)return t;M.lastIndex=0;const e=t.replace(M," ");return M.lastIndex=0,e}function ln(t){return t.replace(/(Tradition\s*\()([^)]*?)geweih(?:ter|te|ten)(\))/gi,(e,n,s,i)=>{const r=s.trim().replace(/[-\s]+$/g,"");if(!r)return`${n}${s}${i}`;const a=`${r}kirche`;return`${n}${a}${i}`})}function un(t){const e={analys:"Analys Arkanstruktur",odem:"Odem Arcanum",zauberklinge:"Zauberklinge Geisterspeer"},n=k(t);return e[n]??t}function he(t){const e=t.trim(),n=e.match(Vt);if(n&&n[3])return n[3].trim();const s=e.match(/^(\d+)\s+(.*)$/u);if(s&&s[2])return s[2].trim();const i=e.match(/^([A-Za-zÄÖÜäöüß]+)\s+(.*)$/u);if(i&&i[2]){const r=i[1]?.toLowerCase();if(r&&Pt.has(r))return i[2].trim()}return e}function pe(t){return t.replace(/\(\s*(?:x\s*)?\d+\s*\)\s*$/iu,"").replace(/\(\s*\d+\s*(?:m|meter|metern|schritte?|schritt)\s*\)\s*$/iu,"").trim()}function ge(t){let e=t.trim();const n=e.match(/\((\d+)\s*(m|meter|metern|schritte?|schritt)\s*\)\s*$/iu);let s,i;if(n?.[0]){s=n[0].trim();const u=n[1];if(u){const l=Number.parseInt(u,10);i=Number.isNaN(l)?void 0:l}}e=pe(he(e)),e=e.replace(/([IVX]+)\s*-\s*([IVX]+)/gi,"$1+$2");let r;const a=[],o=()=>{const u=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);u&&(r=u[1]?.trim(),e=e.slice(0,u.index).trim())};for(o();;){const u=e.match(/\(([^)]+)\)\s*$/);if(!u)break;const l=u[1]?.trim();if(l){const m=l.split(/[,;]/).map(f=>f.trim()).filter(f=>f.length>0);if(m.length===0)a.unshift(l);else for(let f=m.length-1;f>=0;f-=1){const b=m[f];b&&a.unshift(b)}}e=e.slice(0,u.index).trim()}r||o();const c=r?U(r):void 0;return{baseName:e,options:a,level:c??void 0,quantity:i,quantityToken:s}}function mn(t,e,n){let s;for(const[i,r]of e.entries()){if(Math.abs(i.length-t.length)>n)continue;const a=dn(i,t,n);if(a!==void 0&&(!s||a<s.distance)&&(s={entry:r,normalized:i,distance:a},a===0))return s}return s}function dn(t,e,n){const s=t.length,i=e.length;if(Math.abs(s-i)>n)return;if(s===0)return i<=n?i:void 0;if(i===0)return s<=n?s:void 0;const r=Array.from({length:i+1},(c,u)=>u),a=new Array(i+1);for(let c=1;c<=s;c+=1){a[0]=c;let u=a[0];const l=t.charAt(c-1);for(let m=1;m<=i;m+=1){const f=l===e.charAt(m-1)?0:1;a[m]=Math.min(r[m]+1,a[m-1]+1,r[m-1]+f),u=Math.min(u,a[m])}if(u>n)return;r.splice(0,r.length,...a)}const o=r[i];return o<=n?o:void 0}function be(t,e,n,s){const i=[];for(const r of t){const a=_(r);if(/^muttersprache\b/i.test(a)){e.add(ke(a));continue}const o=ge(a),c=k(o.baseName);if(s.languages.get(c)){o.level!==void 0?e.add(`${o.baseName} ${V(o.level)}`):e.add(o.baseName);continue}if(s.scripts.get(c)){n.add(o.baseName);continue}i.push(r)}return i}function fn(t){const e=new Set;for(const n of Object.values(t)){if(!n)continue;const s=n.split(/;+/);for(const i of s){const r=i.trim();if(!r)continue;const a=r.match(/^Paktgeschenke?:\s*(.+)$/i);if(a){const o=a[1]?.trim();o&&e.add(o)}}}return Array.from(e)}function hn(t,e){const n=new Set,s=new Set,i=new Set,r=(a,o)=>{const c=_(a);if(!c)return;if(/^muttersprache\b/i.test(c)){const l=ke(c);i.add(l);return}const u=pn(c);for(const l of u){const m=wn(l),f=k(m.baseLabel),b=In(m.baseLabel,m.detail);for(const A of b){const h=yn(m.baseLabel,m.level,A);(()=>{let g=e.advantages.byName.get(f),p=e.disadvantages.byName.get(f);if(!g&&!p&&A){const $=k(`${m.baseLabel} (${A})`);g=e.advantages.byName.get($),p=e.disadvantages.byName.get($)}if(g&&!p){n.add(h);return}if(p&&!g){s.add(h);return}if(g&&p){o==="advantage"?n.add(h):s.add(h);return}const T=$n(h);if(T==="advantage"){n.add(h);return}if(T==="disadvantage"){s.add(h);return}o==="advantage"?n.add(h):s.add(h)})()}}};for(const a of t.advantages)r(a,"advantage");for(const a of t.disadvantages)r(a,"disadvantage");return{advantages:Array.from(n),disadvantages:Array.from(s),languages:Array.from(i)}}function pn(t){let e=An(t);e=e.flatMap(En),e=e.flatMap(Tn),e=e.flatMap(s=>Ae(s).parts);const n=[];for(const s of e){const i=bn(s);if(i){n.push(i);continue}n.push(gn(s))}return Array.from(new Set(n))}function gn(t){const e=t.match(/^Immunität gegen\s+([^()]+)$/i);if(e&&e[1]){const n=e[1].trim();if(n.length>0)return`Immunität gegen (${n})`}return t}function bn(t){if(/^persönlichkeitsschwäche\b/i.test(t))return t.replace(/^persönlichkeitsschwäche/i,"Persönlichkeitsschwächen");if(/^persönlichkeitsschwächen\b/i.test(t))return t;const e=t.trim();if(!e)return;const n=e.toLowerCase();for(const s of Ot){const i=s.toLowerCase();if(n===i||n.startsWith(`${i} `))return`Persönlichkeitsschwächen (${e})`}}function An(t){const e=t.trim(),n=e.match(/^Angst vor\b(.*)$/i);if(!n)return[e];const s=n[1]?.trim()??"";if(!s)return["Angst vor"];let i=s;if(i.startsWith("(")&&i.endsWith(")"))i=i.slice(1,-1).trim();else{const a=i.match(/\(([^)]+)\)/);a&&a[1]?i=a[1].trim():i=i.trim()}if(i=i.replace(/^…\s*/u,""),!i)return["Angst vor"];const r=i.split(/[,;/]/).map(a=>a.trim().replace(/^…\s*/u,"").replace(/^\(+/u,"").replace(/\)+$/u,"").trim()).filter(a=>a.length>0);return r.length===0?[`Angst vor (${i})`]:r.map(a=>{const{detail:o,level:c}=kn(a),u=vn(o),l=c?` ${c}`:"";return`Angst vor (${u})${l}`.trim()})}function kn(t){const e=t.match(/\s+([IVX\d]+)$/i);return e?.[1]?{detail:t.slice(0,e.index).trim(),level:e[1].trim()}:{detail:t.trim()}}function vn(t){const e=t.toLowerCase();return $t[e]??t}function En(t){const e=t.match(/^Prinzipientreue(?:\s+([IVX\d]+))?\s*(?:\(([^)]+)\))?/i)??[],[,n,s]=e;if(!s)return[t];const i=s.trim().toLowerCase(),r=St[i];if(!r)return[t];const a=n?` ${n.trim()}`:"";return[`Prinzipientreue (${r})${a}`.trim()]}function Tn(t){const e=t.match(/^Verpflichtungen(?:\s+([IVX\d]+))?\s*(?:\(([^)]+)\))?/i)??[],[,n,s]=e;if(!s)return[t];const i=s.split(/[,;]/).map(a=>a.trim()).filter(a=>a.length>0);if(i.length===0)return[t];const r=n?` ${n.trim()}`:"";return i.map(a=>{const o=a.toLowerCase();return`Verpflichtungen (${Nt[o]??a})${r}`.trim()})}function Ae(t){if(!/\b(?:und|oder|bzw\.)\b/i.test(t)&&!t.includes("/"))return{parts:[t],usedOrConnector:!1};const n=t.replace(/\//g," / ").split(/\s+/),s=new Set(["und","oder","bzw.","bzw","/"]),i=[];let r="",a=0,o=!1;const c=()=>{const u=r.trim();u.length>0&&i.push(u),r=""};for(const u of n){if(!u)continue;const l=u.toLowerCase(),m=(u.match(/\(/g)??[]).length,f=(u.match(/\)/g)??[]).length;a===0&&s.has(l)?((l==="oder"||l==="bzw."||l==="bzw"||l==="/")&&(o=!0),c()):(r.length>0&&(r+=" "),r+=u),a=Math.max(0,a+m-f)}return c(),i.length<=1?{parts:[t],usedOrConnector:!1}:{parts:i,usedOrConnector:o}}function wn(t){let e=t.trim();e=e.replace(/([IVX]+)\s*-\s*([IVX]+)/gi,"$1+$2");const n=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);let s;n&&(s=n[1],e=e.slice(0,n.index).trim());let i;const r=e.match(/^Angst vor\s+(.+)$/i);if(r){const l=r[1]?.trim();l&&!l.startsWith("(")&&(i=l,e="Angst vor")}const a=e.match(/\s*\(([^)]+)\)\s*$/);if(a&&(i=a[1],e=e.slice(0,a.index).trim()),!s){const l=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);l&&(s=l[1],e=e.slice(0,l.index).trim())}const o=Ln(e);let c=o;const u=s?U(s):void 0;return u&&(c=`${c} ${V(u)}`.trim()),i&&(c=`${c} (${i})`.trim()),{label:c,baseLabel:o,detail:i,level:u}}function yn(t,e,n){let s=t;return e&&(s=`${s} ${V(e)}`.trim()),n&&(s=`${s} (${n})`.trim()),s}function In(t,e){if(!e)return[void 0];const n=k(t);if(!Ct.has(n))return[e];const s=e.split(/[,;/]/).flatMap(i=>i.split(/\b(?:und|oder)\b/i).map(r=>r.trim())).map(i=>i.replace(/^\(+|\)+$/g,"").trim()).filter(i=>i.length>0);return s.length>1?s:[e]}function ke(t){let e=t.replace(/^muttersprache/i,"").trim();if(!e)return"Garethi III";const n=e.match(/([IVX\d]+)$/i);let s;n&&(s=n[1],e=e.slice(0,n.index).trim());const i=U(s??"III")??3;return`${e} ${V(i)}`.trim()}function Ln(t){const e=k(t);return yt[e]??t}const Sn=["beidhändig","dunkelsicht","richtungssinn","entfernungssinn","zauberer","zäher hund","blutrausch","herausragender sinn","giftresistenz"],Nn=["schlechte eigenschaft","eingeschränkter sinn","angst vor","blind","kälteempfindlich","zauberanfällig"];function $n(t){const e=k(t);return Sn.some(n=>e.includes(n))?"advantage":Nn.some(n=>e.includes(n))?"disadvantage":"unknown"}function zn(t){return t?new RegExp(t.source,t.flags):null}const Rn=/^(MU|KL|IN|CH|FF|GE|KO|KK)(\s+\d{1,2})\s+(MU|KL|IN|CH|FF|GE|KO|KK)/,ve=/([A-Za-zÄÖÜäöüß/+\-]+)\s+([^\s]+)/g,Ee=/^([A-Za-zÄÖÜäöüß0-9\s/+\-&]+):\s*(.*)$/,_n=["MU","KL","IN","CH","FF","GE","KO","KK"],Mn={vorteile:"advantages",nachteile:"disadvantages",sonderfertigkeiten:"specialAbilities",kampfsonderfertigkeiten:"combatSpecialAbilities",kampfsonderfertigkeit:"combatSpecialAbilities",sprachen:"languages",schriften:"scripts",talente:"talents",rsbe:"armor",aktionen:"actions",liturgien:"liturgies",liturgie:"liturgies",zauber:"spells",zaubersprüche:"spells",zaubertricks:"cantrips",rituale:"rituals",rituellezauber:"rituals",ausrüstung:"equipment",gegenstände:"equipment",inventar:"equipment",segnungen:"blessings",kampftechniken:"combatTechniques",kampfverhalten:"notes",kampfverhaltenundflucht:"notes",flucht:"notes",schmerz:"notes","vorteile/nachteile":"advantages-disadvantages",vorteilenachteile:"advantages-disadvantages"},Cn={sinesschärfe:"Sinnesschärfe","angriff verbessern":"Attacke verbessern",schnelladen:"Schnellladen",eigne:"Eigene","schlechte eigenschaften":"Schlechte Eigenschaft"},Dn={MU:"Mut",KL:"Klugheit",IN:"Intuition",CH:"Charisma",FF:"Fingerfertigkeit",GE:"Gewandheit",KO:"Konstitution",KK:"Körperkraft"},On=new Set(["ein","eine","einen","einem","einer","eins","zwei","drei","vier","fünf","sechs","sieben","acht","neun","zehn","elf","zwölf"].map(t=>t.toLowerCase())),X=["körper","körperlich","gesellschaft","natur","wissen","handwerk","sprachen","sprachlich"],Pn=new RegExp(`^(?:${X.join("|")})\\s*:\\s*`,"i"),Vn=new RegExp(`\\b(${X.join("|")})\\s*:\\s*`,"gi"),Kn=/^(\d+)\s+(schritte?|schritt|meter|metern|m)\b\s*(.*)$/iu,qn={dietrichset:"Dietrich",dietrichsets:"Dietrich",dietrich:"Dietrich",seil:"Kletterseil, pro Schritt","leichte shakagra platte":"Leichte Shakagra-Plattenrüstung","shakara-hammer":"Kriegshammer"},Un=/[•●◦‣∙]/g,xn=new Set(["und","oder","bzw","talente","talent","liturgien","rituale","sprach"]);function Fn(t){const e=[],n=Wn(t),s=n.split(`
`).map(v=>v.trim()).filter(v=>v.length>0);if(s.length===0)return{model:ki(),warnings:[{type:"parse-error",message:"Eingabetext ist leer."}],normalizedSource:n};const i=[...s],r=i.shift()??"Unbekannt",a=[];for(;i.length>0;){const v=i[0];if(!v||!Rn.test(v))break;a.push(i.shift())}const o=Gn(a.join(" "),e),c={},u=i[0];u?.startsWith("LeP")?(Z(u,c),i.shift()):e.push({type:"missing-section",section:"resources",message:"LeP/AsP/KaP-Zeile nicht gefunden."});const l=i[0];l?.startsWith("AW")&&(Z(l,c),i.shift()),jn(i,c);const m=[];let f=0;for(;f<i.length;){const v=i[f];if(v&&Te(v)){const L=[v];for(i.splice(f,1);f<i.length&&Hn(i[f]);){const O=i[f];if(!O)break;L.push(O),i.splice(f,1)}const E=L.join(" ").replace(/\s+/g," ").trim(),P=Xn(E,e);P&&m.push(P);continue}f+=1}const b=[...i];for(let v=0;v<b.length;v+=1){const L=b[v];if(L&&/^RS\s*\/\s*BE\b/i.test(L)&&!/^RS\s*\/\s*BE\s*:/i.test(L)){const E=L.replace(/^RS\s*\/\s*BE\s*/i,"").trim();b[v]=`RS/BE: ${E}`}}const{sections:A,extras:h}=Yn(b),d={combatTechniques:[],scripts:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],talents:[],spells:[],cantrips:[],liturgies:[],rituals:[],blessings:[],equipment:[]},g=new Set,p={};let T=null,$;for(const v of A){const L=Qn(v.heading),E=K(v.content);if(!L){p[v.heading]=E;continue}switch(g.add(L),L){case"advantages":y(d.advantages,E);break;case"disadvantages":y(d.disadvantages,E);break;case"advantages-disadvantages":g.add("advantages"),g.add("disadvantages"),E.toLowerCase()!=="keine"&&ci(d,E);break;case"specialAbilities":{const{primary:P,trailing:O}=gi(E,"Talente:");we(d.specialAbilities,P),O&&(g.add("talents"),ye(d.talents,O));break}case"combatSpecialAbilities":we(d.combatSpecialAbilities,E);break;case"scripts":y(d.scripts,E);break;case"combatTechniques":y(d.combatTechniques,E);break;case"languages":y(d.languages,E);break;case"talents":ye(d.talents,E);break;case"spells":y(d.spells,E);break;case"cantrips":y(d.cantrips,E);break;case"liturgies":y(d.liturgies,E);break;case"rituals":y(d.rituals,E);break;case"blessings":y(d.blessings,E);break;case"equipment":y(d.equipment,E);break;case"armor":T=Bn(E,e);break;case"actions":$=D(E);break;case"notes":default:p[v.heading]=E;break}}Le(d.specialAbilities,d.languages,d.scripts),Le(d.combatSpecialAbilities,d.languages,d.scripts),d.talents.length>0&&g.add("talents");for(const v of["advantages","disadvantages","specialAbilities","talents"])g.has(v)||e.push({type:"missing-section",section:v,message:`Abschnitt "${v}" nicht gefunden.`});return{model:{name:r,attributes:o,pools:c,armor:T,actions:$??null,weapons:m,combatTechniques:W(d.combatTechniques,"combatTechniques",e),advantages:N(d.advantages),disadvantages:N(d.disadvantages),specialAbilities:N(d.specialAbilities),combatSpecialAbilities:N(d.combatSpecialAbilities),languages:N(d.languages),scripts:N(d.scripts),spells:W(d.spells,"spells",e),cantrips:N(d.cantrips),liturgies:W(d.liturgies,"liturgies",e),rituals:W(d.rituals,"rituals",e),blessings:N(d.blessings),equipment:ri(d.equipment),talents:bi(d.talents,e),notes:p,extras:h},warnings:e,normalizedSource:n}}function Wn(t){let e=t.replace(/\r\n/g,`
`).replace(/\t/g," ");return e=e.replace(/([A-Za-zÄÖÜäöüß])-\s*\n\s*([A-Za-zÄÖÜäöüß])/g,"$1$2"),e=e.replace(/–/g,"-"),e=e.split(`
`).map(n=>n.trimEnd()).join(`
`),e.trim()}function Gn(t,e){const n={};if(!t)return e.push({type:"missing-section",section:"attributes",message:"Eigenschaftszeilen nicht gefunden."}),n;const s=/(MU|KL|IN|CH|FF|GE|KO|KK)\s+(\d{1,2})/g;let i;for(;(i=s.exec(t))!==null;){const r=i[1],a=i[2];if(!r||!a)continue;const o=r,c=Number.parseInt(a,10);n[o]=Number.isNaN(c)?void 0:c}for(const r of _n)n[r]===void 0&&e.push({type:"parse-error",section:"attributes",message:`Eigenschaft ${r} konnte nicht gelesen werden.`});return n}function Z(t,e){for(const n of t.matchAll(ve)){const s=n[1],i=n[2];if(!s||!i)continue;const r=D(i);switch(s){case"LeP":e.lep=r;break;case"AsP":e.asp=r;break;case"KaP":e.kap=r;break;case"INI":e.ini=i;break;case"AW":e.aw=r;break;case"SK":e.sk=r;break;case"ZK":e.zk=r;break;case"GS":e.gs=r;break}}}function jn(t,e){for(;t.length>0;){const n=t[0]?.trim()??"";if(!n){t.shift();continue}const s=n.replace(/^[–—-]\s*/,"").trim();if(!/^(LeP|AsP|KaP|INI|AW|SK|ZK|GS)\b/i.test(s))break;t.shift(),Z(s,e)}}function D(t){const e=t.replace(/[^0-9\-]/g,"");if(!e)return null;const n=Number.parseInt(e,10);return Number.isNaN(n)?null:n}function Te(t){return/^[^:]+:\s+(AT|FK)\s+/i.test(t)}function Hn(t){if(!t)return!1;const e=t.trim();return!(!e||Te(e)||Ee.test(e)||/^RS\s*\/\s*BE/i.test(e))}function Bn(t,e){const n=K(t);if(!n)return null;const s=n,i=n.match(/^(\d+)\s*\/\s*(\d+)(.*)$/);if(!i)return e.push({type:"parse-error",section:"armor",message:`Rüstungseintrag "${n}" konnte nicht interpretiert werden.`}),{rs:null,be:null,description:null,notes:n,raw:s};const[,r,a,o=""]=i,c=o??"",u=[...c.matchAll(/\(([^)]+)\)/g)].map(f=>f[1]?.trim()??"");let l=u[0]??null;const m=u.length>1?u.slice(1).filter(Boolean).join("; "):null;if(!l){const f=c.replace(/\([^)]*\)/g," ").replace(/[;,]+/g," ").trim();f&&(l=K(f))}return{rs:D(r??""),be:D(a??""),description:l,notes:m,raw:s}}function Xn(t,e){const[n,s]=t.split(":");if(!s){e.push({type:"parse-error",section:"weapons",message:`Zeile "${t}" enthält keinen Doppelpunkt.`});return}const i=(n??"").trim(),r={};for(const l of s.matchAll(ve)){const m=l[1],f=l[2];if(!m||!f)continue;const b=m.toUpperCase();r[b]=f}const a=r.AT?D(r.AT):null,o=r.PA?D(r.PA):null,c=r.FK?D(r.FK):null,u=Zn(i,a,c);return{name:i,category:u,attack:a,parry:o,rangedAttack:c,damage:r.TP??null,range:r.RW??null,load:r.LZ??null,reach:r.RE??null,notes:r.BEM??null,raw:r,rawInput:t.trim()}}function Zn(t,e,n){return t.toLowerCase().includes("waffenlos")?"unarmed":n!==null?"ranged":e!==null?"melee":"unknown"}function Yn(t){const e=[],n=[];let s=null,i=[];const r=()=>{s?e.push({heading:s,content:i.join(" ").trim()}):i.length>0&&n.push(i.join(" ").trim()),s=null,i=[]};for(const a of t){const o=a.trim();if(!o)continue;const c=o.match(Ee);if(c){const u=c[1]?.trim();if(s&&s.toLowerCase().startsWith("talente")&&u&&Ie(u)){i.push(o);continue}r(),s=u&&u.length>0?u:null;const l=c[2]?.trim();i=l?[l]:[];continue}s?i.push(o):n.push(o)}return r(),{sections:e,extras:n}}function Qn(t){const e=t.toLowerCase().replace(/\s+/g,"").replace(/[()\/]/g,"");return e.startsWith("schmerz")||e==="kampfverhaltenflucht"?"notes":Mn[e]??ni(t)??null}function y(t,e){if(e)for(const n of x(e))t.push(n)}function we(t,e){if(e)for(const n of x(e))oi(n).forEach(i=>{i&&t.push(i)})}function ye(t,e){if(!e||e.toLowerCase()==="keine")return;const n=Jn(e);for(const s of x(n)){const i=ei(s);i&&t.push(i)}}function Jn(t){return t.replace(Vn,(e,n,s)=>Ie(n)?`${s===0?"":"; "}${n}: `:e)}function ei(t){return t.replace(Pn,"")}function Ie(t){const e=t.toLowerCase().replace(/\s+/g,"").replace(/-+/g,"");return X.some(n=>e.startsWith(n.replace(/\s+/g,"")))}function x(t){const e=t.replace(Un,";"),n=[];let s="",i=0;for(const a of e){if(a==="("?i+=1:a===")"&&(i=Math.max(i-1,0)),(a===","||a===";")&&i===0){s.trim()&&n.push(s.trim()),s="";continue}s+=a}s.trim()&&n.push(s.trim());const r=n.map(a=>F(a));return ti(r)}function ti(t){const e=[];for(const n of t){const s=n.trim();e.length>0&&/^(den|die|das|dessen|deren)\b/i.test(s)?e[e.length-1]=`${e[e.length-1]}, ${s}`:e.push(s)}return e}function Le(t,e,n){if(t.length===0)return;const s=[];let i=null;for(const r of t){const a=r.match(/^(sprachen?|sprachkenntnisse)\s*:\s*(.+)$/i);if(a){y(e,a[2]),i="languages";continue}const o=r.match(/^(schriften?|schrift)\s*:\s*(.+)$/i);if(o){y(n,o[2]),i="scripts";continue}if(i==="languages"&&ii(r)){e.push(r);continue}if(i==="scripts"&&si(r)){n.push(r);continue}i=null,s.push(r)}t.length=0,t.push(...s)}function ni(t){const e=t.toLowerCase();return e.includes("sonderfert")?e.includes("kampf")?"combatSpecialAbilities":"specialAbilities":e.includes("talent")?"talents":e.includes("kampftechnik")?"combatTechniques":e.includes("sprache")?"languages":e.includes("schrift")?"scripts":e.includes("liturgie")?"liturgies":e.includes("ritual")?"rituals":e.includes("segnung")?"blessings":e.includes("zaubertrick")||e.includes("cantrip")?"cantrips":e.includes("zauber")?"spells":e.includes("ausrüstung")||e.includes("inventar")?"equipment":e.includes("vorteil")&&e.includes("nachteil")?"advantages-disadvantages":e.includes("vorteil")?"advantages":e.includes("nachteil")?"disadvantages":e.includes("rs/be")||e.includes("rüst")?"armor":null}function ii(t){return/\b[IVXLCDM]+\b/i.test(t)||/^muttersprache\b/i.test(t)}function si(t){return/zeichen|runen|glyph|schrift|piktogramm|alphabet|zhayad/i.test(t)}function ri(t){return N(t).map(e=>ai(e)).filter(e=>e.length>0)}function ai(t){const e=fi(di(t)),n=e.match(/\(\s*[^)]+\)\s*$/u),s=n?n[0]:"",i=s&&e.endsWith(s)?e.slice(0,e.length-s.length).trim():e,r=qn[i.toLowerCase()];return r?s?`${r} ${s}`.trim():r:e}function oi(t){const e=t.split(new RegExp("(?<=\\))\\s+(?=[A-ZÄÖÜ][a-zäöüß])","u")).map(n=>n.trim()).filter(n=>n.length>0);return e.length>0?e:[t]}function ci(t,e){for(const n of x(e)){const s=pi(n);for(const i of s){const r=li(i);r==="disadvantage"?t.disadvantages.push(i):r==="advantage"?t.advantages.push(i):(t.advantages.push(i),t.disadvantages.push(i))}}}function li(t){const e=t.toLowerCase();return["schlechte eigenschaft","verpflicht","feindschaft","hass","arm","krankheit","unfähig","vorurteil","schulden","angst","zauberanfällig"].some(i=>e.includes(i))?"disadvantage":["begabung","adelig","gutaussehend","vorteil","resistenz","richtungssinn","entfernungssinn"].some(i=>e.includes(i))?"advantage":"both"}function N(t){return t.map(e=>K(e)).map(e=>F(e)).map(e=>ui(e)).map(e=>mi(e)).map(e=>Se(e)).map(e=>Ne(e)).map(e=>K(e)).map(e=>e.endsWith(".")?e.slice(0,-1):e).filter(e=>e.length>0).filter(e=>{const n=e.toLowerCase();return n!=="keine"&&n!=="keiner"&&n!=="keinen"&&n!=="nein"&&n!=="entfällt"&&n!=="-"&&n!=="—"})}function K(t){return t.replace(/\s+/g," ").trim()}function F(t){return t.replace(/([A-Za-zÄÖÜäöüß]+)-\s+([A-Za-zÄÖÜäöüß]+)\b/g,(e,n,s)=>xn.has(s.toLowerCase())?`${n}- ${s}`:`${n}${s}`)}function ui(t){let e=t.replace(/([IVX]+)\s*AKO\d+/gi,"$1").replace(/([IVX]+)AKO\d+/gi,"$1");return e=e.replace(/AKO[IVX\d]+/gi,""),e=e.replace(/\s{2,}/g," "),e.trim()}function Se(t){let e=t;for(const[n,s]of Object.entries(Cn)){const i=new RegExp(`\\b${n}\\b`,"gi");e=e.replace(i,s)}return e}function Ne(t){return t.replace(/\*+$/g,"").trim()}function mi(t){return t.replace(/\(([^)]+)\)/g,(e,n)=>`(${n.split(/\s*[;,\/]\s*/).map(i=>{const r=i.trim(),a=r.toUpperCase();return Dn[a]??r}).filter(i=>i.length>0).join(", ")})`)}function di(t){const e=t.trim(),n=e.match(Kn);if(n&&n[3]){const[,r,a,o]=n;if(a&&o){const c=o.trim();if(c){const u=c.toLowerCase()==="seil"?"Kletterseil, pro Schritt":c,m=a.toLowerCase().startsWith("schritt")?"m":a;return`${u} (${r} ${m})`.trim()}}}const s=e.match(/^(\d+)\s+(.*)$/u);if(s&&s[2])return s[2].trim();const i=e.match(/^([A-Za-zÄÖÜäöüß]+)\s+(.*)$/u);if(i&&i[2]){const r=i[1]?.toLowerCase();if(r&&On.has(r))return i[2].trim()}return e}function fi(t){let e=t.trim();return e=e.replace(/\(\s*(?:x\s*)?\d+\s*\)\s*$/iu,"").trim(),e}function hi(t){return t.replace(/\(\s*[^)]*\)\s*$/u,"").trim()}function pi(t){const e=[];let n="",s=0;for(const i of t){if(i==="("?s+=1:i===")"&&(s=Math.max(s-1,0)),i==="/"&&s===0){n.trim()&&e.push(n.trim()),n="";continue}n+=i}return n.trim()&&e.push(n.trim()),e}function gi(t,e){const n=t.toLowerCase(),s=e.toLowerCase(),i=n.indexOf(s);if(i===-1)return{primary:t};const r=t.slice(0,i).trim().replace(/[;,]+$/,""),a=t.slice(i+e.length).trim();return{primary:r.length>0?r:"",trailing:a.length>0?a:void 0}}function bi(t,e){const n=[];for(const s of t){const a=Ne(s.trim()).replace(/([^\s\d])(-?\d+)(\s*\([^)]*\))?$/,"$1 $2$3").match(/^(.+?)\s+(-?\d+)(?:\s*\([^)]*\))?$/);if(!a){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${s}"`});continue}const o=F(a[1]??""),c=a[2];if(!o||!c){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${s}"`});continue}const u=Se(o.replace(/\*+$/,"").trim()),l=Number.parseInt(c,10);if(Number.isNaN(l)){e.push({type:"parse-error",section:"talents",message:`Talentwert ist keine Zahl: "${s}"`});continue}n.push({name:u,value:l})}return n}function W(t,e,n){const s=[];for(const i of N(t)){const a=hi(i).match(/^(.+?)\s+(-?\d+|[IVX]+)$/i);if(!a){s.push({name:i,value:0}),n.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${i}"`});continue}const o=F(a[1]??""),c=a[2];if(!o||!c){n.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${i}"`});continue}const u=o.trim(),l=c.trim();let m=Number.parseInt(l,10);if(Number.isNaN(m)&&(m=Ai(l.toUpperCase())),!m||Number.isNaN(m)){n.push({type:"parse-error",section:e,message:`Numerischer Wert für ${e} ist ungültig: "${i}"`});continue}s.push({name:u,value:m})}return s}function Ai(t){const e={I:1,V:5,X:10,L:50,C:100},n=t.toUpperCase().split("");let s=0,i=0;for(const r of n.reverse()){const a=e[r];if(!a)return null;a<i?s-=a:(s+=a,i=a)}return s}function ki(){return{name:"Unbekannt",attributes:{},pools:{},armor:null,actions:null,weapons:[],combatTechniques:[],scripts:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],spells:[],cantrips:[],liturgies:[],rituals:[],blessings:[],equipment:[],talents:[],notes:{},extras:[]}}let G,$e;self.addEventListener("message",async t=>{const e=t.data;if(!(!e||e.type!=="convert"))try{const n=await vi(e.payload.baseUrl),s=Fn(e.payload.source),i=qt(s.model,n),{hero:r,warnings:a}=lt({dataset:n,parsed:s,resolved:i}),o=Ei(i),c={type:"result",payload:{exported:r,exportedWarnings:a,manifest:n.manifest,normalizedSource:s.normalizedSource,parserWarnings:s.warnings,resolverWarnings:i.warnings,unresolved:i.unresolved,equipmentSummary:o}};postMessage(c)}catch(n){const s={type:"error",error:n instanceof Error?n.message:String(n)};postMessage(s)}});async function vi(t){const e=new URL("data/optolith/manifest.json",t).toString();if(G&&$e===e)return G;const n=await fetch(e);if(!n.ok)throw new Error(`Manifest konnte nicht geladen werden (${n.status})`);const s=await n.json(),i=async a=>{const o=new URL(`data/optolith/${a}`,t).toString(),c=await fetch(o);if(!c.ok)throw new Error(`Datensatz ${a} konnte nicht geladen werden (${c.status})`);return c.json()},r={manifest:s,advantages:await i(I(s,"advantages")),disadvantages:await i(I(s,"disadvantages")),specialAbilities:await i(I(s,"specialAbilities")),skills:await i(I(s,"skills")),combatTechniques:await i(I(s,"combatTechniques")),spells:await i(I(s,"spells")),cantrips:await i(I(s,"cantrips")),liturgies:await i(I(s,"liturgies")),blessings:await i(I(s,"blessings")),equipment:await i(I(s,"equipment")),books:await i(I(s,"books")),blessedTraditions:await i(I(s,"blessedTraditions")),magicalTraditions:await i(I(s,"magicalTraditions"))};return G=_e(r),$e=e,G}function Ei(t){const e=t.weapons.map(i=>({name:i.source.name,templateId:i.match?.id,combatTechniqueId:i.combatTechnique?.id,fallback:i.fallback,unresolved:!i.match})),n=t.armor?{name:t.armor.source.description??t.armor.source.notes??t.armor.source.raw??"Unknown armor",templateId:t.armor.match?.id,protection:typeof t.armor.datasetProtection=="number"?t.armor.datasetProtection:null,encumbrance:typeof t.armor.datasetEncumbrance=="number"?t.armor.datasetEncumbrance:null,unresolved:!t.armor.match}:null,s=t.equipment.map(i=>({name:i.source,templateId:i.match?.id,unresolved:!i.match}));return{weapons:e,armor:n,gear:s}}function I(t,e){const n=t.sections.find(s=>s.key===e);if(!n)throw new Error(`Manifestabschnitt fehlt: ${e}`);return n.file}})();
