(function(){"use strict";function A(n){return n.toLocaleLowerCase("de-DE").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim()}function fe(n){const e=$(n.specialAbilities);return{manifest:n.manifest,advantages:$(n.advantages),disadvantages:$(n.disadvantages),specialAbilities:e,skills:$(n.skills),combatTechniques:$(n.combatTechniques),spells:$(n.spells),liturgies:$(n.liturgies),blessings:$(n.blessings),equipment:$(n.equipment),languages:X(n.specialAbilities,"SA_29"),scripts:X(n.specialAbilities,"SA_27")}}function $(n){const e=new Map,t=new Map;for(const i of n){e.set(i.id,i),t.set(i.normalizedName,i);for(const a of i.synonyms??[]){const r=A(a);r&&(t.has(r)||t.set(r,i))}const s=typeof i.locale?.name=="string"?String(i.locale.name):void 0;if(s){const a=A(s);a&&!t.has(a)&&t.set(a,i)}}return{byId:e,byName:t}}function X(n,e){const t=n.find(o=>o.id===e),i=new Map;if(!t)return i;const s=t.locale,a=Array.isArray(s?.selectOptions)?s.selectOptions:[],r=typeof t.base=="object"&&t.base!==null?Number.parseInt(String(t.base.levels??""),10):void 0;for(const o of a){if(!o||typeof o.name!="string"||typeof o.id!="number")continue;const c=A(o.name);i.set(c,{ability:t,optionId:o.id,name:o.name,normalizedName:c,maxLevel:Number.isFinite(r)?r:void 0})}return i}function Z(n){return n===void 0||n<=8?0:Math.floor((n-8)/3)}function de(n){if(!n)return{at:0,fk:0};const t=n.base?.special;return{at:typeof t?.at=="number"?t.at:0,fk:typeof t?.fk=="number"?t.fk:0}}function pe(n){if(n.combatTechnique?.id)return n.combatTechnique.id;if(n.fallback==="unarmed")return"CT_9"}function he(n,e,t){const i=n.model.attributes.MU??0,s=n.model.attributes.FF??0,a=[],r=[],o=new Map,c=(l,u,d,p)=>{const g=Math.max(6,Math.round(d)),h=o.get(l);if(h){if(h.sources.some(k=>k.name===p)||h.sources.push({name:p,value:g}),g>h.value&&(h.value=g),new Set(h.sources.map(k=>k.value)).size>1){const k=h.sources.map(w=>`${w.name} ⇒ ${w.value}`).join(", ");r.push(`[Exporter] combatTechniques: Technik ${u??l} hat widersprüchliche Werte (${k}).`)}}else o.set(l,{value:g,sources:[{name:p,value:g}]})},m=l=>t.combatTechniques.byId.get(l)?.name;for(const l of e.weapons){const u=pe(l);if(!u)continue;const d=de(l.match),p=m(u);let g,h=0,f=0;const k=l.source.attack??null,w=l.source.rangedAttack??null;if(l.source.attack!==null&&l.source.attack!==void 0?(h=Z(i),f=d.at,g=l.source.attack-h-f):l.source.rangedAttack!==null&&l.source.rangedAttack!==void 0&&(h=Z(s),f=d.fk,g=l.source.rangedAttack-h-f),g===void 0)continue;const C=Math.max(6,Math.round(g));a.push({weaponName:l.source.name,combatTechniqueId:u,combatTechniqueName:p,derivedValue:C,sourceAttack:k,sourceRangedAttack:w,attributeBonus:h,weaponModifier:f,fallback:l.fallback}),c(u,p,g,l.source.name)}for(const l of n.model.combatTechniques??[]){const u=A(l.name);if(!u)continue;const d=t.combatTechniques.byName.get(u);if(!d){r.push(`[Exporter] combatTechniques: Kampftechnik "${l.name}" konnte nicht aufgelöst werden.`);continue}c(d.id,d.name,l.value,l.name)}return{values:Object.fromEntries(Array.from(o.entries()).map(([l,u])=>[l,u.value])),warnings:r,details:a}}const ge="1.5.1",be=3,ve=1100,H="1.0.0",Ae="EL_1",ke="R_1",we="C_1",ye="P_1",Te="m",Ee="Unbekannt",$e="Unbekannt",Le="Unbekannt",Se="Unbekannt",ze="Unbekannt",Ie="Unbekannt",Ne=2,Re="Unbekannt",_e={MU:"ATTR_1",KL:"ATTR_2",IN:"ATTR_3",CH:"ATTR_4",FF:"ATTR_5",GE:"ATTR_6",KO:"ATTR_7",KK:"ATTR_8"};function Oe({dataset:n,parsed:e,resolved:t}){if(n.manifest.schemaVersion!==H)throw new Error(`Unsupported dataset schema version: ${n.manifest.schemaVersion}. Expected ${H}.`);const i=new Date().toISOString(),s=je(),a=Me(e),r=Pe(t),o=qe(t),c=W(t.spells),m=W(t.liturgies),l=W(t.rituals),u=he(e,t,n),d={clientVersion:ge,dateCreated:i,dateModified:i,id:s,phase:be,locale:n.manifest.locale,name:t.name,ap:{total:ve},el:Ae,r:ke,c:we,p:ye,sex:Ce(e),pers:Fe(),attr:a,activatable:r,talents:o,spells:c,liturgies:m,blessings:Ke(t),cantrips:Ue(t),rituals:l,ct:u.values,belongings:We(t),rules:Ve(),pets:{}},p=De(e,t,u.warnings);return{hero:d,warnings:p}}function Ce(n){const e=n.model.name.trim().toLowerCase(),t=n.normalizedSource.toLowerCase();return["kriegerin","magierin","priesterin","jägerin","herrin","schamanin","meisterin","händlerin","frau "].some(a=>t.includes(a))?"f":["schamane","priester","magier","herr ","krieger"].some(a=>t.includes(a))?"m":e.endsWith("in")||e.endsWith("a")?"f":Te}function Me(n){return{values:Object.entries(_e).map(([t,i])=>{const s=n.model.attributes[t]??0;return{id:i,value:typeof s=="number"?s:0}}).sort((t,i)=>t.id.localeCompare(i.id)),attributeAdjustmentSelected:"ATTR_4",ae:0,kp:0,lp:0,permanentAE:{lost:0,redeemed:0},permanentKP:{lost:0,redeemed:0},permanentLP:{lost:0}}}function Pe(n){const e={},t=(s,a)=>{e[s]||(e[s]=[]),e[s].push(a)},i=s=>{if(!s.match)return;const a={};s.selectOption&&(a.sid=s.selectOption.id),s.rawOption&&s.rawOption.trim()&&(a.options=[{type:"Custom",value:s.rawOption.trim()}]),s.level&&(a.tier=s.level),t(s.match.id,a)};return n.advantages.forEach(i),n.disadvantages.forEach(i),n.specialAbilities.forEach(i),n.combatSpecialAbilities.forEach(i),n.languages.forEach(s=>{if(!s.match)return;const a={};s.option&&(a.sid=s.option.optionId),!s.option&&s.rawOption?.trim()&&(a.options=[{type:"Custom",value:s.rawOption.trim()}]),s.level&&(a.tier=s.level),t(s.match.id,a)}),n.scripts?.forEach(s=>{if(!s.match)return;const a={};s.option&&(a.sid=s.option.optionId),!s.option&&s.rawOption?.trim()&&(a.options=[{type:"Custom",value:s.rawOption.trim()}]),t(s.match.id,a)}),e}function qe(n){const e={};for(const t of n.talents)t.match&&(e[t.match.id]=t.source.value);return e}function W(n){const e={};for(const t of n)t.match&&(e[t.match.id]=t.value);return e}function Ke(n){const e=new Set;for(const t of n.blessings)t.match&&e.add(t.match.id);return Array.from(e)}function De(n,e,t=[]){const i=[];for(const s of n.warnings)i.push(`[Parser] ${s.section??"general"}: ${s.message}`);for(const s of e.warnings)i.push(`[Resolver] ${s.section}: ${s.message}`);for(const[s,a]of Object.entries(e.unresolved))for(const r of a)i.push(`[Resolver] ${s}: unverarbeitet "${r}"`);if(e.weapons.forEach(s=>{!s.match&&s.fallback!=="unarmed"&&i.push(`[Exporter] weapons: Waffe "${s.source.name}" konnte nicht exportiert werden (keine Zuordnung).`)}),e.armor&&!e.armor.match&&!e.armor.isNaturalArmor){const s=e.armor.source.description??e.armor.source.notes??e.armor.source.raw;i.push(`[Exporter] armor: Rüstung "${s}" konnte nicht exportiert werden (keine Zuordnung).`)}return t.forEach(s=>i.push(s)),i}function Ue(n){return n.specialAbilities.filter(e=>e.match?.id.startsWith("CANTRIP_")).map(e=>e.match.id)}function Ve(){return{higherParadeValues:0,attributeValueLimit:!1,enableAllRuleBooks:!0,enabledRuleBooks:[],enableLanguageSpecializations:!1}}function Fe(n){return{family:Ee,placeofbirth:$e,dateofbirth:Le,age:Se,size:ze,weight:Ie,socialstatus:Ne,cultureAreaKnowledge:Re}}function We(n){const e=[],t=s=>{e.push(s)};n.weapons.forEach(s=>{if(!s.match)return;const a=j(s.match,{name:s.source.name});s.combatTechnique?.id&&(a.combatTechnique=s.combatTechnique.id),t(a)}),n.armor?.match&&t(j(n.armor.match,{name:n.armor.source.description??n.armor.source.notes??n.armor.source.raw??n.armor.match.name})),n.equipment.forEach(s=>{s.match&&t(j(s.match,{name:s.source}))});const i={};return e.forEach((s,a)=>{const r=`ITEM_${a+1}`;i[r]={id:r,...s}}),{items:i,armorZones:{},purse:{d:"0",s:"0",h:"0",k:"0"}}}function j(n,e={}){const t=n.base??{},i=t.special??{},s={template:n.id,amount:1,name:n.name,isTemplateLocked:!0,...e};for(const[o,c]of Object.entries(t))o==="special"||o==="id"||c===void 0||(s[o]=c);const a={};for(const[o,c]of Object.entries(i??{}))if(c!=null)switch(o){case"protection":s.pro=c;break;case"encumbrance":s.enc=c;break;case"closeRange":a.close=Number(c);break;case"mediumRange":a.medium=Number(c);break;case"farRange":a.far=Number(c);break;default:s[o]=c;break}const r=[a.close,a.medium,a.far].filter(o=>typeof o=="number"&&Number.isFinite(o));return r.length>0&&(s.range=r),e.name?s.name=e.name:s.name=n.name,e.amount&&(s.amount=e.amount),s}function je(){return`H_${Math.floor(1+Math.random()*9e9)}`}const xe={"schlechte eigenschaften":"Schlechte Eigenschaft","schlechte eigenschaft":"Schlechte Eigenschaft",dammerungssicht:"Dunkelsicht",dammersicht:"Dunkelsicht",dunkesicht:"Dunkelsicht",verpflichtung:"Verpflichtungen",personlichkeitsschwache:"Persönlichkeitsschwächen",personlichkeitsschwachen:"Persönlichkeitsschwächen"},Be=/AKO(?:[IVXLCDM]+)?\s*\d{1,4}/g,Xe=/[,:;]+$/,Ze={peitsche:"fuhrmannspeitsche",speer:"speer",schwert:"langschwert",langschild:"gro schild",schild:"holzschild",dolch:"dolch",krummsabel:"sabel",krummsaebel:"sabel",platte:"plattenrustung"},He="belastungsgewohnung",Ge=["Arroganz","Eitelkeit","Neid","Streitsucht","Unheimlich","Verwöhnt","Vorurteile","Weltfremd","Anzügliches Verhalten","Eifersucht","Busenkomplexe","Peniskomplexe","Stimmungsschwankungen"],Ye=new Set(["ein","eine","einen","einem","einer","eins","zwei","drei","vier","fünf","sechs","sieben","acht","neun","zehn","elf","zwölf"].map(n=>n.toLowerCase()));function Qe(n,e){const t={lookups:e,warnings:[],unresolved:new Map,warningKeys:new Set},i=yt(n,e),s=new Set(i.languages),a=new Set,r=te([...n.specialAbilities,...wt(n.notes)],s,a,e),o=te(n.combatSpecialAbilities,s,a,e),c=O(i.advantages,"advantages",t.lookups.advantages,t),m=O(i.disadvantages,"disadvantages",t.lookups.disadvantages,t),l=O(r,"specialAbilities",t.lookups.specialAbilities,t),u=O(o,"combatSpecialAbilities",t.lookups.specialAbilities,t),d=[...n.languages,...s],p=[...n.scripts,...a],g=st(d,t),h=it(p,t),f=Je(n.talents,t),k=x(n.spells,"spells",t.lookups.spells,t),w=x(n.liturgies,"liturgies",t.lookups.liturgies,t),C=x(n.rituals,"rituals",t.lookups.spells,t),F=O(n.blessings,"blessings",t.lookups.blessings,t),me=O(n.equipment,"equipment",t.lookups.equipment,t),b=et(l),y=tt(n.weapons,t),v=nt(n.armor??null,t,b),R={};for(const[_,fn]of t.unresolved.entries())R[_]=Array.from(fn.values());return{name:n.name,advantages:c,disadvantages:m,specialAbilities:l,combatSpecialAbilities:u,languages:g,scripts:h,talents:f,spells:k,liturgies:w,rituals:C,blessings:F,equipment:me,weapons:y,armor:v,unresolved:R,warnings:t.warnings}}function O(n,e,t,i){return n.map(s=>I(s)).filter(s=>s.length>0).map(s=>{const a=ee(s);let r=A(a.baseName),o=t.byName.get(r),c,m,l,u;if(!o&&a.options.length>0)for(const p of a.options){const g=`${a.baseName} (${p})`,h=A(g),f=t.byName.get(h);if(f){o=f,r=h,c=p;break}}if(o&&gt(o)&&a.options.length>0)for(const p of a.options){const g=ht(o,p);if(g){m=g,u=g.name;break}l||(l=p)}else a.options.length>0&&(u=c??a.options[0]);if(!u&&a.options.length>0&&(u=c??a.options[0]),!u&&c&&(u=c),!o&&e==="equipment"){const p=G(s,"equipment",i,a.options);p&&(o=p)}const d=ot(a.baseName,a.level,u);return!o&&e==="blessings"&&ft(d)?{source:d,normalizedSource:r,match:void 0,selectOption:m,level:a.level??void 0,rawOption:l}:(o||z(e,d,i),{source:d,normalizedSource:r,match:o,selectOption:m,level:a.level??void 0,rawOption:l})})}function x(n,e,t,i){const s=[];for(const a of n){const r=I(a.name);if(!r){z(e,a.name,i);continue}const o=A(r),c=t.byName.get(o);c||z(e,r,i),s.push({source:r,normalizedSource:o,match:c,value:a.value})}return s}function Je(n,e){return n.map(t=>{const i=A(t.name);let s=e.lookups.skills.byName.get(i);if(!s){const a=At(i,e.lookups.skills.byName,1);a?(s=a.entry,T({type:"fuzzy-match",section:"talents",value:t.name,message:`Talent "${t.name}" wurde als "${s.name}" interpretiert (Schreibweise korrigiert).`},e)):z("talents",t.name,e)}return{source:t,match:s}})}function et(n){let e=0;for(const t of n){if(t.match?.normalizedName!==He)continue;const i=t.level??1;i>e&&(e=i)}return e}function tt(n,e){const t=[];for(const i of n){const s=I(i.name),a=A(s.length>0?s:i.name),r=i.category==="unarmed"||a==="waffenlos";let o=a.length>0?e.lookups.equipment.byName.get(a):void 0,c,m;if(o||(o=G(i.name,"weapons",e)),!o&&r&&(m="unarmed",c=e.lookups.combatTechniques.byId.get("CT_9"),c||T({type:"unresolved",section:"combatTechniques",value:"CT_9",message:"Kampftechnik Raufen (CT_9) konnte nicht geladen werden."},e)),o){const l=dt(o);l?(c=e.lookups.combatTechniques.byId.get(l),c||T({type:"unresolved",section:"combatTechniques",value:l,message:`Kampftechnik-ID "${l}" fehlt im Datensatz (für ${i.name}).`},e)):m||T({type:"unresolved",section:"weapons",value:i.name,message:`Waffe "${i.name}" enthält keine Kampftechnik im Datensatz.`},e)}!o&&!m&&z("weapons",i.name,e),t.push({source:i,normalizedSource:a,match:o,combatTechnique:c,fallback:m})}return t}function nt(n,e,t){if(!n)return null;const s=(n.description??"").trim(),a=s.toLowerCase(),r=(n.notes??"").toLowerCase(),o=a.includes("keine")||a.includes("ohne"),c=(n.rs??0)>0||(n.be??0)>0||s.length>0,m=s.length===0||a.includes("natürlicher rüstungsschutz")||r.includes("natürlicher rüstungsschutz");if(!c||(n.rs??0)===0&&(n.be??0)===0&&o)return null;let l=s;s&&a.includes("normale kleidung")&&a.includes("oder nackt")&&(l="normale Kleidung");const u=I(l),d=u.length>0?A(u):void 0,p=d?e.lookups.equipment.byName.get(d):void 0;let g,h;if(p){const f=pt(p);if(g=f?.protection,h=f?.encumbrance,f||T({type:"unresolved",section:"armor",value:p.name,message:`Rüstung "${p.name}" enthält keine RS/BE-Daten im Optolith-Katalog.`},e),typeof n.rs=="number"&&typeof g=="number"&&n.rs!==g&&T({type:"value-mismatch",section:"armor",value:s||p.name,message:`RS (${n.rs}) weicht vom Optolith-Wert (${g}) ab.`},e),typeof n.be=="number"&&typeof h=="number"&&n.be!==h){const k=t*2;t>0&&n.be<h&&h-n.be<=k||T({type:"value-mismatch",section:"armor",value:s||p.name,message:`BE (${n.be}) weicht vom Optolith-Wert (${h}) ab.`},e)}}else{const f=s||`RS ${n.rs??"-"} / BE ${n.be??"-"}`;if(m){const k=s.length>0?s:`RS ${n.rs??"-"} / BE ${n.be??"-"}`,w=s.length>0?s:`RS ${n.rs??"-"} / BE ${n.be??"-"}`;T({type:"fuzzy-match",section:"armor",value:k,message:`Eintrag "${w}" ohne Rüstungsbeschreibung; vermutlich natürlicher Rüstungsschutz.`},e)}else z("armor",f,e)}return{source:n,normalizedSource:d,match:p,datasetProtection:g??null,datasetEncumbrance:h??null,isNaturalArmor:!p&&m}}function st(n,e){return n.map(t=>I(t)).filter(t=>t.length>0).map(t=>{const i=at(t),s=A(i.baseName),a=e.lookups.languages.get(s);return a?(i.level&&a.maxLevel&&i.level>a.maxLevel&&T({type:"level-out-of-range",section:"languages",value:t,message:`Sprachstufe ${i.level} überschreitet den erlaubten Bereich (${a.maxLevel}).`},e),{source:t,normalizedSource:s,match:a.ability,option:a,level:i.level??void 0}):(z("languages",t,e),{source:t,normalizedSource:s,rawOption:i.baseName})})}function it(n,e){return n.map(t=>I(t)).filter(t=>t.length>0).map(t=>{const i=A(t),s=e.lookups.scripts.get(i);return s?{source:t,normalizedSource:i,match:s.ability,option:s}:(z("scripts",t,e),{source:t,normalizedSource:i,rawOption:t})})}function at(n){const e=n.trim(),t=e.match(/^(.*?)(?:\s+([IVX\d]+(?:\+[IVX\d]+)*))?$/i);if(!t)return{baseName:e};const i=(t[1]??e).trim(),s=t[2]?.trim();if(!s)return{baseName:i};const a=q(s);return{baseName:i,level:a??void 0}}function rt(n){const e={I:1,V:5,X:10},t=n.toUpperCase().split("");let i=0,s=0;for(const a of t.reverse()){const r=e[a];if(!r)return null;r<s?i-=r:(i+=r,s=r)}return i}function P(n){const e=[[10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]];let t=n,i="";for(const[s,a]of e)for(;t>=s;)i+=a,t-=s;return i||"I"}function ot(n,e,t){const i=n.trim(),s=e?`${i} ${P(e)}`.trim():i;return t&&t.trim().length>0?`${s} (${t.trim()})`.trim():s}function q(n){const e=n.split("+").map(i=>i.trim()).filter(i=>i.length>0);if(e.length===0)return;const t=e.map(i=>{const s=Number.parseInt(i,10);return Number.isNaN(s)?rt(i)??void 0:s}).filter(i=>i!==void 0);if(t.length!==0)return Math.max(...t)}function z(n,e,t){t.unresolved.has(n)||t.unresolved.set(n,new Set);const i=t.unresolved.get(n),s=i.size;i.add(e),i.size!==s&&T({type:"unresolved",section:n,value:e,message:`Eintrag "${e}" konnte im Abschnitt ${n} nicht aufgelöst werden.`},t)}function T(n,e){const t=`${n.type}:${n.section}:${n.value}:${n.message}`;e.warningKeys.has(t)||(e.warningKeys.add(t),e.warnings.push(n))}function G(n,e,t,i=[]){const s=ct(n,t.lookups.equipment,i);if(!s)return;const a=mt(e,n,s.match.name,s);return T({type:"fuzzy-match",section:e,value:n,message:a},t),s.match}function ct(n,e,t){const i=A(n),s=lt(n,t);for(const a of s){const r=A(a);if(!r||r===i)continue;const o=e.byName.get(r);if(o)return{match:o,token:a,reason:"token"}}for(const a of s){const r=A(a);if(r){for(const[o,c]of Object.entries(Ze))if(r===o||r.includes(o)){const m=e.byName.get(c);if(m)return{match:m,token:a,reason:"keyword",keyword:o}}}}}function lt(n,e){const t=new Set,i=a=>{if(!a)return;const r=a.trim();if(r.length===0)return;const o=J(Q(r));Y(t,o),o!==r&&Y(t,r)};i(n);const s=n.replace(/[()]/g," ");return s.split(/[-–—\/]/).forEach(a=>{i(a),a.split(/[,&]/).forEach(r=>i(r))}),s.split(/[,&]/).forEach(a=>i(a)),s.split(/\s+/).forEach(a=>i(a)),e.forEach(a=>i(a)),Array.from(t.values())}function Y(n,e){if(e){n.has(e)||n.add(e);for(const t of ut(e))t.length>0&&n.add(t)}}function ut(n){const e=new Set,t=n.trim(),i=t.toLowerCase();if(i.length<=2)return[];const s=r=>{r&&r!==t&&e.add(r)},a=(r,o="")=>{i.endsWith(r)&&t.length>r.length+1&&s(t.slice(0,t.length-r.length)+o)};return a("en"),a("en","e"),a("e"),a("er"),a("n"),a("s"),Array.from(e.values())}function mt(n,e,t,i){const s=n==="weapons"?"Waffe":"Ausrüstungseintrag";if(i.reason==="keyword"){const a=i.keyword??i.token;return`${s} "${e}" wurde als "${t}" interpretiert (Schlüsselwort "${a}").`}return`${s} "${e}" wurde als "${t}" interpretiert (Teilbegriff "${i.token}").`}function ft(n){const e=A(n);return e==="die zwolf segnungen"||e==="zwolf segnungen"||e==="12 segnungen"}function dt(n){const e=n.base;if(!e||typeof e!="object")return;const t=e.special;if(!t||typeof t!="object")return;const i=t.combatTechnique;return typeof i=="string"?i:void 0}function pt(n){const e=n.base;if(!e||typeof e!="object")return;const t=e.special;if(!t||typeof t!="object")return;const i=t.protection,s=t.encumbrance;if(!(typeof i!="number"&&typeof s!="number"))return{protection:typeof i=="number"?i:null,encumbrance:typeof s=="number"?s:null}}function ht(n,e){const t=n.locale,i=Array.isArray(t?.selectOptions)?t.selectOptions:[],s=A(e);for(const a of i){if(typeof a?.name!="string"||typeof a?.id!="number")continue;if(A(a.name)===s)return{id:a.id,name:a.name}}}function gt(n){const e=n.locale;return Array.isArray(e?.selectOptions)&&e.selectOptions.length>0}function I(n){if(!n)return n;const a=n.replace(Be," ").replace(/\(\s*\)/g,"").replace(/\s*\+\s*/g,"+").replace(/\s+/g," ").trim().replace(Xe,"").trim();return vt(bt(a))}function bt(n){return n.replace(/(Tradition\s*\()([^)]*?)geweih(?:ter|te|ten)(\))/gi,(e,t,i,s)=>{const a=i.trim().replace(/[-\s]+$/g,"");if(!a)return`${t}${i}${s}`;const r=`${a}kirche`;return`${t}${r}${s}`})}function vt(n){const e={analys:"Analys Arkanstruktur",odem:"Odem Arcanum",zauberklinge:"Zauberklinge Geisterspeer"},t=A(n);return e[t]??n}function Q(n){const e=n.trim(),t=e.match(/^(\d+)\s+(.*)$/u);if(t&&t[2])return t[2].trim();const i=e.match(/^([A-Za-zÄÖÜäöüß]+)\s+(.*)$/u);if(i&&i[2]){const s=i[1]?.toLowerCase();if(s&&Ye.has(s))return i[2].trim()}return e}function J(n){return n.replace(/\(\s*(?:x\s*)?\d+\s*\)\s*$/iu,"").trim()}function ee(n){let e=n.trim();e=J(Q(e)),e=e.replace(/([IVX]+)\s*-\s*([IVX]+)/gi,"$1+$2");let t;const i=[],s=()=>{const r=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);r&&(t=r[1]?.trim(),e=e.slice(0,r.index).trim())};for(s();;){const r=e.match(/\(([^)]+)\)\s*$/);if(!r)break;const o=r[1]?.trim();if(o){const c=o.split(/[,;]/).map(m=>m.trim()).filter(m=>m.length>0);if(c.length===0)i.unshift(o);else for(let m=c.length-1;m>=0;m-=1){const l=c[m];l&&i.unshift(l)}}e=e.slice(0,r.index).trim()}t||s();const a=t?q(t):void 0;return{baseName:e,options:i,level:a??void 0}}function At(n,e,t){let i;for(const[s,a]of e.entries()){if(Math.abs(s.length-n.length)>t)continue;const r=kt(s,n,t);if(r!==void 0&&(!i||r<i.distance)&&(i={entry:a,normalized:s,distance:r},r===0))return i}return i}function kt(n,e,t){const i=n.length,s=e.length;if(Math.abs(i-s)>t)return;if(i===0)return s<=t?s:void 0;if(s===0)return i<=t?i:void 0;const a=Array.from({length:s+1},(c,m)=>m),r=new Array(s+1);for(let c=1;c<=i;c+=1){r[0]=c;let m=r[0];const l=n.charAt(c-1);for(let u=1;u<=s;u+=1){const d=l===e.charAt(u-1)?0:1;r[u]=Math.min(a[u]+1,r[u-1]+1,a[u-1]+d),m=Math.min(m,r[u])}if(m>t)return;a.splice(0,a.length,...r)}const o=a[s];return o<=t?o:void 0}function te(n,e,t,i){const s=[];for(const a of n){const r=I(a);if(/^muttersprache\b/i.test(r)){e.add(ne(r));continue}const o=ee(r),c=A(o.baseName);if(i.languages.get(c)){o.level!==void 0?e.add(`${o.baseName} ${P(o.level)}`):e.add(o.baseName);continue}if(i.scripts.get(c)){t.add(o.baseName);continue}s.push(a)}return s}function wt(n){const e=new Set;for(const t of Object.values(n)){if(!t)continue;const i=t.split(/;+/);for(const s of i){const a=s.trim();if(!a)continue;const r=a.match(/^Paktgeschenke?:\s*(.+)$/i);if(r){const o=r[1]?.trim();o&&e.add(o)}}}return Array.from(e)}function yt(n,e){const t=new Set,i=new Set,s=new Set,a=(r,o)=>{const c=I(r);if(!c)return;if(/^muttersprache\b/i.test(c)){const l=ne(c);s.add(l);return}const m=Tt(c);for(const l of m){const{label:u,baseLabel:d,detail:p}=St(l),g=A(d);let h=e.advantages.byName.get(g),f=e.disadvantages.byName.get(g);if(!h&&!f&&p){const w=A(`${d} (${p})`);h=e.advantages.byName.get(w),f=e.disadvantages.byName.get(w)}if(h&&!f){t.add(u);continue}if(f&&!h){i.add(u);continue}if(h&&f){o==="advantage"?t.add(u):i.add(u);continue}const k=Rt(u);if(k==="advantage"){t.add(u);continue}if(k==="disadvantage"){i.add(u);continue}o==="advantage"?t.add(u):i.add(u)}};for(const r of n.advantages)a(r,"advantage");for(const r of n.disadvantages)a(r,"disadvantage");return{advantages:Array.from(t),disadvantages:Array.from(i),languages:Array.from(s)}}function Tt(n){const e=Lt(n),t=[];for(const i of e){const s=$t(i);if(s){t.push(s);continue}t.push(Et(i))}return Array.from(new Set(t))}function Et(n){const e=n.match(/^Immunität gegen\s+([^()]+)$/i);if(e&&e[1]){const t=e[1].trim();if(t.length>0)return`Immunität gegen (${t})`}return n}function $t(n){if(/^persönlichkeitsschwäche\b/i.test(n))return n.replace(/^persönlichkeitsschwäche/i,"Persönlichkeitsschwächen");if(/^persönlichkeitsschwächen\b/i.test(n))return n;const e=n.trim();if(!e)return;const t=e.toLowerCase();for(const i of Ge){const s=i.toLowerCase();if(t===s||t.startsWith(`${s} `))return`Persönlichkeitsschwächen (${e})`}}function Lt(n){const e=n.trim(),t=e.match(/^Angst vor\b(.*)$/i);if(!t)return[e];const i=t[1]?.trim()??"";if(!i)return["Angst vor"];let s=i;if(s.startsWith("(")&&s.endsWith(")"))s=s.slice(1,-1).trim();else{const r=s.match(/\(([^)]+)\)/);r&&r[1]?s=r[1].trim():s=s.trim()}if(s=s.replace(/^…\s*/u,""),!s)return["Angst vor"];const a=s.split(/[,;/]/).map(r=>r.trim().replace(/^…\s*/u,"").replace(/^\(+/u,"").replace(/\)+$/u,"").trim()).filter(r=>r.length>0);return a.length===0?[`Angst vor (${s})`]:a.map(r=>`Angst vor (${r})`)}function St(n){let e=n.trim();e=e.replace(/([IVX]+)\s*-\s*([IVX]+)/gi,"$1+$2");const t=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);let i;t&&(i=t[1],e=e.slice(0,t.index).trim());let s;const a=e.match(/^Angst vor\s+(.+)$/i);if(a){const l=a[1]?.trim();l&&!l.startsWith("(")&&(s=l,e="Angst vor")}const r=e.match(/\s*\(([^)]+)\)\s*$/);if(r&&(s=r[1],e=e.slice(0,r.index).trim()),!i){const l=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);l&&(i=l[1],e=e.slice(0,l.index).trim())}const o=zt(e);let c=o;const m=i?q(i):void 0;return m&&(c=`${c} ${P(m)}`.trim()),s&&(c=`${c} (${s})`.trim()),{label:c,baseLabel:o,detail:s}}function ne(n){let e=n.replace(/^muttersprache/i,"").trim();if(!e)return"Garethi III";const t=e.match(/([IVX\d]+)$/i);let i;t&&(i=t[1],e=e.slice(0,t.index).trim());const s=q(i??"III")??3;return`${e} ${P(s)}`.trim()}function zt(n){const e=A(n);return xe[e]??n}const It=["beidhändig","dunkelsicht","richtungssinn","entfernungssinn","zauberer","zäher hund","blutrausch","herausragender sinn","giftresistenz"],Nt=["schlechte eigenschaft","eingeschränkter sinn","angst vor","blind","kälteempfindlich","zauberanfällig"];function Rt(n){const e=A(n);return It.some(t=>e.includes(t))?"advantage":Nt.some(t=>e.includes(t))?"disadvantage":"unknown"}const _t=/^(MU|KL|IN|CH|FF|GE|KO|KK)(\s+\d{1,2})\s+(MU|KL|IN|CH|FF|GE|KO|KK)/,se=/([A-Za-zÄÖÜäöüß/+\-]+)\s+([^\s]+)/g,ie=/^([A-Za-zÄÖÜäöüß0-9\s/+\-&]+):\s*(.*)$/,Ot=["MU","KL","IN","CH","FF","GE","KO","KK"],Ct={vorteile:"advantages",nachteile:"disadvantages",sonderfertigkeiten:"specialAbilities",kampfsonderfertigkeiten:"combatSpecialAbilities",kampfsonderfertigkeit:"combatSpecialAbilities",sprachen:"languages",schriften:"scripts",talente:"talents",rsbe:"armor",aktionen:"actions",liturgien:"liturgies",liturgie:"liturgies",zauber:"spells",zaubersprüche:"spells",zaubertricks:"spells",rituale:"rituals",rituellezauber:"rituals",ausrüstung:"equipment",gegenstände:"equipment",inventar:"equipment",segnungen:"blessings",kampftechniken:"combatTechniques",kampfverhalten:"notes",kampfverhaltenundflucht:"notes",flucht:"notes",schmerz:"notes","vorteile/nachteile":"advantages-disadvantages",vorteilenachteile:"advantages-disadvantages"},Mt={sinesschärfe:"Sinnesschärfe","angriff verbessern":"Attacke verbessern",schnelladen:"Schnellladen",eigne:"Eigene"},Pt={MU:"Mut",KL:"Klugheit",IN:"Intuition",CH:"Charisma",FF:"Fingerfertigkeit",GE:"Gewandheit",KO:"Konstitution",KK:"Körperkraft"},qt=new Set(["ein","eine","einen","einem","einer","eins","zwei","drei","vier","fünf","sechs","sieben","acht","neun","zehn","elf","zwölf"].map(n=>n.toLowerCase()));function Kt(n){const e=[],t=Dt(n),i=t.split(`
`).map(b=>b.trim()).filter(b=>b.length>0);if(i.length===0)return{model:ln(),warnings:[{type:"parse-error",message:"Eingabetext ist leer."}],normalizedSource:t};const s=[...i],a=s.shift()??"Unbekannt",r=[];for(;s.length>0;){const b=s[0];if(!b||!_t.test(b))break;r.push(s.shift())}const o=Ut(r.join(" "),e),c={},m=s[0];m?.startsWith("LeP")?(B(m,c),s.shift()):e.push({type:"missing-section",section:"resources",message:"LeP/AsP/KaP-Zeile nicht gefunden."});const l=s[0];l?.startsWith("AW")&&(B(l,c),s.shift()),Vt(s,c);const u=[];let d=0;for(;d<s.length;){const b=s[d];if(b&&ae(b)){const y=[b];for(s.splice(d,1);d<s.length&&Ft(s[d]);){const _=s[d];if(!_)break;y.push(_),s.splice(d,1)}const v=y.join(" ").replace(/\s+/g," ").trim(),R=jt(v,e);R&&u.push(R);continue}d+=1}const p=[...s];for(let b=0;b<p.length;b+=1){const y=p[b];if(y&&/^RS\s*\/\s*BE\b/i.test(y)&&!/^RS\s*\/\s*BE\s*:/i.test(y)){const v=y.replace(/^RS\s*\/\s*BE\s*/i,"").trim();p[b]=`RS/BE: ${v}`}}const{sections:g,extras:h}=Bt(p),f={combatTechniques:[],scripts:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],talents:[],spells:[],liturgies:[],rituals:[],blessings:[],equipment:[]},k=new Set,w={};let C=null,F;for(const b of g){const y=Xt(b.heading),v=M(b.content);if(!y){w[b.heading]=v;continue}switch(k.add(y),y){case"advantages":E(f.advantages,v);break;case"disadvantages":E(f.disadvantages,v);break;case"advantages-disadvantages":k.add("advantages"),k.add("disadvantages"),v.toLowerCase()!=="keine"&&Yt(f,v);break;case"specialAbilities":{const{primary:R,trailing:_}=rn(v,"Talente:");re(f.specialAbilities,R),_&&oe(f.talents,_);break}case"combatSpecialAbilities":re(f.combatSpecialAbilities,v);break;case"scripts":E(f.scripts,v);break;case"combatTechniques":E(f.combatTechniques,v);break;case"languages":E(f.languages,v);break;case"talents":oe(f.talents,v);break;case"spells":E(f.spells,v);break;case"liturgies":E(f.liturgies,v);break;case"rituals":E(f.rituals,v);break;case"blessings":E(f.blessings,v);break;case"equipment":E(f.equipment,v);break;case"armor":C=Wt(v,e);break;case"actions":F=N(v);break;case"notes":default:w[b.heading]=v;break}}for(const b of["advantages","disadvantages","specialAbilities","talents"])k.has(b)||e.push({type:"missing-section",section:b,message:`Abschnitt "${b}" nicht gefunden.`});return{model:{name:a,attributes:o,pools:c,armor:C,actions:F??null,weapons:u,combatTechniques:U(f.combatTechniques,"combatTechniques",e),advantages:L(f.advantages),disadvantages:L(f.disadvantages),specialAbilities:L(f.specialAbilities),combatSpecialAbilities:L(f.combatSpecialAbilities),languages:L(f.languages),scripts:L(f.scripts),spells:U(f.spells,"spells",e),liturgies:U(f.liturgies,"liturgies",e),rituals:U(f.rituals,"rituals",e),blessings:L(f.blessings),equipment:Ht(f.equipment),talents:on(f.talents,e),notes:w,extras:h},warnings:e,normalizedSource:t}}function Dt(n){let e=n.replace(/\r\n/g,`
`).replace(/\t/g," ");return e=e.replace(/([A-Za-zÄÖÜäöüß])-\s*\n\s*([A-Za-zÄÖÜäöüß])/g,"$1$2"),e=e.replace(/–/g,"-"),e=e.split(`
`).map(t=>t.trimEnd()).join(`
`),e.trim()}function Ut(n,e){const t={};if(!n)return e.push({type:"missing-section",section:"attributes",message:"Eigenschaftszeilen nicht gefunden."}),t;const i=/(MU|KL|IN|CH|FF|GE|KO|KK)\s+(\d{1,2})/g;let s;for(;(s=i.exec(n))!==null;){const a=s[1],r=s[2];if(!a||!r)continue;const o=a,c=Number.parseInt(r,10);t[o]=Number.isNaN(c)?void 0:c}for(const a of Ot)t[a]===void 0&&e.push({type:"parse-error",section:"attributes",message:`Eigenschaft ${a} konnte nicht gelesen werden.`});return t}function B(n,e){for(const t of n.matchAll(se)){const i=t[1],s=t[2];if(!i||!s)continue;const a=N(s);switch(i){case"LeP":e.lep=a;break;case"AsP":e.asp=a;break;case"KaP":e.kap=a;break;case"INI":e.ini=s;break;case"AW":e.aw=a;break;case"SK":e.sk=a;break;case"ZK":e.zk=a;break;case"GS":e.gs=a;break}}}function Vt(n,e){for(;n.length>0;){const t=n[0]?.trim()??"";if(!t){n.shift();continue}const i=t.replace(/^[–—-]\s*/,"").trim();if(!/^(LeP|AsP|KaP|INI|AW|SK|ZK|GS)\b/i.test(i))break;n.shift(),B(i,e)}}function N(n){const e=n.replace(/[^0-9\-]/g,"");if(!e)return null;const t=Number.parseInt(e,10);return Number.isNaN(t)?null:t}function ae(n){return/^[^:]+:\s+(AT|FK)\s+/i.test(n)}function Ft(n){if(!n)return!1;const e=n.trim();return!(!e||ae(e)||ie.test(e)||/^RS\s*\/\s*BE/i.test(e))}function Wt(n,e){const t=M(n);if(!t)return null;const i=t,s=t.match(/^(\d+)\s*\/\s*(\d+)(.*)$/);if(!s)return e.push({type:"parse-error",section:"armor",message:`Rüstungseintrag "${t}" konnte nicht interpretiert werden.`}),{rs:null,be:null,description:null,notes:t,raw:i};const[,a,r,o=""]=s,c=o??"",m=[...c.matchAll(/\(([^)]+)\)/g)].map(d=>d[1]?.trim()??"");let l=m[0]??null;const u=m.length>1?m.slice(1).filter(Boolean).join("; "):null;if(!l){const d=c.replace(/\([^)]*\)/g," ").replace(/[;,]+/g," ").trim();d&&(l=M(d))}return{rs:N(a??""),be:N(r??""),description:l,notes:u,raw:i}}function jt(n,e){const[t,i]=n.split(":");if(!i){e.push({type:"parse-error",section:"weapons",message:`Zeile "${n}" enthält keinen Doppelpunkt.`});return}const s=(t??"").trim(),a={};for(const l of i.matchAll(se)){const u=l[1],d=l[2];if(!u||!d)continue;const p=u.toUpperCase();a[p]=d}const r=a.AT?N(a.AT):null,o=a.PA?N(a.PA):null,c=a.FK?N(a.FK):null,m=xt(s,r,c);return{name:s,category:m,attack:r,parry:o,rangedAttack:c,damage:a.TP??null,range:a.RW??null,load:a.LZ??null,reach:a.RE??null,notes:a.BEM??null,raw:a,rawInput:n.trim()}}function xt(n,e,t){return n.toLowerCase().includes("waffenlos")?"unarmed":t!==null?"ranged":e!==null?"melee":"unknown"}function Bt(n){const e=[],t=[];let i=null,s=[];const a=()=>{i?e.push({heading:i,content:s.join(" ").trim()}):s.length>0&&t.push(s.join(" ").trim()),i=null,s=[]};for(const r of n){const o=r.trim();if(!o)continue;const c=o.match(ie);if(c){a();const m=c[1]?.trim();i=m&&m.length>0?m:null;const l=c[2]?.trim();s=l?[l]:[];continue}i?s.push(o):t.push(o)}return a(),{sections:e,extras:t}}function Xt(n){const e=n.toLowerCase().replace(/\s+/g,"").replace(/[()\/]/g,"");return e.startsWith("schmerz")||e==="kampfverhaltenflucht"?"notes":Ct[e]??null}function E(n,e){if(e)for(const t of K(e))n.push(t)}function re(n,e){if(e)for(const t of K(e))Gt(t).forEach(s=>{s&&n.push(s)})}function oe(n,e){if(!(!e||e.toLowerCase()==="keine"))for(const t of K(e))n.push(t)}function K(n){const e=[];let t="",i=0;for(const a of n){if(a==="("?i+=1:a===")"&&(i=Math.max(i-1,0)),(a===","||a===";")&&i===0){t.trim()&&e.push(t.trim()),t="";continue}t+=a}t.trim()&&e.push(t.trim());const s=e.map(a=>D(a));return Zt(s)}function Zt(n){const e=[];for(const t of n){const i=t.trim();e.length>0&&/^(den|die|das|dessen|deren)\b/i.test(i)?e[e.length-1]=`${e[e.length-1]}, ${i}`:e.push(i)}return e}function Ht(n){return L(n).map(e=>nn(tn(e))).filter(e=>e.length>0)}function Gt(n){const e=n.split(new RegExp("(?<=\\))\\s+(?=[A-ZÄÖÜ][a-zäöüß])","u")).map(t=>t.trim()).filter(t=>t.length>0);return e.length>0?e:[n]}function Yt(n,e){for(const t of K(e)){const i=an(t);for(const s of i){const a=Qt(s);a==="disadvantage"?n.disadvantages.push(s):a==="advantage"?n.advantages.push(s):(n.advantages.push(s),n.disadvantages.push(s))}}}function Qt(n){const e=n.toLowerCase();return["schlechte eigenschaft","verpflicht","feindschaft","hass","arm","krankheit","unfähig","vorurteil","schulden","angst","zauberanfällig"].some(s=>e.includes(s))?"disadvantage":["begabung","adelig","gutaussehend","vorteil","resistenz","richtungssinn","entfernungssinn"].some(s=>e.includes(s))?"advantage":"both"}function L(n){return n.map(e=>M(e)).map(e=>D(e)).map(e=>Jt(e)).map(e=>en(e)).map(e=>ce(e)).map(e=>le(e)).map(e=>M(e)).map(e=>e.endsWith(".")?e.slice(0,-1):e).filter(e=>e.length>0).filter(e=>{const t=e.toLowerCase();return t!=="keine"&&t!=="keiner"&&t!=="keinen"&&t!=="entfällt"})}function M(n){return n.replace(/\s+/g," ").trim()}function D(n){return n.replace(/([A-Za-zÄÖÜäöüß])-\s+([A-Za-zÄÖÜäöüß])/g,"$1$2")}function Jt(n){let e=n.replace(/([IVX]+)\s*AKO\d+/gi,"$1").replace(/([IVX]+)AKO\d+/gi,"$1");return e=e.replace(/AKO[IVX\d]+/gi,""),e=e.replace(/\s{2,}/g," "),e.trim()}function ce(n){let e=n;for(const[t,i]of Object.entries(Mt)){const s=new RegExp(`\\b${t}\\b`,"gi");e=e.replace(s,i)}return e}function le(n){return n.replace(/\*+$/g,"").trim()}function en(n){return n.replace(/\(([^)]+)\)/g,(e,t)=>`(${t.split(/\s*[;,\/]\s*/).map(s=>{const a=s.trim(),r=a.toUpperCase();return Pt[r]??a}).filter(s=>s.length>0).join(", ")})`)}function tn(n){const e=n.trim(),t=e.match(/^(\d+)\s+(.*)$/u);if(t&&t[2])return t[2].trim();const i=e.match(/^([A-Za-zÄÖÜäöüß]+)\s+(.*)$/u);if(i&&i[2]){const s=i[1]?.toLowerCase();if(s&&qt.has(s))return i[2].trim()}return e}function nn(n){let e=n.trim();return e=e.replace(/\(\s*(?:x\s*)?\d+\s*\)\s*$/iu,"").trim(),e}function sn(n){return n.replace(/\(\s*[^)]*\)\s*$/u,"").trim()}function an(n){const e=[];let t="",i=0;for(const s of n){if(s==="("?i+=1:s===")"&&(i=Math.max(i-1,0)),s==="/"&&i===0){t.trim()&&e.push(t.trim()),t="";continue}t+=s}return t.trim()&&e.push(t.trim()),e}function rn(n,e){const t=n.toLowerCase(),i=e.toLowerCase(),s=t.indexOf(i);if(s===-1)return{primary:n};const a=n.slice(0,s).trim().replace(/[;,]+$/,""),r=n.slice(s+e.length).trim();return{primary:a.length>0?a:"",trailing:r.length>0?r:void 0}}function on(n,e){const t=[];for(const i of n){const a=le(i.trim()).match(/^(.+?)\s+(-?\d+)$/);if(!a){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${i}"`});continue}const r=D(a[1]??""),o=a[2];if(!r||!o){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${i}"`});continue}const c=ce(r.replace(/\*+$/,"").trim()),m=Number.parseInt(o,10);if(Number.isNaN(m)){e.push({type:"parse-error",section:"talents",message:`Talentwert ist keine Zahl: "${i}"`});continue}t.push({name:c,value:m})}return t}function U(n,e,t){const i=[];for(const s of L(n)){const r=sn(s).match(/^(.+?)\s+(-?\d+|[IVX]+)$/i);if(!r){i.push({name:s,value:0}),t.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${s}"`});continue}const o=D(r[1]??""),c=r[2];if(!o||!c){t.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${s}"`});continue}const m=o.trim(),l=c.trim();let u=Number.parseInt(l,10);if(Number.isNaN(u)&&(u=cn(l.toUpperCase())),!u||Number.isNaN(u)){t.push({type:"parse-error",section:e,message:`Numerischer Wert für ${e} ist ungültig: "${s}"`});continue}i.push({name:m,value:u})}return i}function cn(n){const e={I:1,V:5,X:10,L:50,C:100},t=n.toUpperCase().split("");let i=0,s=0;for(const a of t.reverse()){const r=e[a];if(!r)return null;r<s?i-=r:(i+=r,s=r)}return i}function ln(){return{name:"Unbekannt",attributes:{},pools:{},armor:null,actions:null,weapons:[],combatTechniques:[],scripts:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],spells:[],liturgies:[],rituals:[],blessings:[],equipment:[],talents:[],notes:{},extras:[]}}let V,ue;self.addEventListener("message",async n=>{const e=n.data;if(!(!e||e.type!=="convert"))try{const t=await un(e.payload.baseUrl),i=Kt(e.payload.source),s=Qe(i.model,t),{hero:a,warnings:r}=Oe({dataset:t,parsed:i,resolved:s}),o=mn(s),c={type:"result",payload:{exported:a,exportedWarnings:r,manifest:t.manifest,normalizedSource:i.normalizedSource,parserWarnings:i.warnings,resolverWarnings:s.warnings,unresolved:s.unresolved,equipmentSummary:o}};postMessage(c)}catch(t){const i={type:"error",error:t instanceof Error?t.message:String(t)};postMessage(i)}});async function un(n){const e=new URL("data/optolith/manifest.json",n).toString();if(V&&ue===e)return V;const t=await fetch(e);if(!t.ok)throw new Error(`Manifest konnte nicht geladen werden (${t.status})`);const i=await t.json(),s=async r=>{const o=new URL(`data/optolith/${r}`,n).toString(),c=await fetch(o);if(!c.ok)throw new Error(`Datensatz ${r} konnte nicht geladen werden (${c.status})`);return c.json()},a={manifest:i,advantages:await s(S(i,"advantages")),disadvantages:await s(S(i,"disadvantages")),specialAbilities:await s(S(i,"specialAbilities")),skills:await s(S(i,"skills")),combatTechniques:await s(S(i,"combatTechniques")),spells:await s(S(i,"spells")),liturgies:await s(S(i,"liturgies")),blessings:await s(S(i,"blessings")),equipment:await s(S(i,"equipment"))};return V=fe(a),ue=e,V}function mn(n){const e=n.weapons.map(s=>({name:s.source.name,templateId:s.match?.id,combatTechniqueId:s.combatTechnique?.id,fallback:s.fallback,unresolved:!s.match})),t=n.armor?{name:n.armor.source.description??n.armor.source.notes??n.armor.source.raw??"Unknown armor",templateId:n.armor.match?.id,protection:typeof n.armor.datasetProtection=="number"?n.armor.datasetProtection:null,encumbrance:typeof n.armor.datasetEncumbrance=="number"?n.armor.datasetEncumbrance:null,unresolved:!n.armor.match}:null,i=n.equipment.map(s=>({name:s.source,templateId:s.match?.id,unresolved:!s.match}));return{weapons:e,armor:t,gear:i}}function S(n,e){const t=n.sections.find(i=>i.key===e);if(!t)throw new Error(`Manifestabschnitt fehlt: ${e}`);return t.file}})();
