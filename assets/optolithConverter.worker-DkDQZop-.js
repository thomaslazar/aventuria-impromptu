(function(){"use strict";function b(i){return i.toLocaleLowerCase("de-DE").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim()}function Q(i){const e=y(i.specialAbilities);return{manifest:i.manifest,advantages:y(i.advantages),disadvantages:y(i.disadvantages),specialAbilities:e,skills:y(i.skills),combatTechniques:y(i.combatTechniques),spells:y(i.spells),liturgies:y(i.liturgies),blessings:y(i.blessings),equipment:y(i.equipment),languages:V(i.specialAbilities,"SA_29"),scripts:V(i.specialAbilities,"SA_27")}}function y(i){const e=new Map,t=new Map;for(const s of i){e.set(s.id,s),t.set(s.normalizedName,s);for(const a of s.synonyms??[]){const r=b(a);r&&(t.has(r)||t.set(r,s))}const n=typeof s.locale?.name=="string"?String(s.locale.name):void 0;if(n){const a=b(n);a&&!t.has(a)&&t.set(a,s)}}return{byId:e,byName:t}}function V(i,e){const t=i.find(o=>o.id===e),s=new Map;if(!t)return s;const n=t.locale,a=Array.isArray(n?.selectOptions)?n.selectOptions:[],r=typeof t.base=="object"&&t.base!==null?Number.parseInt(String(t.base.levels??""),10):void 0;for(const o of a){if(!o||typeof o.name!="string"||typeof o.id!="number")continue;const c=b(o.name);s.set(c,{ability:t,optionId:o.id,name:o.name,normalizedName:c,maxLevel:Number.isFinite(r)?r:void 0})}return s}const ee="1.5.1",te=3,ne=1100,W="1.0.0",se="EL_1",ie="R_1",ae="C_1",re="P_1",oe="m",ce="Unbekannt",le="Unbekannt",ue="Unbekannt",de="Unbekannt",me="Unbekannt",fe="Unbekannt",pe=2,ge="Unbekannt",he={MU:"ATTR_1",KL:"ATTR_2",IN:"ATTR_3",CH:"ATTR_4",FF:"ATTR_5",GE:"ATTR_6",KO:"ATTR_7",KK:"ATTR_8"};function be({dataset:i,parsed:e,resolved:t}){if(i.manifest.schemaVersion!==W)throw new Error(`Unsupported dataset schema version: ${i.manifest.schemaVersion}. Expected ${W}.`);const s=new Date().toISOString(),n=Se(),a=Ae(e),r=we(t),o=ye(t),c=D(t.spells),l=D(t.liturgies),u=D(t.rituals),m={clientVersion:ee,dateCreated:s,dateModified:s,id:n,phase:te,locale:i.manifest.locale,name:t.name,ap:{total:ne},el:se,r:ie,c:ae,p:re,sex:ve(e),pers:Ne(),attr:a,activatable:r,talents:o,spells:c,liturgies:l,blessings:Te(t),cantrips:ke(t),rituals:u,ct:{},belongings:Ie(t),rules:Le(),pets:{}},h=Ee(e,t);return{hero:m,warnings:h}}function ve(i){const e=i.model.name.trim().toLowerCase(),t=i.normalizedSource.toLowerCase();return["kriegerin","magierin","priesterin","jägerin","herrin","schamanin","meisterin","händlerin","frau "].some(a=>t.includes(a))?"f":["schamane","priester","magier","herr ","krieger"].some(a=>t.includes(a))?"m":e.endsWith("in")||e.endsWith("a")?"f":oe}function Ae(i){return{values:Object.entries(he).map(([t,s])=>{const n=i.model.attributes[t]??0;return{id:s,value:typeof n=="number"?n:0}}).sort((t,s)=>t.id.localeCompare(s.id)),attributeAdjustmentSelected:"ATTR_4",ae:0,kp:0,lp:0,permanentAE:{lost:0,redeemed:0},permanentKP:{lost:0,redeemed:0},permanentLP:{lost:0}}}function we(i){const e={},t=(n,a)=>{e[n]||(e[n]=[]),e[n].push(a)},s=n=>{if(!n.match)return;const a={};n.selectOption&&(a.sid=n.selectOption.id),n.rawOption&&n.rawOption.trim()&&(a.options=[{type:"Custom",value:n.rawOption.trim()}]),n.level&&(a.tier=n.level),t(n.match.id,a)};return i.advantages.forEach(s),i.disadvantages.forEach(s),i.specialAbilities.forEach(s),i.combatSpecialAbilities.forEach(s),i.languages.forEach(n=>{if(!n.match)return;const a={};n.option&&(a.sid=n.option.optionId),!n.option&&n.rawOption?.trim()&&(a.options=[{type:"Custom",value:n.rawOption.trim()}]),n.level&&(a.tier=n.level),t(n.match.id,a)}),e}function ye(i){const e={};for(const t of i.talents)t.match&&(e[t.match.id]=t.source.value);return e}function D(i){const e={};for(const t of i)t.match&&(e[t.match.id]=t.value);return e}function Te(i){const e=new Set;for(const t of i.blessings)t.match&&e.add(t.match.id);return Array.from(e)}function Ee(i,e){const t=[];for(const s of i.warnings)t.push(`[Parser] ${s.section??"general"}: ${s.message}`);for(const s of e.warnings)t.push(`[Resolver] ${s.section}: ${s.message}`);for(const[s,n]of Object.entries(e.unresolved))for(const a of n)t.push(`[Resolver] ${s}: unverarbeitet "${a}"`);return t}function ke(i){return i.specialAbilities.filter(e=>e.match?.id.startsWith("CANTRIP_")).map(e=>e.match.id)}function Le(){return{higherParadeValues:0,attributeValueLimit:!1,enableAllRuleBooks:!0,enabledRuleBooks:[],enableLanguageSpecializations:!1}}function Ne(i){return{family:ce,placeofbirth:le,dateofbirth:ue,age:de,size:me,weight:fe,socialstatus:pe,cultureAreaKnowledge:ge}}function Ie(i){const e={};return i.equipment.forEach((t,s)=>{t.match&&(e[`ITEM_${s+1}`]={template:t.match.id,amount:1})}),{items:e,armorZones:{},purse:{d:"0",s:"0",h:"0",k:"0"}}}function Se(){return`H_${Math.floor(1+Math.random()*9e9)}`}const ze={"schlechte eigenschaften":"Schlechte Eigenschaft","schlechte eigenschaft":"Schlechte Eigenschaft",dammerungssicht:"Dunkelsicht",dammersicht:"Dunkelsicht",verpflichtung:"Verpflichtungen"},$e=/AKO(?:[IVXLCDM]+)?\s*\d{1,4}/g,_e=/[,:;]+$/;function Re(i,e){const t={lookups:e,warnings:[],unresolved:new Map},s=xe(i,e),n=new Set(s.languages),a=q([...i.specialAbilities,...We(i.notes)],n,e),r=q(i.combatSpecialAbilities,n,e),o=k(s.advantages,"advantages",t.lookups.advantages,t),c=k(s.disadvantages,"disadvantages",t.lookups.disadvantages,t),l=k(a,"specialAbilities",t.lookups.specialAbilities,t),u=k(r,"combatSpecialAbilities",t.lookups.specialAbilities,t),m=[...i.languages,...n],h=Ce(m,t),p=Oe(i.talents,t),v=U(i.spells,"spells",t.lookups.spells,t),d=U(i.liturgies,"liturgies",t.lookups.liturgies,t),A=U(i.rituals,"rituals",t.lookups.spells,t),z=k(i.blessings,"blessings",t.lookups.blessings,t),M=k(i.equipment,"equipment",t.lookups.equipment,t),$={};for(const[Y,f]of t.unresolved.entries())$[Y]=Array.from(f.values());return{name:i.name,advantages:o,disadvantages:c,specialAbilities:l,combatSpecialAbilities:u,languages:h,talents:p,spells:v,liturgies:d,rituals:A,blessings:z,equipment:M,unresolved:$,warnings:t.warnings}}function k(i,e,t,s){return i.map(n=>I(n)).filter(n=>n.length>0).map(n=>{const a=x(n);let r=b(a.baseName),o=t.byName.get(r),c,l,u,m;if(!o&&a.options.length>0)for(const p of a.options){const v=`${a.baseName} (${p})`,d=b(v),A=t.byName.get(d);if(A){o=A,r=d,c=p;break}}if(o&&Ke(o)&&a.options.length>0)for(const p of a.options){const v=Pe(o,p);if(v){l=v,m=v.name;break}u||(u=p)}else a.options.length>0&&(m=c??a.options[0]);!m&&c&&(m=c);const h=Ue(a.baseName,a.level,m);return o||N(e,h,s),{source:h,normalizedSource:r,match:o,selectOption:l,level:a.level??void 0,rawOption:u}})}function U(i,e,t,s){const n=[];for(const a of i){const r=I(a.name);if(!r){N(e,a.name,s);continue}const o=b(r),c=t.byName.get(o);c||N(e,r,s),n.push({source:r,normalizedSource:o,match:c,value:a.value})}return n}function Oe(i,e){return i.map(t=>{const s=b(t.name);let n=e.lookups.skills.byName.get(s);if(!n){const a=Fe(s,e.lookups.skills.byName,1);a?(n=a.entry,e.warnings.push({type:"fuzzy-match",section:"talents",value:t.name,message:`Talent "${t.name}" wurde als "${n.name}" interpretiert (Schreibweise korrigiert).`})):N("talents",t.name,e)}return{source:t,match:n}})}function Ce(i,e){return i.map(t=>I(t)).filter(t=>t.length>0).map(t=>{const s=Me(t),n=b(s.baseName),a=e.lookups.languages.get(n);return a?(s.level&&a.maxLevel&&s.level>a.maxLevel&&e.warnings.push({type:"level-out-of-range",section:"languages",value:t,message:`Sprachstufe ${s.level} überschreitet den erlaubten Bereich (${a.maxLevel}).`}),{source:t,normalizedSource:n,match:a.ability,option:a,level:s.level??void 0}):(N("languages",t,e),{source:t,normalizedSource:n,rawOption:s.baseName})})}function Me(i){const e=i.trim(),t=e.match(/^(.*?)(?:\s+([IVX\d]+(?:\+[IVX\d]+)*))?$/i);if(!t)return{baseName:e};const s=(t[1]??e).trim(),n=t[2]?.trim();if(!n)return{baseName:s};const a=R(n);return{baseName:s,level:a??void 0}}function De(i){const e={I:1,V:5,X:10},t=i.toUpperCase().split("");let s=0,n=0;for(const a of t.reverse()){const r=e[a];if(!r)return null;r<n?s-=r:(s+=r,n=r)}return s}function _(i){const e=[[10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]];let t=i,s="";for(const[n,a]of e)for(;t>=n;)s+=a,t-=n;return s||"I"}function Ue(i,e,t){const s=i.trim(),n=e?`${s} ${_(e)}`.trim():s;return t&&t.trim().length>0?`${n} (${t.trim()})`.trim():n}function R(i){const e=i.split("+").map(s=>s.trim()).filter(s=>s.length>0);if(e.length===0)return;const t=e.map(s=>{const n=Number.parseInt(s,10);return Number.isNaN(n)?De(s)??void 0:n}).filter(s=>s!==void 0);if(t.length!==0)return Math.max(...t)}function N(i,e,t){t.unresolved.has(i)||t.unresolved.set(i,new Set),t.unresolved.get(i).add(e),t.warnings.push({type:"unresolved",section:i,value:e,message:`Eintrag "${e}" konnte im Abschnitt ${i} nicht aufgelöst werden.`})}function Pe(i,e){const t=i.locale,s=Array.isArray(t?.selectOptions)?t.selectOptions:[],n=b(e);for(const a of s){if(typeof a?.name!="string"||typeof a?.id!="number")continue;if(b(a.name)===n)return{id:a.id,name:a.name}}}function Ke(i){const e=i.locale;return Array.isArray(e?.selectOptions)&&e.selectOptions.length>0}function I(i){return i&&i.replace($e," ").replace(/\(\s*\)/g,"").replace(/\s*\+\s*/g,"+").replace(/\s+/g," ").trim().replace(_e,"").trim()}function x(i){let e=i.trim(),t;const s=[],n=()=>{const r=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);r&&(t=r[1]?.trim(),e=e.slice(0,r.index).trim())};for(n();;){const r=e.match(/\(([^)]+)\)\s*$/);if(!r)break;const o=r[1]?.trim();o&&s.unshift(o),e=e.slice(0,r.index).trim()}t||n();const a=t?R(t):void 0;return{baseName:e,options:s,level:a??void 0}}function Fe(i,e,t){let s;for(const[n,a]of e.entries()){if(Math.abs(n.length-i.length)>t)continue;const r=Ve(n,i,t);if(r!==void 0&&(!s||r<s.distance)&&(s={entry:a,normalized:n,distance:r},r===0))return s}return s}function Ve(i,e,t){const s=i.length,n=e.length;if(Math.abs(s-n)>t)return;if(s===0)return n<=t?n:void 0;if(n===0)return s<=t?s:void 0;const a=Array.from({length:n+1},(c,l)=>l),r=new Array(n+1);for(let c=1;c<=s;c+=1){r[0]=c;let l=r[0];const u=i.charAt(c-1);for(let m=1;m<=n;m+=1){const h=u===e.charAt(m-1)?0:1;r[m]=Math.min(a[m]+1,r[m-1]+1,a[m-1]+h),l=Math.min(l,r[m])}if(l>t)return;a.splice(0,a.length,...r)}const o=a[n];return o<=t?o:void 0}function q(i,e,t){const s=[];for(const n of i){const a=I(n);if(/^muttersprache\b/i.test(a)){e.add(X(a));continue}const r=x(a),o=b(r.baseName);if(t.languages.get(o)??t.scripts.get(o)){r.level!==void 0?e.add(`${r.baseName} ${_(r.level)}`):e.add(r.baseName);continue}s.push(n)}return s}function We(i){const e=new Set;for(const t of Object.values(i)){if(!t)continue;const s=t.split(/;+/);for(const n of s){const a=n.trim();if(!a)continue;const r=a.match(/^Paktgeschenke?:\s*(.+)$/i);if(r){const o=r[1]?.trim();o&&e.add(o)}}}return Array.from(e)}function xe(i,e){const t=new Set,s=new Set,n=new Set,a=(r,o)=>{const c=I(r);if(!c)return;if(/^muttersprache\b/i.test(c)){const A=X(c);n.add(A);return}const{label:l,baseLabel:u,detail:m}=qe(c),h=b(u);let p=e.advantages.byName.get(h),v=e.disadvantages.byName.get(h);if(!p&&!v&&m){const A=b(`${u} (${m})`);p=e.advantages.byName.get(A),v=e.disadvantages.byName.get(A)}if(p&&!v){t.add(l);return}if(v&&!p){s.add(l);return}if(p&&v){o==="advantage"?t.add(l):s.add(l);return}const d=Ge(l);if(d==="advantage"){t.add(l);return}if(d==="disadvantage"){s.add(l);return}o==="advantage"?t.add(l):s.add(l)};for(const r of i.advantages)a(r,"advantage");for(const r of i.disadvantages)a(r,"disadvantage");return{advantages:Array.from(t),disadvantages:Array.from(s),languages:Array.from(n)}}function qe(i){let e=i.trim();const t=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);let s;t&&(s=t[1],e=e.slice(0,t.index).trim());let n;const a=e.match(/^Angst vor\s+(.+)$/i);if(a){const u=a[1]?.trim();u&&(n=u),e="Angst vor"}const r=e.match(/\s*\(([^)]+)\)\s*$/);if(r&&(n=r[1],e=e.slice(0,r.index).trim()),!s){const u=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);u&&(s=u[1],e=e.slice(0,u.index).trim())}const o=Xe(e);let c=o;const l=s?R(s):void 0;return l&&(c=`${c} ${_(l)}`.trim()),n&&(c=`${c} (${n})`.trim()),{label:c,baseLabel:o,detail:n}}function X(i){let e=i.replace(/^muttersprache/i,"").trim();if(!e)return"Garethi III";const t=e.match(/([IVX\d]+)$/i);let s;t&&(s=t[1],e=e.slice(0,t.index).trim());const n=R(s??"III")??3;return`${e} ${_(n)}`.trim()}function Xe(i){const e=b(i);return ze[e]??i}const He=["beidhändig","dunkelsicht","richtungssinn","entfernungssinn","zauberer","zäher hund","blutrausch","herausragender sinn","giftresistenz"],je=["schlechte eigenschaft","eingeschränkter sinn","angst vor","blind","kälteempfindlich","zauberanfällig"];function Ge(i){const e=b(i);return He.some(t=>e.includes(t))?"advantage":je.some(t=>e.includes(t))?"disadvantage":"unknown"}const Ze=/^(MU|KL|IN|CH|FF|GE|KO|KK)(\s+\d{1,2})\s+(MU|KL|IN|CH|FF|GE|KO|KK)/,H=/([A-Za-zÄÖÜäöüß/+\-]+)\s+([^\s]+)/g,Be=/^([A-Za-zÄÖÜäöüß0-9\s/+\-&]+):\s*(.*)$/,Ye=["MU","KL","IN","CH","FF","GE","KO","KK"],Je={vorteile:"advantages",nachteile:"disadvantages",sonderfertigkeiten:"specialAbilities",kampfsonderfertigkeiten:"combatSpecialAbilities",kampfsonderfertigkeit:"combatSpecialAbilities",sprachen:"languages",talente:"talents",rsbe:"armor",aktionen:"actions",liturgien:"liturgies",liturgie:"liturgies",zauber:"spells",zaubersprüche:"spells",zaubertricks:"spells",rituale:"rituals",rituellezauber:"rituals",ausrüstung:"equipment",gegenstände:"equipment",inventar:"equipment",segnungen:"blessings",kampfverhalten:"notes",kampfverhaltenundflucht:"notes",flucht:"notes",schmerz:"notes","vorteile/nachteile":"advantages-disadvantages",vorteilenachteile:"advantages-disadvantages"},Qe={sinesschärfe:"Sinnesschärfe"};function et(i){const e=[],t=tt(i),s=t.split(`
`).map(f=>f.trim()).filter(f=>f.length>0);if(s.length===0)return{model:gt(),warnings:[{type:"parse-error",message:"Eingabetext ist leer."}],normalizedSource:t};const n=[...s],a=n.shift()??"Unbekannt",r=[];for(;n.length>0;){const f=n[0];if(!f||!Ze.test(f))break;r.push(n.shift())}const o=nt(r.join(" "),e),c={},l=n[0];l?.startsWith("LeP")?(j(l,c),n.shift()):e.push({type:"missing-section",section:"resources",message:"LeP/AsP/KaP-Zeile nicht gefunden."});const u=n[0];u?.startsWith("AW")&&(j(u,c),n.shift());const m=[];for(;n.length>0;){const f=n[0];if(!f||!st(f))break;n.shift();const L=it(f,e);L&&m.push(L)}const h=[...n],{sections:p,extras:v}=rt(h),d={advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],talents:[],spells:[],liturgies:[],rituals:[],blessings:[],equipment:[]},A=new Set,z={};let M,$;for(const f of p){const L=ot(f.heading),g=K(f.content);if(!L){z[f.heading]=g;continue}switch(A.add(L),L){case"advantages":w(d.advantages,g);break;case"disadvantages":w(d.disadvantages,g);break;case"advantages-disadvantages":A.add("advantages"),A.add("disadvantages"),g.toLowerCase()!=="keine"&&ct(d,g);break;case"specialAbilities":{const{primary:bt,trailing:J}=mt(g,"Talente:");w(d.specialAbilities,bt),J&&G(d.talents,J);break}case"combatSpecialAbilities":w(d.combatSpecialAbilities,g);break;case"languages":w(d.languages,g);break;case"talents":G(d.talents,g);break;case"spells":w(d.spells,g);break;case"liturgies":w(d.liturgies,g);break;case"rituals":w(d.rituals,g);break;case"blessings":w(d.blessings,g);break;case"equipment":w(d.equipment,g);break;case"armor":M=g;break;case"actions":$=S(g);break;case"notes":default:z[f.heading]=g;break}}for(const f of["advantages","disadvantages","specialAbilities","talents"])A.has(f)||e.push({type:"missing-section",section:f,message:`Abschnitt "${f}" nicht gefunden.`});return{model:{name:a,attributes:o,pools:c,armor:M,actions:$??null,weapons:m,advantages:E(d.advantages),disadvantages:E(d.disadvantages),specialAbilities:E(d.specialAbilities),combatSpecialAbilities:E(d.combatSpecialAbilities),languages:E(d.languages),spells:F(d.spells,"spells",e),liturgies:F(d.liturgies,"liturgies",e),rituals:F(d.rituals,"rituals",e),blessings:E(d.blessings),equipment:E(d.equipment),talents:ft(d.talents,e),notes:z,extras:v},warnings:e,normalizedSource:t}}function tt(i){let e=i.replace(/\r\n/g,`
`).replace(/\t/g," ");return e=e.replace(/([A-Za-zÄÖÜäöüß])-\s*\n\s*([A-Za-zÄÖÜäöüß])/g,"$1$2"),e=e.replace(/–/g,"-"),e=e.split(`
`).map(t=>t.trimEnd()).join(`
`),e.trim()}function nt(i,e){const t={};if(!i)return e.push({type:"missing-section",section:"attributes",message:"Eigenschaftszeilen nicht gefunden."}),t;const s=/(MU|KL|IN|CH|FF|GE|KO|KK)\s+(\d{1,2})/g;let n;for(;(n=s.exec(i))!==null;){const a=n[1],r=n[2];if(!a||!r)continue;const o=a,c=Number.parseInt(r,10);t[o]=Number.isNaN(c)?void 0:c}for(const a of Ye)t[a]===void 0&&e.push({type:"parse-error",section:"attributes",message:`Eigenschaft ${a} konnte nicht gelesen werden.`});return t}function j(i,e){for(const t of i.matchAll(H)){const s=t[1],n=t[2];if(!s||!n)continue;const a=S(n);switch(s){case"LeP":e.lep=a;break;case"AsP":e.asp=a;break;case"KaP":e.kap=a;break;case"INI":e.ini=n;break;case"AW":e.aw=a;break;case"SK":e.sk=a;break;case"ZK":e.zk=a;break;case"GS":e.gs=a;break}}}function S(i){const e=i.replace(/[^0-9\-]/g,"");if(!e)return null;const t=Number.parseInt(e,10);return Number.isNaN(t)?null:t}function st(i){return/^[^:]+:\s+(AT|FK)\s+/i.test(i)}function it(i,e){const[t,s]=i.split(":");if(!s){e.push({type:"parse-error",section:"weapons",message:`Zeile "${i}" enthält keinen Doppelpunkt.`});return}const n=(t??"").trim(),a={};for(const u of s.matchAll(H)){const m=u[1],h=u[2];if(!m||!h)continue;const p=m.toUpperCase();a[p]=h}const r=a.AT?S(a.AT):null,o=a.PA?S(a.PA):null,c=a.FK?S(a.FK):null,l=at(n,r,c);return{name:n,category:l,attack:r,parry:o,rangedAttack:c,damage:a.TP??null,range:a.RW??null,load:a.LZ??null,reach:a.RE??null,notes:a.BEM??null,raw:a}}function at(i,e,t){return i.toLowerCase().includes("waffenlos")?"unarmed":t!==null?"ranged":e!==null?"melee":"unknown"}function rt(i){const e=[],t=[];let s=null,n=[];const a=()=>{s?e.push({heading:s,content:n.join(" ").trim()}):n.length>0&&t.push(n.join(" ").trim()),s=null,n=[]};for(const r of i){const o=r.trim();if(!o)continue;const c=o.match(Be);if(c){a();const l=c[1]?.trim();s=l&&l.length>0?l:null;const u=c[2]?.trim();n=u?[u]:[];continue}s?n.push(o):t.push(o)}return a(),{sections:e,extras:t}}function ot(i){const e=i.toLowerCase().replace(/\s+/g,"").replace(/[()]/g,"");return e.startsWith("schmerz")||e==="kampfverhaltenflucht"?"notes":Je[e]??null}function w(i,e){if(e)for(const t of P(e))i.push(t)}function G(i,e){if(!(!e||e.toLowerCase()==="keine"))for(const t of P(e))i.push(t)}function P(i){const e=[];let t="",s=0;for(const n of i){if(n==="("?s+=1:n===")"&&(s=Math.max(s-1,0)),(n===","||n===";")&&s===0){t.trim()&&e.push(t.trim()),t="";continue}t+=n}return t.trim()&&e.push(t.trim()),e.map(n=>O(n))}function ct(i,e){for(const t of P(e)){const s=dt(t);for(const n of s){const a=lt(n);a==="disadvantage"?i.disadvantages.push(n):a==="advantage"?i.advantages.push(n):(i.advantages.push(n),i.disadvantages.push(n))}}}function lt(i){const e=i.toLowerCase();return["schlechte eigenschaft","verpflicht","feindschaft","hass","arm","krankheit","unfähig","vorurteil","schulden","angst","zauberanfällig"].some(n=>e.includes(n))?"disadvantage":["begabung","adelig","gutaussehend","vorteil","resistenz","richtungssinn","entfernungssinn"].some(n=>e.includes(n))?"advantage":"both"}function E(i){return i.map(e=>K(e)).map(e=>O(e)).map(e=>ut(e)).map(e=>Z(e)).map(e=>K(e)).map(e=>e.endsWith(".")?e.slice(0,-1):e).filter(e=>e.length>0).filter(e=>{const t=e.toLowerCase();return t!=="keine"&&t!=="keiner"&&t!=="keinen"&&t!=="entfällt"})}function K(i){return i.replace(/\s+/g," ").trim()}function O(i){return i.replace(/([A-Za-zÄÖÜäöüß])-\s+([A-Za-zÄÖÜäöüß])/g,"$1$2")}function ut(i){let e=i.replace(/([IVX]+)\s*AKO\d+/gi,"$1").replace(/([IVX]+)AKO\d+/gi,"$1");return e=e.replace(/AKO[IVX\d]+/gi,""),e=e.replace(/\s{2,}/g," "),e.trim()}function Z(i){let e=i;for(const[t,s]of Object.entries(Qe)){const n=new RegExp(`\\b${t}\\b`,"gi");e=e.replace(n,s)}return e}function dt(i){const e=[];let t="",s=0;for(const n of i){if(n==="("?s+=1:n===")"&&(s=Math.max(s-1,0)),n==="/"&&s===0){t.trim()&&e.push(t.trim()),t="";continue}t+=n}return t.trim()&&e.push(t.trim()),e}function mt(i,e){const t=i.toLowerCase(),s=e.toLowerCase(),n=t.indexOf(s);if(n===-1)return{primary:i};const a=i.slice(0,n).trim().replace(/[;,]+$/,""),r=i.slice(n+e.length).trim();return{primary:a.length>0?a:"",trailing:r.length>0?r:void 0}}function ft(i,e){const t=[];for(const s of i){const a=s.trim().match(/^(.+?)\s+(-?\d+)$/);if(!a){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${s}"`});continue}const r=O(a[1]??""),o=a[2];if(!r||!o){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${s}"`});continue}const c=Z(r.replace(/\*+$/,"").trim()),l=Number.parseInt(o,10);if(Number.isNaN(l)){e.push({type:"parse-error",section:"talents",message:`Talentwert ist keine Zahl: "${s}"`});continue}t.push({name:c,value:l})}return t}function F(i,e,t){const s=[];for(const n of E(i)){const a=n.match(/^(.+?)\s+(-?\d+|[IVX]+)$/i);if(!a){s.push({name:n,value:0}),t.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${n}"`});continue}const r=O(a[1]??""),o=a[2];if(!r||!o){t.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${n}"`});continue}const c=r.trim(),l=o.trim();let u=Number.parseInt(l,10);if(Number.isNaN(u)&&(u=pt(l.toUpperCase())),!u||Number.isNaN(u)){t.push({type:"parse-error",section:e,message:`Numerischer Wert für ${e} ist ungültig: "${n}"`});continue}s.push({name:c,value:u})}return s}function pt(i){const e={I:1,V:5,X:10,L:50,C:100},t=i.toUpperCase().split("");let s=0,n=0;for(const a of t.reverse()){const r=e[a];if(!r)return null;r<n?s-=r:(s+=r,n=r)}return s}function gt(){return{name:"Unbekannt",attributes:{},pools:{},armor:void 0,actions:null,weapons:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],spells:[],liturgies:[],rituals:[],blessings:[],equipment:[],talents:[],notes:{},extras:[]}}let C,B;self.addEventListener("message",async i=>{const e=i.data;if(!(!e||e.type!=="convert"))try{const t=await ht(e.payload.baseUrl),s=et(e.payload.source),n=Re(s.model,t),{hero:a,warnings:r}=be({dataset:t,parsed:s,resolved:n}),o={type:"result",payload:{exported:a,exportedWarnings:r,manifest:t.manifest,normalizedSource:s.normalizedSource,parserWarnings:s.warnings,resolverWarnings:n.warnings,unresolved:n.unresolved}};postMessage(o)}catch(t){const s={type:"error",error:t instanceof Error?t.message:String(t)};postMessage(s)}});async function ht(i){const e=new URL("data/optolith/manifest.json",i).toString();if(C&&B===e)return C;const t=await fetch(e);if(!t.ok)throw new Error(`Manifest konnte nicht geladen werden (${t.status})`);const s=await t.json(),n=async r=>{const o=new URL(`data/optolith/${r}`,i).toString(),c=await fetch(o);if(!c.ok)throw new Error(`Datensatz ${r} konnte nicht geladen werden (${c.status})`);return c.json()},a={manifest:s,advantages:await n(T(s,"advantages")),disadvantages:await n(T(s,"disadvantages")),specialAbilities:await n(T(s,"specialAbilities")),skills:await n(T(s,"skills")),combatTechniques:await n(T(s,"combatTechniques")),spells:await n(T(s,"spells")),liturgies:await n(T(s,"liturgies")),blessings:await n(T(s,"blessings")),equipment:await n(T(s,"equipment"))};return C=Q(a),B=e,C}function T(i,e){const t=i.sections.find(s=>s.key===e);if(!t)throw new Error(`Manifestabschnitt fehlt: ${e}`);return t.file}})();
