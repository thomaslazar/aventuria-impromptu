(function(){"use strict";function k(t){return t.toLocaleLowerCase("de-DE").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim()}function Me(t){const e=L(t.specialAbilities),n=Pe(t.books);return{manifest:t.manifest,advantages:L(t.advantages),disadvantages:L(t.disadvantages),specialAbilities:e,skills:L(t.skills),combatTechniques:L(t.combatTechniques),spells:L(t.spells),cantrips:L(t.cantrips),liturgies:L(t.liturgies),blessings:L(t.blessings),equipment:L(t.equipment),languages:Y(t.specialAbilities,"SA_29"),scripts:Y(t.specialAbilities,"SA_27"),citationPattern:De(n),blessedTraditions:Q(t.blessedTraditions),magicalTraditions:Q(t.magicalTraditions),properties:L(t.properties),equipmentPackages:Ce(t.equipmentPackages)}}function L(t){const e=new Map,n=new Map;for(const i of t){e.set(i.id,i),n.set(i.normalizedName,i);for(const r of i.synonyms??[]){const a=k(r);a&&(n.has(a)||n.set(a,i))}const s=typeof i.locale?.name=="string"?String(i.locale.name):void 0;if(s){const r=k(s);r&&!n.has(r)&&n.set(r,i)}}return{byId:e,byName:n}}function Y(t,e){const n=t.find(o=>o.id===e),i=new Map;if(!n)return i;const s=n.locale,r=Array.isArray(s?.selectOptions)?s.selectOptions:[],a=typeof n.base=="object"&&n.base!==null?Number.parseInt(String(n.base.levels??""),10):void 0;for(const o of r){if(!o||typeof o.name!="string"||typeof o.id!="number")continue;const c=k(o.name);i.set(c,{ability:n,optionId:o.id,name:o.name,normalizedName:c,maxLevel:Number.isFinite(a)?a:void 0})}return i}function Q(t){const e=new Map;for(const n of t)e.set(n.id,n);return e}function Ce(t){const e=new Map,n=(i,s)=>{e.has(i)||e.set(i,s)};for(const i of t){const s=Array.isArray(i.base?.items)?(i.base.items??[]).filter(o=>typeof o?.id=="string"):[],r={name:i.name,items:s},a=J(i.name);n(a,r);for(const o of i.synonyms??[])typeof o!="string"||o.length===0||n(J(o),r)}return e}function J(t){return k(t).replace(/\s+/g,"")}function Pe(t){const e=new Set;for(const n of t){const i=String(n.locale?.short??"").trim();if(!i)continue;const s=i.replace(/\s+/g,"");if(s){e.add(s);let r=s;for(;r.length>1&&/[IVXLCDM]$/i.test(r.charAt(r.length-1));)r=r.slice(0,-1),e.add(r)}}return[...e].sort((n,i)=>i.length-n.length)}function De(t){if(t.length===0)return null;const e=t.map(i=>i.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")).filter(i=>i.length>0);if(e.length===0)return null;const n=`(?:${e.join("|")})\\s*-?\\s*\\d{1,4}`;return new RegExp(n,"giu")}function ee(t){return t===void 0||t<=8?0:Math.floor((t-8)/3)}function Ve(t){if(!t)return{at:0,fk:0};const n=t.base?.special;return{at:typeof n?.at=="number"?n.at:0,fk:typeof n?.fk=="number"?n.fk:0}}function qe(t){if(t.combatTechnique?.id)return t.combatTechnique.id;if(t.fallback==="unarmed")return"CT_9"}function Ke(t,e,n){const i=t.model.attributes.MU??0,s=t.model.attributes.FF??0,r=[],a=[],o=new Map,c=(l,m,h,g)=>{const b=Math.max(6,Math.round(h)),f=o.get(l);if(f){if(f.sources.some(A=>A.name===g)||f.sources.push({name:g,value:b}),b>f.value&&(f.value=b),new Set(f.sources.map(A=>A.value)).size>1){const A=f.sources.map(v=>`${v.name} ⇒ ${v.value}`).join(", ");a.push(`[Exporter] combatTechniques: Technik ${m??l} hat widersprüchliche Werte (${A}).`)}}else o.set(l,{value:b,sources:[{name:g,value:b}]})},u=l=>n.combatTechniques.byId.get(l)?.name;for(const l of e.weapons){const m=qe(l);if(!m)continue;const h=Ve(l.match),g=u(m);let b,f=0,d=0;const A=l.source.attack??null,v=l.source.rangedAttack??null;if(l.source.attack!==null&&l.source.attack!==void 0?(f=ee(i),d=h.at,b=l.source.attack-f-d):l.source.rangedAttack!==null&&l.source.rangedAttack!==void 0&&(f=ee(s),d=h.fk,b=l.source.rangedAttack-f-d),b===void 0)continue;const y=Math.max(6,Math.round(b));r.push({weaponName:l.source.name,combatTechniqueId:m,combatTechniqueName:g,derivedValue:y,sourceAttack:A,sourceRangedAttack:v,attributeBonus:f,weaponModifier:d,fallback:l.fallback}),c(m,g,b,l.source.name)}for(const l of t.model.combatTechniques??[]){const m=k(l.name);if(!m)continue;const h=n.combatTechniques.byName.get(m);if(!h){a.push(`[Exporter] combatTechniques: Kampftechnik "${l.name}" konnte nicht aufgelöst werden.`);continue}c(h.id,h.name,l.value,l.name)}return{values:Object.fromEntries(Array.from(o.entries()).map(([l,m])=>[l,m.value])),warnings:a,details:r}}const Ue="1.5.1",xe=3,We=1100,te="1.0.0",Fe="EL_1",Ge="R_1",Be="C_1",je="P_1",He="m",Xe="Unbekannt",Ze="Unbekannt",Ye="Unbekannt",Qe="Unbekannt",Je="Unbekannt",et="Unbekannt",tt=2,nt="Unbekannt",ne={MU:"ATTR_1",KL:"ATTR_2",IN:"ATTR_3",CH:"ATTR_4",FF:"ATTR_5",GE:"ATTR_6",KO:"ATTR_7",KK:"ATTR_8"},it=Object.fromEntries(Object.entries(ne).map(([t,e])=>[e,t])),st="ADV_12",rt="ADV_50",at="SA_563",ot="SA_772",ct="ADV_24",lt="ADV_23",ut="DISADV_27",mt="DISADV_26",ie=6,dt={Blessing:t=>t.blessings,Cantrip:t=>t.cantrips,LiturgicalChant:t=>t.liturgies,Property:t=>t.properties,Skill:t=>t.skills,Spell:t=>t.spells},ft={Blessing:"BLESSING",Cantrip:"CANTRIP",LiturgicalChant:"LITURGY",Property:"PROPERTY",Skill:"TAL",Spell:"SPELL"};function pt({dataset:t,parsed:e,resolved:n}){if(t.manifest.schemaVersion!==te)throw new Error(`Unsupported dataset schema version: ${t.manifest.schemaVersion}. Expected ${te}.`);const i=new Date().toISOString(),s=Pt(),r=gt(e,n,t),a=Lt(n,t),o=St(n),c=B(n.spells),u=B(n.liturgies),l=B(n.rituals),m=Ke(e,n,t),h={clientVersion:Ue,dateCreated:i,dateModified:i,id:s,phase:xe,locale:t.manifest.locale,name:n.name,ap:{total:We},el:Fe,r:Ge,c:Be,p:je,sex:ht(e),pers:Ot(),attr:r,activatable:a,talents:o,spells:c,liturgies:u,blessings:$t(n),cantrips:_t(n),rituals:l,ct:m.values,belongings:Mt(n),rules:Rt(),pets:{}},g=zt(e,n,m.warnings);return{hero:h,warnings:g}}function ht(t){const e=t.model.name.trim().toLowerCase(),n=t.normalizedSource.toLowerCase();return["kriegerin","magierin","priesterin","jägerin","herrin","schamanin","meisterin","händlerin","frau "].some(r=>n.includes(r))?"f":["schamane","priester","magier","herr ","krieger"].some(r=>n.includes(r))?"m":e.endsWith("in")||e.endsWith("a")?"f":He}function gt(t,e,n){const i=Object.entries(ne).map(([a,o])=>{const c=t.model.attributes[a]??0;return{id:o,value:typeof c=="number"?c:0}}).sort((a,o)=>a.id.localeCompare(o.id)),s=bt(t,e,n),r=kt(t,e,n);return{values:i,attributeAdjustmentSelected:"ATTR_4",ae:r,kp:s,lp:0,permanentAE:{lost:0,redeemed:0},permanentKP:{lost:0,redeemed:0},permanentLP:{lost:0}}}function bt(t,e,n){const i=t.model.pools.kap;if(typeof i!="number"||i<=0||!se(e,st))return 0;const s=oe(e,n.blessedTraditions);if(!s)return 0;const r=ce(s),a=le(t,r);if(a===null)return 0;const o=ue(e.specialAbilities,at),c=re(e.advantages,ct),u=ae(e.disadvantages,ut),l=20+a+o*ie+c-u,m=i-l;return m>0?m:0}function kt(t,e,n){const i=t.model.pools.asp;if(typeof i!="number"||i<=0||!se(e,rt))return 0;const s=oe(e,n.magicalTraditions);if(!s)return 0;const r=ce(s),a=le(t,r);if(a===null)return 0;const o=ue(e.specialAbilities,ot),c=re(e.advantages,lt),u=ae(e.disadvantages,mt),l=20+a+o*ie+c-u,m=i-l;return m>0?m:0}function se(t,e){return t.advantages.some(n=>n.match?.id===e)}function re(t,e){return t.find(i=>i.match?.id===e)?.level??0}function ae(t,e){return t.find(i=>i.match?.id===e)?.level??0}function oe(t,e){for(const n of t.specialAbilities){const i=n.match;if(i&&e.has(i.id))return e.get(i.id)}}function ce(t){if(!t)return;const e=t.base;return typeof e?.primary=="string"?e.primary:void 0}function le(t,e){if(!e)return null;const n=it[e];if(!n)return null;const i=t.model.attributes[n];return typeof i=="number"?i:null}function ue(t,e){return t.find(i=>i.match?.id===e)?.level??0}function At(t){const e=t.rawOption?.trim();if(e&&e.length>0)return e;const i=t.source?.match(/\(([^)]+)\)/)?.[1]?.trim();return i&&i.length>0?i:void 0}function vt(t,e){if(!t.match)return;const n=t.match.normalizedName,i=At(t);if(n==="korperliche auffalligkeit"||n==="schlechte angewohnheit"||n==="prinzipientreue"){const s={...i?{sid:i}:{}};return t.level&&(s.tier=t.level),s}if(n==="ortskenntnis"&&i){const s={sid:i};return t.level&&(s.tier=t.level),s}if(n==="fertigkeitsspezialisierung"){const s=Et(i,t.level,e);if(s)return s}if(n==="lieblingsliturgie"&&t.linkedOption){const s=wt(t.linkedOption,e);if(s){const r={sid:s};return t.level&&(r.tier=t.level),r}}}function Et(t,e,n){if(!t)return;const i=yt(t);if(!i?.skillName)return;const s=k(i.skillName);if(!s)return;const r=n.skills.byName.get(s);if(!r)return;const a={sid:r.id};if(i.applicationName){const o=Tt(r,i.applicationName);o!==void 0&&(a.sid2=o)}return e&&(a.tier=e),a}function yt(t){const e=t.trim();if(!e)return;const n=e.indexOf(":");if(n>=0)return{skillName:e.slice(0,n).trim(),applicationName:e.slice(n+1).trim()};const i=e.match(/^(.*?)\s*[–-]\s*(.+)$/u);if(i&&i[1]&&i[2])return{skillName:i[1].trim(),applicationName:i[2].trim()};const s=e.match(/^(.*?)\s*\((.+)\)$/u);return s&&s[1]?{skillName:s[1].trim(),applicationName:s[2]?.trim()}:{skillName:e}}function Tt(t,e){const n=t.locale,i=Array.isArray(n?.applications)?n.applications:[],s=k(e);if(s)for(const r of i){if(typeof r?.id!="number"||typeof r?.name!="string")continue;const a=k(r.name);if(a&&a===s)return r.id}}function wt(t,e){const n=dt[t.type];if(!n)return;const i=n(e),s=ft[t.type];if(s){const r=`${s}_${t.value}`,a=i.byId.get(r);if(a)return a.id}for(const r of i.byId.values())if(It(r.id)===t.value)return r.id}function It(t){const e=t.match(/_(\d+)$/);if(!e)return;const n=Number.parseInt(e[1]??"",10);return Number.isNaN(n)?void 0:n}function Nt(t){const e=t.rawOption?.trim();if(e&&e.length>0)return e;const i=t.source?.match(/\(([^)]+)\)/)?.[1]?.trim();return i&&i.length>0?i:void 0}function Lt(t,e){const n={},i=(r,a)=>{n[r]||(n[r]=[]),n[r].push(a)},s=r=>{if(!r.match)return;const a=vt(r,e);if(a){i(r.match.id,a);return}const o={};if(r.match.normalizedName==="prinzipientreue"){const c=Nt(r);c&&(o.sid=c),r.level&&(o.tier=r.level),i(r.match.id,o);return}r.selectOption&&(o.sid=r.selectOption.id),r.linkedOption?o.options=[{type:"Predefined",id:r.linkedOption}]:r.rawOption&&r.rawOption.trim()&&(o.options=[{type:"Custom",value:r.rawOption.trim()}]),r.level&&(o.tier=r.level),r.source&&(o.label=r.source),i(r.match.id,o)};return t.advantages.forEach(s),t.disadvantages.forEach(s),t.specialAbilities.forEach(s),t.combatSpecialAbilities.forEach(s),t.languages.forEach(r=>{if(!r.match)return;const a={};r.option&&(a.sid=r.option.optionId),!r.option&&r.rawOption?.trim()&&(a.options=[{type:"Custom",value:r.rawOption.trim()}]),r.level&&(a.tier=r.level),a.label=r.source,i(r.match.id,a)}),t.scripts?.forEach(r=>{if(!r.match)return;const a={};r.option&&(a.sid=r.option.optionId),!r.option&&r.rawOption?.trim()&&(a.options=[{type:"Custom",value:r.rawOption.trim()}]),a.label=r.source,i(r.match.id,a)}),n}function St(t){const e={};for(const n of t.talents)n.match&&(e[n.match.id]=n.source.value);return e}function B(t){const e={};for(const n of t)n.match&&(e[n.match.id]=n.value);return e}function $t(t){const e=new Set;for(const n of t.blessings)n.match&&e.add(n.match.id);return Array.from(e)}function zt(t,e,n=[]){const i=[],s=new Set,r=a=>{s.has(a)||(s.add(a),i.push(a))};for(const a of t.warnings)r(`[Parser] ${a.section??"general"}: ${a.message}`);for(const a of e.warnings)r(`[Resolver] ${a.section}: ${a.message}`);for(const[a,o]of Object.entries(e.unresolved))for(const c of o)r(`[Resolver] ${a}: unverarbeitet "${c}"`);if(e.weapons.forEach(a=>{!a.match&&a.fallback!=="unarmed"&&r(`[Exporter] weapons: Waffe "${a.source.name}" konnte nicht exportiert werden (keine Zuordnung).`)}),e.armor&&!e.armor.match&&!e.armor.isNaturalArmor){const a=e.armor.source.description??e.armor.source.notes??e.armor.source.raw;r(`[Exporter] armor: Rüstung "${a}" konnte nicht exportiert werden (keine Zuordnung).`)}return n.forEach(a=>r(a)),i}function _t(t){return t.cantrips.filter(e=>!!e.match?.id).map(e=>e.match.id)}function Rt(){return{higherParadeValues:0,attributeValueLimit:!1,enableAllRuleBooks:!0,enabledRuleBooks:[],enableLanguageSpecializations:!1}}function Ot(t){return{family:Xe,placeofbirth:Ze,dateofbirth:Ye,age:Qe,size:Je,weight:et,socialstatus:tt,cultureAreaKnowledge:nt}}function Mt(t){const e=[],n=s=>{e.push(s)};t.weapons.forEach(s=>{if(!s.match)return;const r=j(s.match,{name:s.source.name});s.combatTechnique?.id&&(r.combatTechnique=s.combatTechnique.id),n(r)}),t.armor?.match&&n(j(t.armor.match,{name:t.armor.source.description??t.armor.source.notes??t.armor.source.raw??t.armor.match.name})),t.equipment.forEach(s=>{if(!s.match)return;const r=s.quantityHint??Ct(s.source),a={name:s.source};typeof r=="number"&&(a.amount=r),n(j(s.match,a))});const i={};return e.forEach((s,r)=>{const a=`ITEM_${r+1}`;i[a]={id:a,...s}}),{items:i,armorZones:{},purse:{d:"0",s:"0",h:"0",k:"0"}}}function Ct(t){const e=t.match(/\((\d+)\s*(?:m|meter|metern|schritte?|schritt)\s*\)$/i);if(e?.[1]){const n=Number.parseInt(e[1],10);return Number.isNaN(n)?void 0:n}}function j(t,e={}){const n=t.base??{},i=n.special??{},s={template:t.id,amount:1,name:t.name,isTemplateLocked:!0,...e};for(const[o,c]of Object.entries(n))o==="special"||o==="id"||c===void 0||(s[o]=c);const r={};for(const[o,c]of Object.entries(i??{}))if(c!=null)switch(o){case"protection":s.pro=c;break;case"encumbrance":s.enc=c;break;case"closeRange":r.close=Number(c);break;case"mediumRange":r.medium=Number(c);break;case"farRange":r.far=Number(c);break;default:s[o]=c;break}const a=[r.close,r.medium,r.far].filter(o=>typeof o=="number"&&Number.isFinite(o));return a.length>0&&(s.range=a),e.name?s.name=e.name:s.name=t.name,e.amount&&(s.amount=e.amount),s}function Pt(){return`H_${Math.floor(1+Math.random()*9e9)}`}const Dt={"schlechte eigenschaften":"Schlechte Eigenschaft","schlechte eigenschaft":"Schlechte Eigenschaft",dammerungssicht:"Dunkelsicht",dammersicht:"Dunkelsicht",dunkesicht:"Dunkelsicht",verpflichtung:"Verpflichtungen",personlichkeitsschwache:"Persönlichkeitsschwächen",personlichkeitsschwachen:"Persönlichkeitsschwächen"},Vt=/[,:;]+$/,qt={peitsche:"fuhrmannspeitsche",speer:"speer",schwert:"langschwert",langschild:"gro schild",schild:"holzschild",dolch:"dolch",krummsabel:"sabel",krummsaebel:"sabel",platte:"plattenrustung",dietrichsets:"dietrich",dietrichset:"dietrich",seil:"kletterseil pro schritt"},Kt={phexkirche:"Moralkodex der Phexkirche",hesindekirche:"Moralkodex der Hesindekirche",perainekirche:"Moralkodex der Perainekirche",boronkirche:"Moralkodex der Boronkirche",praioskirche:"Moralkodex der Praioskirche",rondrakirche:"Moralkodex der Rondrakirche",efferdkirche:"Moralkodex der Efferdkirche",traviakirche:"Moralkodex der Traviakirche",firunkirche:"Moralkodex der Firunkirche",tsakirche:"Moralkodex der Tsakirche",ingerimmkirche:"Moralkodex der Ingerimmkirche",rahjakirche:"Moralkodex der Rahjakirche",aveskirche:"Moralkodex der Aveskirche",ifirnkirche:"Moralkodex der Ifirnkirche",korkirche:"Moralkodex der Korkirche",nanduskirche:"Moralkodex der Nanduskirche",swafnirkirche:"Moralkodex der Swafnirkirche"},Ut={tempel:"Geweihter gegenüber seinem Tempel",kirche:"Geweihter gegenüber seiner Kirche","geweihter gegenüber seinem tempel":"Geweihter gegenüber seinem Tempel","geweihter gegenüber seiner kirche":"Geweihter gegenüber seiner Kirche","magier gegenüber seinem lehrmeister":"Magier gegenüber seinem Lehrmeister","magier gegenüber seiner akademie":"Magier gegenüber seiner Akademie","magier gegenüber seiner gilde":"Magier gegenüber seiner Gilde"},xt={toten:"Toten und Untoten",tote:"Toten und Untoten","toten und untoten":"Toten und Untoten",untoten:"Toten und Untoten"},Wt={isdira:"Isdira- und Asdharia-Zeichen",asdharia:"Isdira- und Asdharia-Zeichen","isdira und asdharia zeichen":"Isdira- und Asdharia-Zeichen","isdiraund asdharia zeichen":"Isdira- und Asdharia-Zeichen","asdharia und isdira zeichen":"Isdira- und Asdharia-Zeichen",rogolan:"Rogolan-Runen"},Ft={oloargh:"oloarkh"},Gt={"shakara hammer":"kriegshammer","shakara-hammer":"kriegshammer","shakagra hammer":"kriegshammer"},Bt=new Set(["specialAbilities","combatSpecialAbilities"]),jt=new Set(["schlechte eigenschaft","schlechte eigenschaften","schlechte angewohnheit","schlechte angewohnheiten"]),Ht="belastungsgewohnung",Xt=["Arroganz","Eitelkeit","Neid","Streitsucht","Unheimlich","Verwöhnt","Vorurteile","Weltfremd","Anzügliches Verhalten","Eifersucht","Busenkomplexe","Peniskomplexe","Stimmungsschwankungen"],me={ein:1,eine:1,einen:1,einem:1,einer:1,eins:1,zwei:2,drei:3,vier:4,fünf:5,sechs:6,sieben:7,acht:8,neun:9,zehn:10,elf:11,zwölf:12};new Set(Object.keys(me));const Zt=new Set(["berufsgeheimnis","ortskenntnis","merkmalskenntnisse","merkmalskenntnis"]),Yt={BLESSINGS:{type:"Blessing",lookup:t=>t.blessings},CANTRIPS:{type:"Cantrip",lookup:t=>t.cantrips},LITURGICAL_CHANTS:{type:"LiturgicalChant",lookup:t=>t.liturgies},PROPERTIES:{type:"Property",lookup:t=>t.properties},SKILLS:{type:"Skill",lookup:t=>t.skills},SPELLS:{type:"Spell",lookup:t=>t.spells}},Qt=/^(\d+)\s+(schritte?|schritt|meter|metern|m)\b\s*(.*)$/iu,Jt={lebensmittelverarbeitung:"Lebensmittelbearbeitung"};let C=null;function en(t,e){const n=C;C=Yn(e.citationPattern);try{const i={lookups:e,warnings:[],unresolved:new Map,warningKeys:new Set},s=Cn(t,e),r=new Set(s.languages),a=new Set,o=Ae([...t.specialAbilities,...Mn(t.notes)],r,a,e),c=Ae(t.combatSpecialAbilities,r,a,e),u=P(s.advantages,"advantages",i.lookups.advantages,i),l=P(s.disadvantages,"disadvantages",i.lookups.disadvantages,i),m=P(o,"specialAbilities",i.lookups.specialAbilities,i),h=P(c,"combatSpecialAbilities",i.lookups.specialAbilities,i),g=[...t.languages,...r],b=[...t.scripts,...a],f=on(g,i),d=cn(b,i),A=tn(t.talents,i),v=H(t.spells,"spells",i.lookups.spells,i),y=P(t.cantrips,"cantrips",i.lookups.cantrips,i),$=H(t.liturgies,"liturgies",i.lookups.liturgies,i),z=H(t.rituals,"rituals",i.lookups.spells,i),p=P(t.blessings,"blessings",i.lookups.blessings,i),T=P(t.equipment,"equipment",i.lookups.equipment,i),E=sn(m),_=rn(t.weapons,i),V=an(t.armor??null,i,E),Re={};for(const[R,ji]of i.unresolved.entries())Re[R]=Array.from(ji.values());const Wi=u.some(R=>R.match?.normalizedName==="zauberer"||R.normalizedSource==="zauberer"),Fi=typeof t.pools.asp=="number"&&t.pools.asp>0,Oe=m.some(R=>R.match?.normalizedName?.startsWith("tradition"));(Wi||Fi)&&!Oe&&I({type:"unresolved",section:"specialAbilities",value:"Tradition",message:"Statblock weist AsP/Zauberer auf, aber keine Tradition. Bitte Tradition manuell ergänzen."},i);const Gi=typeof t.pools.kap=="number"&&t.pools.kap>0,Bi=u.some(R=>R.match?.normalizedName==="geweihter"||R.normalizedSource==="geweihter");return Gi&&!Oe&&!Bi&&I({type:"unresolved",section:"specialAbilities",value:"Tradition",message:"Statblock weist KaP auf, aber keine geweihte Tradition oder Geweihter-Vorteil. Bitte Tradition manuell ergänzen."},i),{name:t.name,advantages:u,disadvantages:l,specialAbilities:m,combatSpecialAbilities:h,languages:f,scripts:d,talents:A,spells:v,cantrips:y,liturgies:$,rituals:z,blessings:p,equipment:T,weapons:_,armor:V,unresolved:Re,warnings:i.warnings}}finally{C=n}}function P(t,e,n,i){const s=[];for(const c of t){const u=M(c);u&&s.push(u)}const r=e==="blessings"?yn(s,n):s,a=[],o=(c,u)=>{if(e==="equipment"&&hn(c,i,o))return;const l=ke(c),m=k(l.baseName),h=dn(e,m),g=h&&u?bn(l.options):l.options;if(g.length>1&&h){for(const p of g)o(`${l.baseName} (${p})`,!1);return}let b=m,f=n.byName.get(b),d,A,v,y;if(!f&&g.length>0)for(const p of g){const T=`${l.baseName} (${p})`,E=k(T),_=n.byName.get(E);if(_){f=_,b=E,d=p;break}}if(f&&Ln(f)&&g.length>0)for(const p of g){const T=Nn(f,p);if(T){A=T,y=T.name;break}v||(v=p)}else g.length>0&&(y=d??g[0]);if(!y&&g.length>0&&(y=d??g[0]),!y&&d&&(y=d),f&&f.normalizedName==="begabung"&&g.length>0){const p=g[0],T=ln(p,i);T?(v=T.name,y=y??T.name):v=p}if(!v&&y&&(v=y),!f&&e==="equipment"){const p=fe(c,"equipment",i,g);p&&(f=p)}let $;if(f&&y){const p=fn(f,y,i);p&&($=p.linkedOption,y=p.label)}let z=mn(l.baseName,l.level,y);if(e==="equipment"&&l.quantityToken&&(z=`${z} ${l.quantityToken}`.trim()),!f&&e==="blessings"&&he(z)){a.push({source:z,normalizedSource:b,match:void 0,selectOption:A,level:l.level??void 0,rawOption:v});return}if(!f&&u&&Bt.has(e)){const p=ve(c);if(p.parts.length>1){p.usedOrConnector&&I({type:"split",section:e,value:c,message:`Eintrag "${c}" enthielt "oder"; alle Varianten wurden übernommen.`},i),p.parts.forEach(T=>o(T,!1));return}}f||O(e,z,i),a.push({source:z,normalizedSource:b,match:f,selectOption:A,level:l.level??void 0,rawOption:v,quantityHint:l.quantity,linkedOption:$})};return r.forEach(c=>o(c,!0)),a}function H(t,e,n,i){const s=[];for(const r of t){let a=M(r.name);if(!a){O(e,r.name,i);continue}let o=k(a),c=n.byName.get(o);if(!c){const u=a.replace(/\s*\([^)]*\)\s*$/,"").trim();if(u&&u!==a){const l=k(u),m=n.byName.get(l);m&&(a=u,o=l,c=m)}}c||O(e,a,i),s.push({source:a,normalizedSource:o,match:c,value:r.value})}return s}function tn(t,e){return t.map(n=>{const{baseName:i}=nn(n.name),s=k(i),r=Jt[s],a=r?k(r):s;let o=e.lookups.skills.byName.get(a)??e.lookups.skills.byName.get(s);if(!o){const c=Rn(s,e.lookups.skills.byName,1);c?(o=c.entry,I({type:"fuzzy-match",section:"talents",value:n.name,message:`Talent "${n.name}" wurde als "${o.name}" interpretiert (Schreibweise korrigiert).`},e)):O("talents",n.name,e)}return{source:n,match:o}})}function nn(t){const e=t.trim(),n=e.match(/^(.*?)(?:\s*\(([^)]+)\))$/u);return n&&n[1]?{baseName:n[1].trim(),application:n[2]?.trim()}:{baseName:e}}function sn(t){let e=0;for(const n of t){if(n.match?.normalizedName!==Ht)continue;const i=n.level??1;i>e&&(e=i)}return e}function rn(t,e){const n=[];for(const i of t){const s=M(i.name),r=k(s.length>0?s:i.name),a=i.category==="unarmed"||r==="waffenlos",o=Gt[r]??r;let c=o.length>0?e.lookups.equipment.byName.get(o):void 0,u,l;if(c||(c=fe(i.name,"weapons",e)),!c&&a&&(l="unarmed",u=e.lookups.combatTechniques.byId.get("CT_9"),u||I({type:"unresolved",section:"combatTechniques",value:"CT_9",message:"Kampftechnik Raufen (CT_9) konnte nicht geladen werden."},e)),c){const m=wn(c);m?(u=e.lookups.combatTechniques.byId.get(m),u||I({type:"unresolved",section:"combatTechniques",value:m,message:`Kampftechnik-ID "${m}" fehlt im Datensatz (für ${i.name}).`},e)):l||I({type:"unresolved",section:"weapons",value:i.name,message:`Waffe "${i.name}" enthält keine Kampftechnik im Datensatz.`},e)}!c&&!l&&O("weapons",i.name,e),n.push({source:i,normalizedSource:r,match:c,combatTechnique:u,fallback:l})}return n}function an(t,e,n){if(!t)return null;const s=(t.description??"").trim(),r=s.toLowerCase(),a=(t.notes??"").toLowerCase(),o=r.includes("keine")||r.includes("ohne"),c=(t.rs??0)>0||(t.be??0)>0||s.length>0,u=s.length===0||r.includes("natürlicher rüstungsschutz")||a.includes("natürlicher rüstungsschutz"),l=(t.rs??0)===0&&(t.be??0)===0&&/kleidung|gewand|robe|tracht/.test(r);if(!c||(t.rs??0)===0&&(t.be??0)===0&&o||l)return null;let m=s;s&&r.includes("normale kleidung")&&r.includes("oder nackt")&&(m="normale Kleidung");const h=M(m),g=h.length>0?k(h):void 0,b=g?e.lookups.equipment.byName.get(g):void 0;let f,d;if(b){const A=In(b);if(f=A?.protection,d=A?.encumbrance,A||I({type:"unresolved",section:"armor",value:b.name,message:`Rüstung "${b.name}" enthält keine RS/BE-Daten im Optolith-Katalog.`},e),typeof t.rs=="number"&&typeof f=="number"&&t.rs!==f&&I({type:"value-mismatch",section:"armor",value:s||b.name,message:`RS (${t.rs}) weicht vom Optolith-Wert (${f}) ab.`},e),typeof t.be=="number"&&typeof d=="number"&&t.be!==d){const v=n*2;n>0&&t.be<d&&d-t.be<=v||I({type:"value-mismatch",section:"armor",value:s||b.name,message:`BE (${t.be}) weicht vom Optolith-Wert (${d}) ab.`},e)}}else{const A=s||`RS ${t.rs??"-"} / BE ${t.be??"-"}`;if(u){const v=s.length>0?s:`RS ${t.rs??"-"} / BE ${t.be??"-"}`,y=s.length>0?s:`RS ${t.rs??"-"} / BE ${t.be??"-"}`;I({type:"fuzzy-match",section:"armor",value:v,message:`Eintrag "${y}" ohne Rüstungsbeschreibung; vermutlich natürlicher Rüstungsschutz.`},e)}else O("armor",A,e)}return{source:t,normalizedSource:g,match:b,datasetProtection:f??null,datasetEncumbrance:d??null,isNaturalArmor:!b&&u}}function on(t,e){return t.map(n=>M(n)).filter(n=>n.length>0).map(n=>{const i=de(n),s=k(i.baseName),r=Ft[s]??s,a=e.lookups.languages.get(r);return a?(i.level&&a.maxLevel&&i.level>a.maxLevel&&I({type:"level-out-of-range",section:"languages",value:n,message:`Sprachstufe ${i.level} überschreitet den erlaubten Bereich (${a.maxLevel}).`},e),{source:n,normalizedSource:s,match:a.ability,option:a,level:i.level??void 0}):(O("languages",n,e),{source:n,normalizedSource:s,rawOption:i.baseName})})}function cn(t,e){return t.map(n=>M(n)).filter(n=>n.length>0).map(n=>{const i=de(n),s=k(i.baseName),r=Wt[s],a=e.lookups.scripts.get(s)??(r?e.lookups.scripts.get(k(r)):void 0);return a?{source:n,normalizedSource:s,match:a.ability,option:a,level:i.level??void 0}:(O("scripts",n,e),{source:n,normalizedSource:s,rawOption:i.baseName})})}function de(t){const e=t.trim(),n=e.match(/^(.*?)(?:\s+([IVX\d]+(?:\+[IVX\d]+)*))?$/i);if(!n)return{baseName:e};const i=(n[1]??e).trim(),s=n[2]?.trim();if(!s)return{baseName:i};const r=U(s);return{baseName:i,level:r??void 0}}function ln(t,e){const n=k(t),i=e.lookups.skills.byName.get(n)??e.lookups.spells.byName.get(n)??e.lookups.liturgies.byName.get(n);if(i)return{id:i.id,name:i.name}}function un(t){const e={I:1,V:5,X:10},n=t.toUpperCase().split("");let i=0,s=0;for(const r of n.reverse()){const a=e[r];if(!a)return null;a<s?i-=a:(i+=a,s=a)}return i}function q(t){const e=[[10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]];let n=t,i="";for(const[s,r]of e)for(;n>=s;)i+=r,n-=s;return i||"I"}function mn(t,e,n){const i=t.trim(),s=e?`${i} ${q(e)}`.trim():i;return n&&n.trim().length>0?`${s} (${n.trim()})`.trim():s}function dn(t,e){return t==="specialAbilities"&&Zt.has(e)}function fn(t,e,n){const i=t.base,s=Array.isArray(i?.selectOptionCategories)?i.selectOptionCategories:[];if(s.length!==0)for(const r of s){const a=typeof r?.category=="string"?r.category:void 0;if(!a)continue;const o=Yt[a];if(!o)continue;const c=o.lookup(n.lookups),u=k(e),l=c.byName.get(u);if(!l)continue;const m=pn(l.id);if(m!==void 0)return{label:l.name,linkedOption:{type:o.type,value:m}}}}function pn(t){const e=t.match(/_(\d+)$/);if(!e)return;const n=Number.parseInt(e[1]??"",10);return Number.isNaN(n)?void 0:n}function hn(t,e,n){const i=e.lookups.equipmentPackages.get(gn(t));if(!i)return!1;I({type:"split",section:"equipment",value:t,message:`Ausrüstungspaket "${i.name}" wurde in einzelne Gegenstände zerlegt.`},e);for(const s of i.items){const r=e.lookups.equipment.byId.get(s.id);if(!r)continue;const a=typeof s.amount=="number"&&s.amount>1?`${s.amount} `:"";n(`${a}${r.name}`,!1)}return!0}function gn(t){return k(t).replace(/\s+/g,"")}function bn(t){if(t.length<=1){const e=[];for(const n of t){if(!n)continue;const i=n.split(/(?:\bund\b|\boder\b|\/)/i).map(s=>s.trim()).filter(s=>s.length>0);i.length>1?e.push(...i):e.push(n)}return e}return t.filter(e=>!!e)}function U(t){const e=t.split("+").map(i=>i.trim()).filter(i=>i.length>0);if(e.length===0)return;const n=e.map(i=>{const s=Number.parseInt(i,10);return Number.isNaN(s)?un(i)??void 0:s}).filter(i=>i!==void 0);if(n.length!==0)return Math.max(...n)}function O(t,e,n){n.unresolved.has(t)||n.unresolved.set(t,new Set),n.unresolved.get(t).add(e)}function I(t,e){const n=`${t.type}:${t.section}:${t.value}:${t.message}`;e.warningKeys.has(n)||(e.warningKeys.add(n),e.warnings.push(t))}function fe(t,e,n,i=[]){const s=kn(t,n.lookups.equipment,i);if(!s)return;const r=En(e,t,s.match.name,s);return I({type:"fuzzy-match",section:e,value:t,message:r},n),s.match}function kn(t,e,n){const i=k(t),s=An(t,n);for(const r of s){const a=k(r);if(!a||a===i)continue;const o=e.byName.get(a);if(o)return{match:o,token:r,reason:"token"}}for(const r of s){const a=k(r);if(a){for(const[o,c]of Object.entries(qt))if(a===o||a.includes(o)){const u=e.byName.get(c);if(u)return{match:u,token:r,reason:"keyword",keyword:o}}}}}function An(t,e){const n=new Set,i=r=>{if(!r)return;const a=r.trim();if(a.length===0)return;const o=be(_n(a));pe(n,o),o!==a&&pe(n,a)};i(t);const s=t.replace(/[()]/g," ");return s.split(/[-–—\/]/).forEach(r=>{i(r),r.split(/[,&]/).forEach(a=>i(a))}),s.split(/[,&]/).forEach(r=>i(r)),s.split(/\s+/).forEach(r=>i(r)),e.forEach(r=>i(r)),Array.from(n.values())}function pe(t,e){if(e){t.has(e)||t.add(e);for(const n of vn(e))n.length>0&&t.add(n)}}function vn(t){const e=new Set,n=t.trim(),i=n.toLowerCase();if(i.length<=2)return[];const s=a=>{a&&a!==n&&e.add(a)},r=(a,o="")=>{i.endsWith(a)&&n.length>a.length+1&&s(n.slice(0,n.length-a.length)+o)};return r("en"),r("en","e"),r("e"),r("er"),r("n"),r("s"),Array.from(e.values())}function En(t,e,n,i){const s=t==="weapons"?"Waffe":"Ausrüstungseintrag";if(i.reason==="keyword"){const r=i.keyword??i.token;return`${s} "${e}" wurde als "${n}" interpretiert (Schlüsselwort "${r}").`}return`${s} "${e}" wurde als "${n}" interpretiert (Teilbegriff "${i.token}").`}function he(t){const e=k(t);return e==="die zwolf segnungen"||e==="zwolf segnungen"||e==="12 segnungen"}function yn(t,e){const n=[],i=e.byId?Array.from(e.byId.values()):[];for(const s of t)he(s)&&i.length>0?i.forEach(r=>{n.push(Tn(r))}):n.push(s);return n}function Tn(t){const e=t.locale,n=e&&typeof e.name=="string"?String(e.name):null;return n&&n.length>0?n:t.name&&t.name.length>0?t.name:t.id}function wn(t){const e=t.base;if(!e||typeof e!="object")return;const n=e.special;if(!n||typeof n!="object")return;const i=n.combatTechnique;return typeof i=="string"?i:void 0}function In(t){const e=t.base;if(!e||typeof e!="object")return;const n=e.special;if(!n||typeof n!="object")return;const i=n.protection,s=n.encumbrance;if(!(typeof i!="number"&&typeof s!="number"))return{protection:typeof i=="number"?i:null,encumbrance:typeof s=="number"?s:null}}function Nn(t,e){const n=t.locale,i=Array.isArray(n?.selectOptions)?n.selectOptions:[],s=k(e);for(const r of i){if(typeof r?.name!="string"||typeof r?.id!="number")continue;if(k(r.name)===s)return{id:r.id,name:r.name}}}function Ln(t){const e=t.locale;return Array.isArray(e?.selectOptions)&&e.selectOptions.length>0}function M(t){if(!t)return t;const r=Sn(t).replace(/\(\s*\)/g,"").replace(/\s*\+\s*/g,"+").replace(/\s+/g," ").trim().replace(Vt,"").trim();return zn($n(r))}function Sn(t){if(!C)return t;C.lastIndex=0;const e=t.replace(C," ");return C.lastIndex=0,e}function $n(t){return t.replace(/(Tradition\s*\()([^)]*?)geweih(?:ter|te|ten)(\))/gi,(e,n,i,s)=>{const r=i.trim().replace(/[-\s]+$/g,"");if(!r)return`${n}${i}${s}`;const a=`${r}kirche`;return`${n}${a}${s}`})}function zn(t){const e={analys:"Analys Arkanstruktur",odem:"Odem Arcanum",zauberklinge:"Zauberklinge Geisterspeer"},n=k(t);return e[n]??t}function _n(t){return ge(t).remainder}function ge(t){let e=t.trim();if(!e)return{remainder:e};const n=e.match(Qt);if(n&&n[3]){const r=Number.parseInt(n[1]??"",10);return{remainder:n[3].trim(),quantity:Number.isNaN(r)?void 0:r}}const i=e.match(/^(\d+)\s+(.*)$/u);if(i&&i[2]){const r=Number.parseInt(i[1]??"",10);return{remainder:i[2].trim(),quantity:Number.isNaN(r)?void 0:r}}const s=e.match(/^([A-Za-zÄÖÜäöüß]+)\s+(.*)$/u);if(s&&s[2]){const r=s[1]?.toLowerCase();if(r){const a=me[r];if(a!==void 0)return{remainder:s[2].trim(),quantity:a}}}return{remainder:e}}function be(t){return t.replace(/\(\s*(?:x\s*)?\d+\s*\)\s*$/iu,"").replace(/\(\s*\d+\s*(?:m|meter|metern|schritte?|schritt)\s*\)\s*$/iu,"").trim()}function ke(t){let e=t.trim(),n,i;const s=ge(e);e=s.remainder,s.quantity!==void 0&&(i=s.quantity);const r=e.match(/\((\d+)\s*(m|meter|metern|schritte?|schritt)\s*\)\s*$/iu);if(r?.[0]){n=r[0].trim();const l=r[1];if(l){const m=Number.parseInt(l,10);Number.isNaN(m)||(i=m)}}e=be(e),e=e.replace(/([IVX]+)\s*-\s*([IVX]+)/gi,"$1+$2");let a;const o=[],c=()=>{const l=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);l&&(a=l[1]?.trim(),e=e.slice(0,l.index).trim())};for(c();;){const l=e.match(/\(([^)]+)\)\s*$/);if(!l)break;const m=l[1]?.trim();if(m){const h=m.split(/[,;]/).map(g=>g.trim()).filter(g=>g.length>0);if(h.length===0)o.unshift(m);else for(let g=h.length-1;g>=0;g-=1){const b=h[g];b&&o.unshift(b)}}e=e.slice(0,l.index).trim()}a||c();const u=a?U(a):void 0;return{baseName:e,options:o,level:u??void 0,quantity:i,quantityToken:n}}function Rn(t,e,n){let i;for(const[s,r]of e.entries()){if(Math.abs(s.length-t.length)>n)continue;const a=On(s,t,n);if(a!==void 0&&(!i||a<i.distance)&&(i={entry:r,normalized:s,distance:a},a===0))return i}return i}function On(t,e,n){const i=t.length,s=e.length;if(Math.abs(i-s)>n)return;if(i===0)return s<=n?s:void 0;if(s===0)return i<=n?i:void 0;const r=Array.from({length:s+1},(c,u)=>u),a=new Array(s+1);for(let c=1;c<=i;c+=1){a[0]=c;let u=a[0];const l=t.charAt(c-1);for(let m=1;m<=s;m+=1){const h=l===e.charAt(m-1)?0:1;a[m]=Math.min(r[m]+1,a[m-1]+1,r[m-1]+h),u=Math.min(u,a[m])}if(u>n)return;r.splice(0,r.length,...a)}const o=r[s];return o<=n?o:void 0}function Ae(t,e,n,i){const s=[];for(const r of t){const a=M(r);if(/^muttersprache\b/i.test(a)){e.add(Ee(a));continue}const o=ke(a),c=k(o.baseName);if(i.languages.get(c)){o.level!==void 0?e.add(`${o.baseName} ${q(o.level)}`):e.add(o.baseName);continue}if(i.scripts.get(c)){n.add(o.baseName);continue}s.push(r)}return s}function Mn(t){const e=new Set;for(const n of Object.values(t)){if(!n)continue;const i=n.split(/;+/);for(const s of i){const r=s.trim();if(!r)continue;const a=r.match(/^Paktgeschenke?:\s*(.+)$/i);if(a){const o=a[1]?.trim();o&&e.add(o)}}}return Array.from(e)}function Cn(t,e){const n=new Set,i=new Set,s=new Set,r=(a,o)=>{const c=M(a);if(!c)return;if(/^muttersprache\b/i.test(c)){const l=Ee(c);s.add(l);return}const u=Pn(c);for(const l of u){const m=Fn(l),h=k(m.baseLabel),g=Bn(m.baseLabel,m.detail);for(const b of g){const f=Gn(m.baseLabel,m.level,b);(()=>{let A=e.advantages.byName.get(h),v=e.disadvantages.byName.get(h);if(!A&&!v&&b){const $=k(`${m.baseLabel} (${b})`);A=e.advantages.byName.get($),v=e.disadvantages.byName.get($)}if(A&&!v){n.add(f);return}if(v&&!A){i.add(f);return}if(A&&v){o==="advantage"?n.add(f):i.add(f);return}const y=Zn(f);if(y==="advantage"){n.add(f);return}if(y==="disadvantage"){i.add(f);return}o==="advantage"?n.add(f):i.add(f)})()}}};for(const a of t.advantages)r(a,"advantage");for(const a of t.disadvantages)r(a,"disadvantage");return{advantages:Array.from(n),disadvantages:Array.from(i),languages:Array.from(s)}}function Pn(t){let e=qn(t);e=e.flatMap(xn),e=e.flatMap(Wn),e=e.flatMap(i=>ve(i).parts);const n=[];for(const i of e){const s=Vn(i);if(s){n.push(s);continue}n.push(Dn(i))}return Array.from(new Set(n))}function Dn(t){const e=t.match(/^Immunität gegen\s+([^()]+)$/i);if(e&&e[1]){const n=e[1].trim();if(n.length>0)return`Immunität gegen (${n})`}return t}function Vn(t){if(/^persönlichkeitsschwäche\b/i.test(t))return t.replace(/^persönlichkeitsschwäche/i,"Persönlichkeitsschwächen");if(/^persönlichkeitsschwächen\b/i.test(t))return t;const e=t.trim();if(!e)return;const n=e.toLowerCase();for(const i of Xt){const s=i.toLowerCase();if(n===s||n.startsWith(`${s} `))return`Persönlichkeitsschwächen (${e})`}}function qn(t){const e=t.trim(),n=e.match(/^Angst vor\b(.*)$/i);if(!n)return[e];const i=n[1]?.trim()??"";if(!i)return["Angst vor"];let s=i;if(s.startsWith("(")&&s.endsWith(")"))s=s.slice(1,-1).trim();else{const a=s.match(/\(([^)]+)\)/);a&&a[1]?s=a[1].trim():s=s.trim()}if(s=s.replace(/^…\s*/u,""),!s)return["Angst vor"];const r=s.split(/[,;/]/).map(a=>a.trim().replace(/^…\s*/u,"").replace(/^\(+/u,"").replace(/\)+$/u,"").trim()).filter(a=>a.length>0);return r.length===0?[`Angst vor (${s})`]:r.map(a=>{const{detail:o,level:c}=Kn(a),u=Un(o),l=c?` ${c}`:"";return`Angst vor (${u})${l}`.trim()})}function Kn(t){const e=t.match(/\s+([IVX\d]+)$/i);return e?.[1]?{detail:t.slice(0,e.index).trim(),level:e[1].trim()}:{detail:t.trim()}}function Un(t){const e=t.toLowerCase();return xt[e]??t}function xn(t){const e=t.match(/^Prinzipientreue(?:\s+([IVX\d]+))?\s*(?:\(([^)]+)\))?/i)??[],[,n,i]=e;if(!i)return[t];const s=n?` ${n.trim()}`:"",r=i.split(/[,;]/).flatMap(a=>a.split(/\bund\b/i).map(o=>o.trim()).filter(o=>o.length>0));return r.length===0?[t]:r.map(a=>{const o=a.toLowerCase().replace(/\s+/g,""),c=Kt[o]??a;return`${`Prinzipientreue${s}`.trim()} (${c})`.trim()})}function Wn(t){const e=t.match(/^Verpflichtungen(?:\s+([IVX\d]+))?\s*(?:\(([^)]+)\))?/i)??[],[,n,i]=e;if(!i)return[t];const s=i.split(/[,;]/).map(a=>a.trim()).filter(a=>a.length>0);if(s.length===0)return[t];const r=n?` ${n.trim()}`:"";return s.map(a=>{const o=a.toLowerCase();return`Verpflichtungen (${Ut[o]??a})${r}`.trim()})}function ve(t){if(!/\b(?:und|oder|bzw\.)\b/i.test(t)&&!t.includes("/"))return{parts:[t],usedOrConnector:!1};const n=t.replace(/\//g," / ").split(/\s+/),i=new Set(["und","oder","bzw.","bzw","/"]),s=[];let r="",a=0,o=!1;const c=()=>{const u=r.trim();u.length>0&&s.push(u),r=""};for(const u of n){if(!u)continue;const l=u.toLowerCase(),m=(u.match(/\(/g)??[]).length,h=(u.match(/\)/g)??[]).length;a===0&&i.has(l)?((l==="oder"||l==="bzw."||l==="bzw"||l==="/")&&(o=!0),c()):(r.length>0&&(r+=" "),r+=u),a=Math.max(0,a+m-h)}return c(),s.length<=1?{parts:[t],usedOrConnector:!1}:{parts:s,usedOrConnector:o}}function Fn(t){let e=t.trim();e=e.replace(/([IVX]+)\s*-\s*([IVX]+)/gi,"$1+$2");const n=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);let i;n&&(i=n[1],e=e.slice(0,n.index).trim());let s;const r=e.match(/^Angst vor\s+(.+)$/i);if(r){const l=r[1]?.trim();l&&!l.startsWith("(")&&(s=l,e="Angst vor")}const a=e.match(/\s*\(([^)]+)\)\s*$/);if(a&&(s=a[1],e=e.slice(0,a.index).trim()),!i){const l=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);l&&(i=l[1],e=e.slice(0,l.index).trim())}const o=jn(e);let c=o;const u=i?U(i):void 0;return u&&(c=`${c} ${q(u)}`.trim()),s&&(c=`${c} (${s})`.trim()),{label:c,baseLabel:o,detail:s,level:u}}function Gn(t,e,n){let i=t;return e&&(i=`${i} ${q(e)}`.trim()),n&&(i=`${i} (${n})`.trim()),i}function Bn(t,e){if(!e)return[void 0];const n=k(t);if(!jt.has(n))return[e];const i=e.split(/[,;/]/).flatMap(s=>s.split(/\b(?:und|oder)\b/i).map(r=>r.trim())).map(s=>s.replace(/^\(+|\)+$/g,"").trim()).filter(s=>s.length>0);return i.length>1?i:[e]}function Ee(t){let e=t.replace(/^muttersprache/i,"").trim();if(!e)return"Garethi III";const n=e.match(/([IVX\d]+)$/i);let i;n&&(i=n[1],e=e.slice(0,n.index).trim());const s=U(i??"III")??3;return`${e} ${q(s)}`.trim()}function jn(t){const e=k(t);return Dt[e]??t}const Hn=["beidhändig","dunkelsicht","richtungssinn","entfernungssinn","zauberer","zäher hund","blutrausch","herausragender sinn","giftresistenz"],Xn=["schlechte eigenschaft","eingeschränkter sinn","angst vor","blind","kälteempfindlich","zauberanfällig"];function Zn(t){const e=k(t);return Hn.some(n=>e.includes(n))?"advantage":Xn.some(n=>e.includes(n))?"disadvantage":"unknown"}function Yn(t){return t?new RegExp(t.source,t.flags):null}const Qn=/^(MU|KL|IN|CH|FF|GE|KO|KK)(\s+\d{1,2})\s+(MU|KL|IN|CH|FF|GE|KO|KK)/,ye=/([A-Za-zÄÖÜäöüß/+\-]+)\s+([^\s]+)/g,Te=/^([A-Za-zÄÖÜäöüß0-9\s/+\-&]+):\s*(.*)$/,Jn=["MU","KL","IN","CH","FF","GE","KO","KK"],ei={vorteile:"advantages",nachteile:"disadvantages",sonderfertigkeiten:"specialAbilities",kampfsonderfertigkeiten:"combatSpecialAbilities",kampfsonderfertigkeit:"combatSpecialAbilities",sprachen:"languages",schriften:"scripts",talente:"talents",rsbe:"armor",aktionen:"actions",liturgien:"liturgies",liturgie:"liturgies",zauber:"spells",zaubersprüche:"spells",zaubertricks:"cantrips",rituale:"rituals",rituellezauber:"rituals",ausrüstung:"equipment",gegenstände:"equipment",inventar:"equipment",segnungen:"blessings",kampftechniken:"combatTechniques",kampfverhalten:"notes",kampfverhaltenundflucht:"notes",flucht:"notes",schmerz:"notes",stabzauber:"specialAbilities","vorteile/nachteile":"advantages-disadvantages",vorteilenachteile:"advantages-disadvantages"},ti={sinesschärfe:"Sinnesschärfe","angriff verbessern":"Attacke verbessern",schnelladen:"Schnellladen",eigne:"Eigene","schlechte eigenschaften":"Schlechte Eigenschaft","bindung des stabs":"Bindung des Stabes",merkmalskenntnisse:"Merkmalskenntnis"},ni={MU:"Mut",KL:"Klugheit",IN:"Intuition",CH:"Charisma",FF:"Fingerfertigkeit",GE:"Gewandheit",KO:"Konstitution",KK:"Körperkraft"},ii=new Set(["ein","eine","einen","einem","einer","eins","zwei","drei","vier","fünf","sechs","sieben","acht","neun","zehn","elf","zwölf"].map(t=>t.toLowerCase())),X=["körper","körperlich","gesellschaft","natur","wissen","handwerk","sprachen","sprachlich"],si=new RegExp(`^(?:${X.join("|")})\\s*:\\s*`,"i"),ri=new RegExp(`\\b(${X.join("|")})\\s*:\\s*`,"gi"),ai=/^(\d+)\s+(schritte?|schritt|meter|metern|m)\b\s*(.*)$/iu,oi={dietrichset:"Dietrich",dietrichsets:"Dietrich",dietrich:"Dietrich",seil:"Kletterseil, pro Schritt","leichte shakagra platte":"Leichte Shakagra-Plattenrüstung","shakara-hammer":"Kriegshammer",wildnispaket:"Wildnispaket","wildnis paket":"Wildnispaket","wildnis-paket":"Wildnispaket"},ci=/[•●◦‣∙]/g,li=new Set(["und","oder","bzw","talente","talent","liturgien","rituale","sprach"]);function ui(t){const e=[],n=mi(t),i=n.split(`
`).map(p=>p.trim()).filter(p=>p.length>0);if(i.length===0)return{model:Ki(),warnings:[{type:"parse-error",message:"Eingabetext ist leer."}],normalizedSource:n};const s=[...i],r=s.shift()??"Unbekannt",a=[];for(;s.length>0;){const p=s[0];if(!p||!Qn.test(p))break;a.push(s.shift())}const o=di(a.join(" "),e),c={},u=s[0];u?.startsWith("LeP")?(Z(u,c),s.shift()):e.push({type:"missing-section",section:"resources",message:"LeP/AsP/KaP-Zeile nicht gefunden."});const l=s[0];l?.startsWith("AW")&&(Z(l,c),s.shift()),fi(s,c);const m=[];let h=0;for(;h<s.length;){const p=s[h];if(p&&we(p)){const T=[p];for(s.splice(h,1);h<s.length&&pi(s[h]);){const V=s[h];if(!V)break;T.push(V),s.splice(h,1)}const E=T.join(" ").replace(/\s+/g," ").trim(),_=gi(E,e);_&&m.push(_);continue}h+=1}const g=[...s];for(let p=0;p<g.length;p+=1){const T=g[p];if(T&&/^RS\s*\/\s*BE\b/i.test(T)&&!/^RS\s*\/\s*BE\s*:/i.test(T)){const E=T.replace(/^RS\s*\/\s*BE\s*/i,"").trim();g[p]=`RS/BE: ${E}`}}const{sections:b,extras:f}=ki(g),d={combatTechniques:[],scripts:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],talents:[],spells:[],cantrips:[],liturgies:[],rituals:[],blessings:[],equipment:[]},A=new Set,v={};let y=null,$;for(const p of b){const T=Ai(p.heading),E=K(p.content);if(!T){v[p.heading]=E;continue}switch(A.add(T),T){case"advantages":N(d.advantages,E);break;case"disadvantages":N(d.disadvantages,E);break;case"advantages-disadvantages":A.add("advantages"),A.add("disadvantages"),E.toLowerCase()!=="keine"&&$i(d,E);break;case"specialAbilities":{const{primary:_,trailing:V}=Di(E,"Talente:");Ie(d.specialAbilities,_),V&&(A.add("talents"),Ne(d.talents,V));break}case"combatSpecialAbilities":Ie(d.combatSpecialAbilities,E);break;case"scripts":N(d.scripts,E);break;case"combatTechniques":N(d.combatTechniques,E);break;case"languages":N(d.languages,E);break;case"talents":Ne(d.talents,E);break;case"spells":N(d.spells,E);break;case"cantrips":N(d.cantrips,E);break;case"liturgies":N(d.liturgies,E);break;case"rituals":N(d.rituals,E);break;case"blessings":N(d.blessings,E);break;case"equipment":N(d.equipment,E);break;case"armor":y=hi(E,e);break;case"actions":$=D(E);break;case"notes":default:v[p.heading]=E;break}}Se(d.specialAbilities,d.languages,d.scripts),Se(d.combatSpecialAbilities,d.languages,d.scripts),d.talents.length>0&&A.add("talents");for(const p of["advantages","disadvantages","specialAbilities","talents"])A.has(p)||e.push({type:"missing-section",section:p,message:`Abschnitt "${p}" nicht gefunden.`});return{model:{name:r,attributes:o,pools:c,armor:y,actions:$??null,weapons:m,combatTechniques:F(d.combatTechniques,"combatTechniques",e),advantages:S(d.advantages),disadvantages:S(d.disadvantages),specialAbilities:S(d.specialAbilities),combatSpecialAbilities:S(d.combatSpecialAbilities),languages:S(d.languages),scripts:S(d.scripts),spells:F(d.spells,"spells",e),cantrips:S(d.cantrips),liturgies:F(d.liturgies,"liturgies",e),rituals:F(d.rituals,"rituals",e),blessings:S(d.blessings),equipment:Ni(d.equipment),talents:Vi(d.talents,e),notes:v,extras:f},warnings:e,normalizedSource:n}}function mi(t){let e=t.replace(/\r\n/g,`
`).replace(/\t/g," ");return e=e.replace(/([A-Za-zÄÖÜäöüß])-\s*\n\s*([A-Za-zÄÖÜäöüß])/g,"$1$2"),e=e.replace(/–/g,"-"),e=e.split(`
`).map(n=>n.trimEnd()).join(`
`),e.trim()}function di(t,e){const n={};if(!t)return e.push({type:"missing-section",section:"attributes",message:"Eigenschaftszeilen nicht gefunden."}),n;const i=/(MU|KL|IN|CH|FF|GE|KO|KK)\s+(\d{1,2})/g;let s;for(;(s=i.exec(t))!==null;){const r=s[1],a=s[2];if(!r||!a)continue;const o=r,c=Number.parseInt(a,10);n[o]=Number.isNaN(c)?void 0:c}for(const r of Jn)n[r]===void 0&&e.push({type:"parse-error",section:"attributes",message:`Eigenschaft ${r} konnte nicht gelesen werden.`});return n}function Z(t,e){for(const n of t.matchAll(ye)){const i=n[1],s=n[2];if(!i||!s)continue;const r=D(s);switch(i){case"LeP":e.lep=r;break;case"AsP":e.asp=r;break;case"KaP":e.kap=r;break;case"INI":e.ini=s;break;case"AW":e.aw=r;break;case"SK":e.sk=r;break;case"ZK":e.zk=r;break;case"GS":e.gs=r;break}}}function fi(t,e){for(;t.length>0;){const n=t[0]?.trim()??"";if(!n){t.shift();continue}const i=n.replace(/^[–—-]\s*/,"").trim();if(!/^(LeP|AsP|KaP|INI|AW|SK|ZK|GS)\b/i.test(i))break;t.shift(),Z(i,e)}}function D(t){const e=t.replace(/[^0-9\-]/g,"");if(!e)return null;const n=Number.parseInt(e,10);return Number.isNaN(n)?null:n}function we(t){return/^[^:]+:\s+(AT|FK)\s+/i.test(t)}function pi(t){if(!t)return!1;const e=t.trim();return!(!e||we(e)||Te.test(e)||/^RS\s*\/\s*BE/i.test(e))}function hi(t,e){const n=K(t);if(!n)return null;const i=n,s=n.match(/^(\d+)\s*\/\s*(\d+)(.*)$/);if(!s)return e.push({type:"parse-error",section:"armor",message:`Rüstungseintrag "${n}" konnte nicht interpretiert werden.`}),{rs:null,be:null,description:null,notes:n,raw:i};const[,r,a,o=""]=s,c=o??"",u=[...c.matchAll(/\(([^)]+)\)/g)].map(h=>h[1]?.trim()??"");let l=u[0]??null;const m=u.length>1?u.slice(1).filter(Boolean).join("; "):null;if(!l){const h=c.replace(/\([^)]*\)/g," ").replace(/[;,]+/g," ").trim();h&&(l=K(h))}return{rs:D(r??""),be:D(a??""),description:l,notes:m,raw:i}}function gi(t,e){const[n,i]=t.split(":");if(!i){e.push({type:"parse-error",section:"weapons",message:`Zeile "${t}" enthält keinen Doppelpunkt.`});return}const s=(n??"").trim(),r={};for(const l of i.matchAll(ye)){const m=l[1],h=l[2];if(!m||!h)continue;const g=m.toUpperCase();r[g]=h}const a=r.AT?D(r.AT):null,o=r.PA?D(r.PA):null,c=r.FK?D(r.FK):null,u=bi(s,a,c);return{name:s,category:u,attack:a,parry:o,rangedAttack:c,damage:r.TP??null,range:r.RW??null,load:r.LZ??null,reach:r.RE??null,notes:r.BEM??null,raw:r,rawInput:t.trim()}}function bi(t,e,n){return t.toLowerCase().includes("waffenlos")?"unarmed":n!==null?"ranged":e!==null?"melee":"unknown"}function ki(t){const e=[],n=[];let i=null,s=[];const r=()=>{i?e.push({heading:i,content:s.join(" ").trim()}):s.length>0&&n.push(s.join(" ").trim()),i=null,s=[]};for(const a of t){const o=a.trim();if(!o)continue;const c=o.match(Te);if(c){const u=c[1]?.trim();if(i&&i.toLowerCase().startsWith("talente")&&u&&Le(u)){s.push(o);continue}r(),i=u&&u.length>0?u:null;const l=c[2]?.trim();s=l?[l]:[];continue}i?s.push(o):n.push(o)}return r(),{sections:e,extras:n}}function Ai(t){const e=t.toLowerCase().replace(/\s+/g,"").replace(/[()\/]/g,"");return e.startsWith("schmerz")||e==="kampfverhaltenflucht"?"notes":ei[e]??Ti(t)??null}function N(t,e){if(e)for(const n of x(e))t.push(n)}function Ie(t,e){if(e)for(const n of x(e))Si(n).forEach(s=>{s&&t.push(s)})}function Ne(t,e){if(!e||e.toLowerCase()==="keine")return;const n=vi(e);for(const i of x(n)){const s=Ei(i);s&&t.push(s)}}function vi(t){return t.replace(ri,(e,n,i)=>Le(n)?`${i===0?"":"; "}${n}: `:e)}function Ei(t){return t.replace(si,"")}function Le(t){const e=t.toLowerCase().replace(/\s+/g,"").replace(/-+/g,"");return X.some(n=>e.startsWith(n.replace(/\s+/g,"")))}function x(t){const e=t.replace(ci,";"),n=[];let i="",s=0;for(const a of e){if(a==="("?s+=1:a===")"&&(s=Math.max(s-1,0)),(a===","||a===";")&&s===0){i.trim()&&n.push(i.trim()),i="";continue}i+=a}i.trim()&&n.push(i.trim());const r=n.map(a=>W(a));return yi(r)}function yi(t){const e=[];for(const n of t){const i=n.trim();e.length>0&&/^(den|die|das|dessen|deren)\b/i.test(i)?e[e.length-1]=`${e[e.length-1]}, ${i}`:e.push(i)}return e}function Se(t,e,n){if(t.length===0)return;const i=[];let s=null;for(const r of t){const a=r.match(/^(sprachen?|sprachkenntnisse)\s*:\s*(.+)$/i);if(a){N(e,a[2]),s="languages";continue}const o=r.match(/^(schriften?|schrift)\s*:\s*(.+)$/i);if(o){N(n,o[2]),s="scripts";continue}if(s==="languages"&&wi(r)){e.push(r);continue}if(s==="scripts"&&Ii(r)){n.push(r);continue}s=null,i.push(r)}t.length=0,t.push(...i)}function Ti(t){const e=t.toLowerCase();return e.includes("sonderfert")?e.includes("kampf")?"combatSpecialAbilities":"specialAbilities":e.includes("talent")?"talents":e.includes("kampftechnik")?"combatTechniques":e.includes("sprache")?"languages":e.includes("schrift")?"scripts":e.includes("liturgie")?"liturgies":e.includes("ritual")?"rituals":e.includes("segnung")?"blessings":e.includes("zaubertrick")||e.includes("cantrip")?"cantrips":e.includes("zauber")?"spells":e.includes("ausrüstung")||e.includes("inventar")?"equipment":e.includes("vorteil")&&e.includes("nachteil")?"advantages-disadvantages":e.includes("vorteil")?"advantages":e.includes("nachteil")?"disadvantages":e.includes("rs/be")||e.includes("rüst")?"armor":null}function wi(t){return/\b[IVXLCDM]+\b/i.test(t)||/^muttersprache\b/i.test(t)}function Ii(t){return/zeichen|runen|glyph|schrift|piktogramm|alphabet|zhayad/i.test(t)}function Ni(t){return S(t).map(e=>Li(e)).filter(e=>e.length>0)}function Li(t){const e=Mi(Oi(t)),n=e.match(/\(\s*[^)]+\)\s*$/u),i=n?n[0]:"",s=i&&e.endsWith(i)?e.slice(0,e.length-i.length).trim():e,r=oi[s.toLowerCase()];return r?i?`${r} ${i}`.trim():r:e}function Si(t){const e=t.split(new RegExp("(?<=\\))\\s+(?=[A-ZÄÖÜ][a-zäöüß])","u")).map(n=>n.trim()).filter(n=>n.length>0);return e.length>0?e:[t]}function $i(t,e){for(const n of x(e)){const i=Pi(n);for(const s of i){const r=zi(s);r==="disadvantage"?t.disadvantages.push(s):r==="advantage"?t.advantages.push(s):(t.advantages.push(s),t.disadvantages.push(s))}}}function zi(t){const e=t.toLowerCase();return["schlechte eigenschaft","verpflicht","feindschaft","hass","arm","krankheit","unfähig","vorurteil","schulden","angst","zauberanfällig"].some(s=>e.includes(s))?"disadvantage":["begabung","adelig","gutaussehend","vorteil","resistenz","richtungssinn","entfernungssinn"].some(s=>e.includes(s))?"advantage":"both"}function S(t){return t.map(e=>K(e)).map(e=>W(e)).map(e=>_i(e)).map(e=>Ri(e)).map(e=>$e(e)).map(e=>ze(e)).map(e=>K(e)).map(e=>e.endsWith(".")?e.slice(0,-1):e).filter(e=>e.length>0).filter(e=>{const n=e.toLowerCase();return n!=="keine"&&n!=="keiner"&&n!=="keinen"&&n!=="nein"&&n!=="entfällt"&&n!=="-"&&n!=="—"})}function K(t){return t.replace(/\s+/g," ").trim()}function W(t){return t.replace(/([A-Za-zÄÖÜäöüß]+)-\s+([A-Za-zÄÖÜäöüß]+)\b/g,(e,n,i)=>li.has(i.toLowerCase())?`${n}- ${i}`:`${n}${i}`)}function _i(t){let e=t.replace(/([IVX]+)\s*AKO\d+/gi,"$1").replace(/([IVX]+)AKO\d+/gi,"$1");return e=e.replace(/AKO[IVX\d]+/gi,""),e=e.replace(/\s{2,}/g," "),e.trim()}function $e(t){let e=t;for(const[n,i]of Object.entries(ti)){const s=new RegExp(`\\b${n}\\b`,"gi");e=e.replace(s,i)}return e}function ze(t){return t.replace(/\*+$/g,"").trim()}function Ri(t){return t.replace(/\(([^)]+)\)/g,(e,n)=>`(${n.split(/\s*[;,\/]\s*/).map(s=>{const r=s.trim(),a=r.toUpperCase();return ni[a]??r}).filter(s=>s.length>0).join(", ")})`)}function Oi(t){const e=t.trim(),n=e.match(ai);if(n&&n[3]){const[,r,a,o]=n;if(a&&o){const c=o.trim();if(c){const u=c.toLowerCase()==="seil"?"Kletterseil, pro Schritt":c,m=a.toLowerCase().startsWith("schritt")?"m":a;return`${u} (${r} ${m})`.trim()}}}const i=e.match(/^(\d+)\s+(.*)$/u);if(i&&i[2])return i[2].trim();const s=e.match(/^([A-Za-zÄÖÜäöüß]+)\s+(.*)$/u);if(s&&s[2]){const r=s[1]?.toLowerCase();if(r&&ii.has(r))return s[2].trim()}return e}function Mi(t){let e=t.trim();return e=e.replace(/\(\s*(?:x\s*)?\d+\s*\)\s*$/iu,"").trim(),e}function Ci(t){return t.replace(/\(\s*[^)]*\)\s*$/u,"").trim()}function Pi(t){const e=[];let n="",i=0;for(const s of t){if(s==="("?i+=1:s===")"&&(i=Math.max(i-1,0)),s==="/"&&i===0){n.trim()&&e.push(n.trim()),n="";continue}n+=s}return n.trim()&&e.push(n.trim()),e}function Di(t,e){const n=t.toLowerCase(),i=e.toLowerCase(),s=n.indexOf(i);if(s===-1)return{primary:t};const r=t.slice(0,s).trim().replace(/[;,]+$/,""),a=t.slice(s+e.length).trim();return{primary:r.length>0?r:"",trailing:a.length>0?a:void 0}}function Vi(t,e){const n=[];for(const i of t){const a=ze(i.trim()).replace(/([^\s\d])(-?\d+)(\s*\([^)]*\))?$/,"$1 $2$3").match(/^(.+?)\s+(-?\d+)(?:\s*\([^)]*\))?$/);if(!a){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${i}"`});continue}const o=W(a[1]??""),c=a[2];if(!o||!c){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${i}"`});continue}const u=$e(o.replace(/\*+$/,"").trim()),l=Number.parseInt(c,10);if(Number.isNaN(l)){e.push({type:"parse-error",section:"talents",message:`Talentwert ist keine Zahl: "${i}"`});continue}n.push({name:u,value:l})}return n}function F(t,e,n){const i=[];for(const s of S(t)){const a=Ci(s).match(/^(.+?)\s+(-?\d+|[IVX]+)$/i);if(!a){i.push({name:s,value:0}),n.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${s}"`});continue}const o=W(a[1]??""),c=a[2];if(!o||!c){n.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${s}"`});continue}const u=o.trim(),l=c.trim();let m=Number.parseInt(l,10);if(Number.isNaN(m)&&(m=qi(l.toUpperCase())),!m||Number.isNaN(m)){n.push({type:"parse-error",section:e,message:`Numerischer Wert für ${e} ist ungültig: "${s}"`});continue}i.push({name:u,value:m})}return i}function qi(t){const e={I:1,V:5,X:10,L:50,C:100},n=t.toUpperCase().split("");let i=0,s=0;for(const r of n.reverse()){const a=e[r];if(!a)return null;a<s?i-=a:(i+=a,s=a)}return i}function Ki(){return{name:"Unbekannt",attributes:{},pools:{},armor:null,actions:null,weapons:[],combatTechniques:[],scripts:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],spells:[],cantrips:[],liturgies:[],rituals:[],blessings:[],equipment:[],talents:[],notes:{},extras:[]}}let G,_e;self.addEventListener("message",async t=>{const e=t.data;if(!(!e||e.type!=="convert"))try{const n=await Ui(e.payload.baseUrl),i=ui(e.payload.source),s=en(i.model,n),{hero:r,warnings:a}=pt({dataset:n,parsed:i,resolved:s}),o=xi(s),c={type:"result",payload:{exported:r,exportedWarnings:a,manifest:n.manifest,normalizedSource:i.normalizedSource,parserWarnings:i.warnings,resolverWarnings:s.warnings,unresolved:s.unresolved,equipmentSummary:o}};postMessage(c)}catch(n){const i={type:"error",error:n instanceof Error?n.message:String(n)};postMessage(i)}});async function Ui(t){const e=new URL("data/optolith/manifest.json",t).toString();if(G&&_e===e)return G;const n=await fetch(e);if(!n.ok)throw new Error(`Manifest konnte nicht geladen werden (${n.status})`);const i=await n.json(),s=async a=>{const o=new URL(`data/optolith/${a}`,t).toString(),c=await fetch(o);if(!c.ok)throw new Error(`Datensatz ${a} konnte nicht geladen werden (${c.status})`);return c.json()},r={manifest:i,advantages:await s(w(i,"advantages")),disadvantages:await s(w(i,"disadvantages")),specialAbilities:await s(w(i,"specialAbilities")),skills:await s(w(i,"skills")),combatTechniques:await s(w(i,"combatTechniques")),spells:await s(w(i,"spells")),cantrips:await s(w(i,"cantrips")),liturgies:await s(w(i,"liturgies")),blessings:await s(w(i,"blessings")),equipment:await s(w(i,"equipment")),books:await s(w(i,"books")),blessedTraditions:await s(w(i,"blessedTraditions")),magicalTraditions:await s(w(i,"magicalTraditions")),properties:await s(w(i,"properties")),equipmentPackages:await s(w(i,"equipmentPackages"))};return G=Me(r),_e=e,G}function xi(t){const e=t.weapons.map(s=>({name:s.source.name,templateId:s.match?.id,combatTechniqueId:s.combatTechnique?.id,fallback:s.fallback,unresolved:!s.match})),n=t.armor?{name:t.armor.source.description??t.armor.source.notes??t.armor.source.raw??"Unknown armor",templateId:t.armor.match?.id,protection:typeof t.armor.datasetProtection=="number"?t.armor.datasetProtection:null,encumbrance:typeof t.armor.datasetEncumbrance=="number"?t.armor.datasetEncumbrance:null,unresolved:!t.armor.match}:null,i=t.equipment.map(s=>({name:s.source,templateId:s.match?.id,unresolved:!s.match}));return{weapons:e,armor:n,gear:i}}function w(t,e){const n=t.sections.find(i=>i.key===e);if(!n)throw new Error(`Manifestabschnitt fehlt: ${e}`);return n.file}})();
