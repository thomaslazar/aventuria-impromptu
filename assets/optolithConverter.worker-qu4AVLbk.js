(function(){"use strict";function b(i){return i.toLocaleLowerCase("de-DE").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim()}function Q(i){const e=y(i.specialAbilities);return{manifest:i.manifest,advantages:y(i.advantages),disadvantages:y(i.disadvantages),specialAbilities:e,skills:y(i.skills),combatTechniques:y(i.combatTechniques),spells:y(i.spells),liturgies:y(i.liturgies),blessings:y(i.blessings),equipment:y(i.equipment),languages:U(i.specialAbilities,"SA_29"),scripts:U(i.specialAbilities,"SA_27")}}function y(i){const e=new Map,t=new Map;for(const s of i){e.set(s.id,s),t.set(s.normalizedName,s);for(const a of s.synonyms??[]){const r=b(a);r&&(t.has(r)||t.set(r,s))}const n=typeof s.locale?.name=="string"?String(s.locale.name):void 0;if(n){const a=b(n);a&&!t.has(a)&&t.set(a,s)}}return{byId:e,byName:t}}function U(i,e){const t=i.find(o=>o.id===e),s=new Map;if(!t)return s;const n=t.locale,a=Array.isArray(n?.selectOptions)?n.selectOptions:[],r=typeof t.base=="object"&&t.base!==null?Number.parseInt(String(t.base.levels??""),10):void 0;for(const o of a){if(!o||typeof o.name!="string"||typeof o.id!="number")continue;const l=b(o.name);s.set(l,{ability:t,optionId:o.id,name:o.name,normalizedName:l,maxLevel:Number.isFinite(r)?r:void 0})}return s}const ee="1.5.1",te=3,ne=1100,q="1.0.0",se={MU:"ATTR_1",KL:"ATTR_2",IN:"ATTR_3",CH:"ATTR_4",FF:"ATTR_5",GE:"ATTR_6",KO:"ATTR_7",KK:"ATTR_8"};function ie({dataset:i,parsed:e,resolved:t}){if(i.manifest.schemaVersion!==q)throw new Error(`Unsupported dataset schema version: ${i.manifest.schemaVersion}. Expected ${q}.`);const s=new Date().toISOString(),n=`NPC_${de()}`,a=ae(e),r=re(e),o=oe(t),l=le(t),c=K(t.spells),d=K(t.liturgies),m=K(t.rituals),h=ue(e,t);return{clientVersion:ee,dateCreated:s,dateModified:s,id:n,phase:te,locale:i.manifest.locale,name:t.name,ap:{total:ne},attr:a,pools:r,activatable:o,talents:l,spells:c,liturgies:d,blessings:ce(t),cantrips:[],rituals:m,ct:{},belongings:{items:{},armorZones:{},purse:{d:"0",s:"0",h:"0",k:"0"}},rules:{higherParadeValues:0,attributeValueLimit:!1,enableAllRuleBooks:!0,enabledRuleBooks:[],enableLanguageSpecializations:!1},notes:Object.values(e.model.notes),warnings:h}}function ae(i){return{values:Object.entries(se).map(([t,s])=>{const n=i.model.attributes[t]??0;return{id:s,value:typeof n=="number"?n:0}}).sort((t,s)=>t.id.localeCompare(s.id)),attributeAdjustmentSelected:"ATTR_4",ae:0,kp:0,lp:0}}function re(i){const{pools:e}=i.model;return{lep:e.lep??null,asp:e.asp??null,kap:e.kap??null,ini:e.ini??null,aw:e.aw??null,sk:e.sk??null,zk:e.zk??null,gs:e.gs??null}}function oe(i){const e={},t=(n,a)=>{e[n]||(e[n]=[]),e[n].push(a)},s=n=>{if(!n.match)return;const a={};n.selectOption&&(a.sid=n.selectOption.id),n.rawOption&&n.rawOption.trim()&&(a.options=[{type:"Custom",value:n.rawOption.trim()}]),n.level&&(a.tier=n.level),t(n.match.id,a)};return i.advantages.forEach(s),i.disadvantages.forEach(s),i.specialAbilities.forEach(s),i.combatSpecialAbilities.forEach(s),i.languages.forEach(n=>{if(!n.match)return;const a={};n.option&&(a.sid=n.option.optionId),!n.option&&n.rawOption?.trim()&&(a.options=[{type:"Custom",value:n.rawOption.trim()}]),n.level&&(a.tier=n.level),t(n.match.id,a)}),e}function le(i){const e={};for(const t of i.talents)t.match&&(e[t.match.id]=t.source.value);return e}function K(i){const e={};for(const t of i)t.match&&(e[t.match.id]=t.value);return e}function ce(i){const e=new Set;for(const t of i.blessings)t.match&&e.add(t.match.id);return Array.from(e)}function ue(i,e){const t=[];for(const s of i.warnings)t.push(`[Parser] ${s.section??"general"}: ${s.message}`);for(const s of e.warnings)t.push(`[Resolver] ${s.section}: ${s.message}`);for(const[s,n]of Object.entries(e.unresolved))for(const a of n)t.push(`[Resolver] ${s}: unverarbeitet "${a}"`);return t}function de(){const i=globalThis.crypto;return i?.randomUUID?i.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}const me={"schlechte eigenschaften":"Schlechte Eigenschaft","schlechte eigenschaft":"Schlechte Eigenschaft",dammerungssicht:"Dunkelsicht",dammersicht:"Dunkelsicht"},fe=/AKO(?:[IVXLCDM]+)?\s*\d{1,4}/g,pe=/[,:;]+$/;function ge(i,e){const t={lookups:e,warnings:[],unresolved:new Map},s=Le(i,e),n=new Set(s.languages),a=W(i.specialAbilities,n,e),r=W(i.combatSpecialAbilities,n,e),o=N(s.advantages,"advantages",t.lookups.advantages,t),l=N(s.disadvantages,"disadvantages",t.lookups.disadvantages,t),c=N(a,"specialAbilities",t.lookups.specialAbilities,t),d=N(r,"combatSpecialAbilities",t.lookups.specialAbilities,t),m=[...i.languages,...n],h=be(m,t),p=he(i.talents,t),v=_(i.spells,"spells",t.lookups.spells,t),u=_(i.liturgies,"liturgies",t.lookups.liturgies,t),A=_(i.rituals,"rituals",t.lookups.spells,t),I=N(i.blessings,"blessings",t.lookups.blessings,t),C=N(i.equipment,"equipment",t.lookups.equipment,t),$={};for(const[Y,f]of t.unresolved.entries())$[Y]=Array.from(f.values());return{name:i.name,advantages:o,disadvantages:l,specialAbilities:c,combatSpecialAbilities:d,languages:h,talents:p,spells:v,liturgies:u,rituals:A,blessings:I,equipment:C,unresolved:$,warnings:t.warnings}}function N(i,e,t,s){return i.map(n=>S(n)).filter(n=>n.length>0).map(n=>{const a=F(n);let r=b(a.baseName),o=t.byName.get(r),l,c,d,m;if(!o&&a.options.length>0)for(const p of a.options){const v=`${a.baseName} (${p})`,u=b(v),A=t.byName.get(u);if(A){o=A,r=u,l=p;break}}if(o&&ke(o)&&a.options.length>0)for(const p of a.options){const v=ye(o,p);if(v){c=v,m=v.name;break}d||(d=p)}else a.options.length>0&&(m=l??a.options[0]);!m&&l&&(m=l);const h=we(a.baseName,a.level,m);return o||z(e,h,s),{source:h,normalizedSource:r,match:o,selectOption:c,level:a.level??void 0,rawOption:d}})}function _(i,e,t,s){const n=[];for(const a of i){const r=S(a.name);if(!r){z(e,a.name,s);continue}const o=b(r),l=t.byName.get(o);l||z(e,r,s),n.push({source:r,normalizedSource:o,match:l,value:a.value})}return n}function he(i,e){return i.map(t=>{const s=b(t.name);let n=e.lookups.skills.byName.get(s);if(!n){const a=Te(s,e.lookups.skills.byName,1);a?(n=a.entry,e.warnings.push({type:"fuzzy-match",section:"talents",value:t.name,message:`Talent "${t.name}" wurde als "${n.name}" interpretiert (Schreibweise korrigiert).`})):z("talents",t.name,e)}return{source:t,match:n}})}function be(i,e){return i.map(t=>S(t)).filter(t=>t.length>0).map(t=>{const s=ve(t),n=b(s.baseName),a=e.lookups.languages.get(n);return a?(s.level&&a.maxLevel&&s.level>a.maxLevel&&e.warnings.push({type:"level-out-of-range",section:"languages",value:t,message:`Sprachstufe ${s.level} überschreitet den erlaubten Bereich (${a.maxLevel}).`}),{source:t,normalizedSource:n,match:a.ability,option:a,level:s.level??void 0}):(z("languages",t,e),{source:t,normalizedSource:n,rawOption:s.baseName})})}function ve(i){const e=i.trim(),t=e.match(/^(.*?)(?:\s+([IVX\d]+(?:\+[IVX\d]+)*))?$/i);if(!t)return{baseName:e};const s=(t[1]??e).trim(),n=t[2]?.trim();if(!n)return{baseName:s};const a=O(n);return{baseName:s,level:a??void 0}}function Ae(i){const e={I:1,V:5,X:10},t=i.toUpperCase().split("");let s=0,n=0;for(const a of t.reverse()){const r=e[a];if(!r)return null;r<n?s-=r:(s+=r,n=r)}return s}function x(i){const e=[[10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]];let t=i,s="";for(const[n,a]of e)for(;t>=n;)s+=a,t-=n;return s||"I"}function we(i,e,t){const s=i.trim(),n=e?`${s} ${x(e)}`.trim():s;return t&&t.trim().length>0?`${n} (${t.trim()})`.trim():n}function O(i){const e=i.split("+").map(s=>s.trim()).filter(s=>s.length>0);if(e.length===0)return;const t=e.map(s=>{const n=Number.parseInt(s,10);return Number.isNaN(n)?Ae(s)??void 0:n}).filter(s=>s!==void 0);if(t.length!==0)return Math.max(...t)}function z(i,e,t){t.unresolved.has(i)||t.unresolved.set(i,new Set),t.unresolved.get(i).add(e),t.warnings.push({type:"unresolved",section:i,value:e,message:`Eintrag "${e}" konnte im Abschnitt ${i} nicht aufgelöst werden.`})}function ye(i,e){const t=i.locale,s=Array.isArray(t?.selectOptions)?t.selectOptions:[],n=b(e);for(const a of s){if(typeof a?.name!="string"||typeof a?.id!="number")continue;if(b(a.name)===n)return{id:a.id,name:a.name}}}function ke(i){const e=i.locale;return Array.isArray(e?.selectOptions)&&e.selectOptions.length>0}function S(i){return i&&i.replace(fe," ").replace(/\(\s*\)/g,"").replace(/\s*\+\s*/g,"+").replace(/\s+/g," ").trim().replace(pe,"").trim()}function F(i){let e=i.trim(),t;const s=[],n=()=>{const r=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);r&&(t=r[1]?.trim(),e=e.slice(0,r.index).trim())};for(n();;){const r=e.match(/\(([^)]+)\)\s*$/);if(!r)break;const o=r[1]?.trim();o&&s.unshift(o),e=e.slice(0,r.index).trim()}t||n();const a=t?O(t):void 0;return{baseName:e,options:s,level:a??void 0}}function Te(i,e,t){let s;for(const[n,a]of e.entries()){if(Math.abs(n.length-i.length)>t)continue;const r=Ne(n,i,t);if(r!==void 0&&(!s||r<s.distance)&&(s={entry:a,normalized:n,distance:r},r===0))return s}return s}function Ne(i,e,t){const s=i.length,n=e.length;if(Math.abs(s-n)>t)return;if(s===0)return n<=t?n:void 0;if(n===0)return s<=t?s:void 0;const a=Array.from({length:n+1},(l,c)=>c),r=new Array(n+1);for(let l=1;l<=s;l+=1){r[0]=l;let c=r[0];const d=i.charAt(l-1);for(let m=1;m<=n;m+=1){const h=d===e.charAt(m-1)?0:1;r[m]=Math.min(a[m]+1,r[m-1]+1,a[m-1]+h),c=Math.min(c,r[m])}if(c>t)return;a.splice(0,a.length,...r)}const o=a[n];return o<=t?o:void 0}function W(i,e,t){const s=[];for(const n of i){const a=S(n);if(/^muttersprache\b/i.test(a)){e.add(X(a));continue}const r=F(a),o=b(r.baseName);if(t.languages.get(o)??t.scripts.get(o)){r.level!==void 0?e.add(`${r.baseName} ${x(r.level)}`):e.add(r.baseName);continue}s.push(n)}return s}function Le(i,e){const t=new Set,s=new Set,n=new Set,a=(r,o)=>{const l=S(r);if(!l)return;if(/^muttersprache\b/i.test(l)){const A=X(l);n.add(A);return}const{label:c,baseLabel:d,detail:m}=ze(l),h=b(d);let p=e.advantages.byName.get(h),v=e.disadvantages.byName.get(h);if(!p&&!v&&m){const A=b(`${d} (${m})`);p=e.advantages.byName.get(A),v=e.disadvantages.byName.get(A)}if(p&&!v){t.add(c);return}if(v&&!p){s.add(c);return}if(p&&v){o==="advantage"?t.add(c):s.add(c);return}const u=$e(c);if(u==="advantage"){t.add(c);return}if(u==="disadvantage"){s.add(c);return}o==="advantage"?t.add(c):s.add(c)};for(const r of i.advantages)a(r,"advantage");for(const r of i.disadvantages)a(r,"disadvantage");return{advantages:Array.from(t),disadvantages:Array.from(s),languages:Array.from(n)}}function ze(i){let e=i.trim();const t=e.match(/\s+([IVX\d]+(?:\+[IVX\d]+)*)$/i);let s;t&&(s=t[1],e=e.slice(0,t.index).trim());let n;const a=e.match(/^Angst vor\s+(.+)$/i);if(a){const m=a[1]?.trim();m&&(n=m),e="Angst vor"}const r=e.match(/\s*\(([^)]+)\)\s*$/);r&&(n=r[1],e=e.slice(0,r.index).trim());const o=Se(e),l=[o];n&&l.push(`(${n})`);let c=l.join(" ");const d=s?O(s):void 0;return d&&(c=`${c} ${x(d)}`.trim()),{label:c,baseLabel:o,detail:n}}function X(i){let e=i.replace(/^muttersprache/i,"").trim();if(!e)return"Garethi III";const t=e.match(/([IVX\d]+)$/i);let s;t&&(s=t[1],e=e.slice(0,t.index).trim());const n=O(s??"III")??3;return`${e} ${x(n)}`.trim()}function Se(i){const e=b(i);return me[e]??i}const Ee=["beidhändig","dunkelsicht","richtungssinn","entfernungssinn","zauberer","zäher hund","blutrausch","herausragender sinn","giftresistenz"],Ie=["schlechte eigenschaft","eingeschränkter sinn","angst vor","blind","kälteempfindlich","zauberanfällig"];function $e(i){const e=b(i);return Ee.some(t=>e.includes(t))?"advantage":Ie.some(t=>e.includes(t))?"disadvantage":"unknown"}const xe=/^(MU|KL|IN|CH|FF|GE|KO|KK)(\s+\d{1,2})\s+(MU|KL|IN|CH|FF|GE|KO|KK)/,j=/([A-Za-zÄÖÜäöüß/+\-]+)\s+([^\s]+)/g,Oe=/^([A-Za-zÄÖÜäöüß0-9\s/+\-&]+):\s*(.*)$/,Re=["MU","KL","IN","CH","FF","GE","KO","KK"],Me={vorteile:"advantages",nachteile:"disadvantages",sonderfertigkeiten:"specialAbilities",kampfsonderfertigkeiten:"combatSpecialAbilities",kampfsonderfertigkeit:"combatSpecialAbilities",sprachen:"languages",talente:"talents",rsbe:"armor",aktionen:"actions",liturgien:"liturgies",liturgie:"liturgies",zauber:"spells",zaubersprüche:"spells",zaubertricks:"spells",rituale:"rituals",rituellezauber:"rituals",ausrüstung:"equipment",gegenstände:"equipment",inventar:"equipment",segnungen:"blessings",kampfverhalten:"notes",kampfverhaltenundflucht:"notes",flucht:"notes",schmerz:"notes","vorteile/nachteile":"advantages-disadvantages",vorteilenachteile:"advantages-disadvantages"},Ce={sinesschärfe:"Sinnesschärfe"};function Ke(i){const e=[],t=_e(i),s=t.split(`
`).map(f=>f.trim()).filter(f=>f.length>0);if(s.length===0)return{model:Ye(),warnings:[{type:"parse-error",message:"Eingabetext ist leer."}],normalizedSource:t};const n=[...s],a=n.shift()??"Unbekannt",r=[];for(;n.length>0;){const f=n[0];if(!f||!xe.test(f))break;r.push(n.shift())}const o=Pe(r.join(" "),e),l={},c=n[0];c?.startsWith("LeP")?(H(c,l),n.shift()):e.push({type:"missing-section",section:"resources",message:"LeP/AsP/KaP-Zeile nicht gefunden."});const d=n[0];d?.startsWith("AW")&&(H(d,l),n.shift());const m=[];for(;n.length>0;){const f=n[0];if(!f||!Ve(f))break;n.shift();const L=De(f,e);L&&m.push(L)}const h=[...n],{sections:p,extras:v}=qe(h),u={advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],talents:[],spells:[],liturgies:[],rituals:[],blessings:[],equipment:[]},A=new Set,I={};let C,$;for(const f of p){const L=Fe(f.heading),g=V(f.content);if(!L){I[f.heading]=g;continue}switch(A.add(L),L){case"advantages":w(u.advantages,g);break;case"disadvantages":w(u.disadvantages,g);break;case"advantages-disadvantages":A.add("advantages"),A.add("disadvantages"),g.toLowerCase()!=="keine"&&We(u,g);break;case"specialAbilities":{const{primary:Qe,trailing:J}=Ze(g,"Talente:");w(u.specialAbilities,Qe),J&&Z(u.talents,J);break}case"combatSpecialAbilities":w(u.combatSpecialAbilities,g);break;case"languages":w(u.languages,g);break;case"talents":Z(u.talents,g);break;case"spells":w(u.spells,g);break;case"liturgies":w(u.liturgies,g);break;case"rituals":w(u.rituals,g);break;case"blessings":w(u.blessings,g);break;case"equipment":w(u.equipment,g);break;case"armor":C=g;break;case"actions":$=E(g);break;case"notes":default:I[f.heading]=g;break}}for(const f of["advantages","disadvantages","specialAbilities","talents"])A.has(f)||e.push({type:"missing-section",section:f,message:`Abschnitt "${f}" nicht gefunden.`});return{model:{name:a,attributes:o,pools:l,armor:C,actions:$??null,weapons:m,advantages:T(u.advantages),disadvantages:T(u.disadvantages),specialAbilities:T(u.specialAbilities),combatSpecialAbilities:T(u.combatSpecialAbilities),languages:T(u.languages),spells:D(u.spells,"spells",e),liturgies:D(u.liturgies,"liturgies",e),rituals:D(u.rituals,"rituals",e),blessings:T(u.blessings),equipment:T(u.equipment),talents:Ge(u.talents,e),notes:I,extras:v},warnings:e,normalizedSource:t}}function _e(i){let e=i.replace(/\r\n/g,`
`).replace(/\t/g," ");return e=e.replace(/([A-Za-zÄÖÜäöüß])-\s*\n\s*([A-Za-zÄÖÜäöüß])/g,"$1$2"),e=e.replace(/–/g,"-"),e=e.split(`
`).map(t=>t.trimEnd()).join(`
`),e.trim()}function Pe(i,e){const t={};if(!i)return e.push({type:"missing-section",section:"attributes",message:"Eigenschaftszeilen nicht gefunden."}),t;const s=/(MU|KL|IN|CH|FF|GE|KO|KK)\s+(\d{1,2})/g;let n;for(;(n=s.exec(i))!==null;){const a=n[1],r=n[2];if(!a||!r)continue;const o=a,l=Number.parseInt(r,10);t[o]=Number.isNaN(l)?void 0:l}for(const a of Re)t[a]===void 0&&e.push({type:"parse-error",section:"attributes",message:`Eigenschaft ${a} konnte nicht gelesen werden.`});return t}function H(i,e){for(const t of i.matchAll(j)){const s=t[1],n=t[2];if(!s||!n)continue;const a=E(n);switch(s){case"LeP":e.lep=a;break;case"AsP":e.asp=a;break;case"KaP":e.kap=a;break;case"INI":e.ini=n;break;case"AW":e.aw=a;break;case"SK":e.sk=a;break;case"ZK":e.zk=a;break;case"GS":e.gs=a;break}}}function E(i){const e=i.replace(/[^0-9\-]/g,"");if(!e)return null;const t=Number.parseInt(e,10);return Number.isNaN(t)?null:t}function Ve(i){return/^[^:]+:\s+(AT|FK)\s+/i.test(i)}function De(i,e){const[t,s]=i.split(":");if(!s){e.push({type:"parse-error",section:"weapons",message:`Zeile "${i}" enthält keinen Doppelpunkt.`});return}const n=(t??"").trim(),a={};for(const d of s.matchAll(j)){const m=d[1],h=d[2];if(!m||!h)continue;const p=m.toUpperCase();a[p]=h}const r=a.AT?E(a.AT):null,o=a.PA?E(a.PA):null,l=a.FK?E(a.FK):null,c=Ue(n,r,l);return{name:n,category:c,attack:r,parry:o,rangedAttack:l,damage:a.TP??null,range:a.RW??null,load:a.LZ??null,reach:a.RE??null,notes:a.BEM??null,raw:a}}function Ue(i,e,t){return i.toLowerCase().includes("waffenlos")?"unarmed":t!==null?"ranged":e!==null?"melee":"unknown"}function qe(i){const e=[],t=[];let s=null,n=[];const a=()=>{s?e.push({heading:s,content:n.join(" ").trim()}):n.length>0&&t.push(n.join(" ").trim()),s=null,n=[]};for(const r of i){const o=r.trim();if(!o)continue;const l=o.match(Oe);if(l){a();const c=l[1]?.trim();s=c&&c.length>0?c:null;const d=l[2]?.trim();n=d?[d]:[];continue}s?n.push(o):t.push(o)}return a(),{sections:e,extras:t}}function Fe(i){const e=i.toLowerCase().replace(/\s+/g,"").replace(/[()]/g,"");return e.startsWith("schmerz")||e==="kampfverhaltenflucht"?"notes":Me[e]??null}function w(i,e){if(e)for(const t of P(e))i.push(t)}function Z(i,e){if(!(!e||e.toLowerCase()==="keine"))for(const t of P(e))i.push(t)}function P(i){const e=[];let t="",s=0;for(const n of i){if(n==="("?s+=1:n===")"&&(s=Math.max(s-1,0)),(n===","||n===";")&&s===0){t.trim()&&e.push(t.trim()),t="";continue}t+=n}return t.trim()&&e.push(t.trim()),e.map(n=>R(n))}function We(i,e){for(const t of P(e)){const s=He(t);for(const n of s){const a=Xe(n);a==="disadvantage"?i.disadvantages.push(n):a==="advantage"?i.advantages.push(n):(i.advantages.push(n),i.disadvantages.push(n))}}}function Xe(i){const e=i.toLowerCase();return["schlechte eigenschaft","verpflicht","feindschaft","hass","arm","krankheit","unfähig","vorurteil","schulden","angst","zauberanfällig"].some(n=>e.includes(n))?"disadvantage":["begabung","adelig","gutaussehend","vorteil","resistenz","richtungssinn","entfernungssinn"].some(n=>e.includes(n))?"advantage":"both"}function T(i){return i.map(e=>V(e)).map(e=>R(e)).map(e=>je(e)).map(e=>G(e)).map(e=>V(e)).map(e=>e.endsWith(".")?e.slice(0,-1):e).filter(e=>e.length>0).filter(e=>{const t=e.toLowerCase();return t!=="keine"&&t!=="keiner"&&t!=="keinen"&&t!=="entfällt"})}function V(i){return i.replace(/\s+/g," ").trim()}function R(i){return i.replace(/([A-Za-zÄÖÜäöüß])-\s+([A-Za-zÄÖÜäöüß])/g,"$1$2")}function je(i){let e=i.replace(/([IVX]+)\s*AKO\d+/gi,"$1").replace(/([IVX]+)AKO\d+/gi,"$1");return e=e.replace(/AKO[IVX\d]+/gi,""),e=e.replace(/\s{2,}/g," "),e.trim()}function G(i){let e=i;for(const[t,s]of Object.entries(Ce)){const n=new RegExp(`\\b${t}\\b`,"gi");e=e.replace(n,s)}return e}function He(i){const e=[];let t="",s=0;for(const n of i){if(n==="("?s+=1:n===")"&&(s=Math.max(s-1,0)),n==="/"&&s===0){t.trim()&&e.push(t.trim()),t="";continue}t+=n}return t.trim()&&e.push(t.trim()),e}function Ze(i,e){const t=i.toLowerCase(),s=e.toLowerCase(),n=t.indexOf(s);if(n===-1)return{primary:i};const a=i.slice(0,n).trim().replace(/[;,]+$/,""),r=i.slice(n+e.length).trim();return{primary:a.length>0?a:"",trailing:r.length>0?r:void 0}}function Ge(i,e){const t=[];for(const s of i){const a=s.trim().match(/^(.+?)\s+(-?\d+)$/);if(!a){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${s}"`});continue}const r=R(a[1]??""),o=a[2];if(!r||!o){e.push({type:"parse-error",section:"talents",message:`Talent konnte nicht interpretiert werden: "${s}"`});continue}const l=G(r.replace(/\*+$/,"").trim()),c=Number.parseInt(o,10);if(Number.isNaN(c)){e.push({type:"parse-error",section:"talents",message:`Talentwert ist keine Zahl: "${s}"`});continue}t.push({name:l,value:c})}return t}function D(i,e,t){const s=[];for(const n of T(i)){const a=n.match(/^(.+?)\s+(-?\d+|[IVX]+)$/i);if(!a){s.push({name:n,value:0}),t.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${n}"`});continue}const r=R(a[1]??""),o=a[2];if(!r||!o){t.push({type:"parse-error",section:e,message:`Wert für ${e} konnte nicht ermittelt werden: "${n}"`});continue}const l=r.trim(),c=o.trim();let d=Number.parseInt(c,10);if(Number.isNaN(d)&&(d=Be(c.toUpperCase())),!d||Number.isNaN(d)){t.push({type:"parse-error",section:e,message:`Numerischer Wert für ${e} ist ungültig: "${n}"`});continue}s.push({name:l,value:d})}return s}function Be(i){const e={I:1,V:5,X:10,L:50,C:100},t=i.toUpperCase().split("");let s=0,n=0;for(const a of t.reverse()){const r=e[a];if(!r)return null;r<n?s-=r:(s+=r,n=r)}return s}function Ye(){return{name:"Unbekannt",attributes:{},pools:{},armor:void 0,actions:null,weapons:[],advantages:[],disadvantages:[],specialAbilities:[],combatSpecialAbilities:[],languages:[],spells:[],liturgies:[],rituals:[],blessings:[],equipment:[],talents:[],notes:{},extras:[]}}let M,B;self.addEventListener("message",async i=>{const e=i.data;if(!(!e||e.type!=="convert"))try{const t=await Je(e.payload.baseUrl),s=Ke(e.payload.source),n=ge(s.model,t),r={type:"result",payload:{exported:ie({dataset:t,parsed:s,resolved:n}),manifest:t.manifest,normalizedSource:s.normalizedSource,parserWarnings:s.warnings,resolverWarnings:n.warnings,unresolved:n.unresolved}};postMessage(r)}catch(t){const s={type:"error",error:t instanceof Error?t.message:String(t)};postMessage(s)}});async function Je(i){const e=new URL("data/optolith/manifest.json",i).toString();if(M&&B===e)return M;const t=await fetch(e);if(!t.ok)throw new Error(`Manifest konnte nicht geladen werden (${t.status})`);const s=await t.json(),n=async r=>{const o=new URL(`data/optolith/${r}`,i).toString(),l=await fetch(o);if(!l.ok)throw new Error(`Datensatz ${r} konnte nicht geladen werden (${l.status})`);return l.json()},a={manifest:s,advantages:await n(k(s,"advantages")),disadvantages:await n(k(s,"disadvantages")),specialAbilities:await n(k(s,"specialAbilities")),skills:await n(k(s,"skills")),combatTechniques:await n(k(s,"combatTechniques")),spells:await n(k(s,"spells")),liturgies:await n(k(s,"liturgies")),blessings:await n(k(s,"blessings")),equipment:await n(k(s,"equipment"))};return M=Q(a),B=e,M}function k(i,e){const t=i.sections.find(s=>s.key===e);if(!t)throw new Error(`Manifestabschnitt fehlt: ${e}`);return t.file}})();
